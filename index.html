<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flower Market - –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</title>
    
    <!-- Leaflet –¥–ª—è –∫–∞—Ä—Ç -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* --- –í–∫–ª—é—á—ë–Ω –≤–µ—Å—å —Ç–≤–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π CSS (–Ω–µ –º–µ–Ω—è–ª —Å—Ç–∏–ª–∏) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding-top: env(safe-area-inset-top, 0);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .form-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        
        .form-step {
            display: none;
            animation-duration: 0.3s;
            animation-fill-mode: both;
        }
        
        .form-step.active {
            display: block;
            animation-name: fadeInUp;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .step-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-weight: 500;
            font-size: 15px;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #fff;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            min-height: 140px;
            resize: vertical;
            line-height: 1.5;
        }
        
        .input-hint {
            display: block;
            margin-top: 8px;
            color: #888;
            font-size: 13px;
        }
        
        .photo-upload {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
            user-select: none;
        }
        
        .photo-upload:hover, .photo-upload:active {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .photo-upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
            display: block;
        }
        
        #photoInput {
            display: none;
        }
        
        #photoPreview {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
        }
        
        .photo-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .photo-item:hover {
            transform: scale(1.05);
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-photo {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(255, 59, 48, 0.9);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.2s;
            border: 2px solid white;
        }
        
        .remove-photo:hover {
            background: rgba(255, 59, 48, 1);
        }
        
        .contact-options {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 600px) {
            .contact-options {
                grid-template-columns: 1fr;
            }
        }
        
        .contact-option {
            padding: 20px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff;
        }
        
        .contact-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .contact-option.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .contact-option i {
            font-size: 28px;
            margin-bottom: 12px;
            display: block;
        }
        
        .contact-option p {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .contact-option small {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .phone-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .country-select {
            flex: 0 0 150px;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            background: #fff;
        }
        
        .country-select:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .location-map {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #667eea;
            border: 2px solid #e0e0e0;
            cursor: pointer;
        }
        
        .location-map i {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        #mapPicker {
            height: 400px;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .address-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: calc(100% - 32px);
            margin-top: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .address-suggestion {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        .address-suggestion:hover {
            background: #f5f5f5;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn:hover:after, .btn:active:after {
            opacity: 1;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            background-image: none;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .navigation {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .navigation .btn {
            flex: 1;
        }
        
        .preview-item {
            background: rgba(102, 126, 234, 0.05);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .preview-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .preview-value {
            color: #333;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .photo-preview {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .photo-more {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .progress-bar:before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255,255,255,0.3);
            z-index: 1;
        }
        
        .progress-step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }
        
        .step-number {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            color: white;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .step-number.active {
            background: white;
            color: #667eea;
            box-shadow: 0 0 0 4px rgba(255,255,255,0.3);
        }
        
        .step-label {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            transition: color 0.3s;
        }
        
        .step-label.active {
            color: white;
            font-weight: 500;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform 0.4s ease;
            max-width: 90%;
            width: 400px;
        }
        
        .notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .notification-icon {
            font-size: 22px;
            color: #ff3b30;
        }
        
        .notification.success .notification-icon {
            color: #34c759;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }
        
        .notification-message {
            color: #666;
            font-size: 14px;
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }
            
            .form-container {
                padding: 20px;
                border-radius: 16px;
            }
            
            .step-title {
                font-size: 18px;
            }
            
            .photo-item {
                width: 80px;
                height: 80px;
            }
            
            .btn {
                padding: 14px 20px;
                font-size: 15px;
            }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ */
        .browser-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
            animation: fadeIn 0.5s ease;
        }
        
        .browser-info h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .telegram-link {
            display: inline-block;
            background: #0088cc;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            text-decoration: none;
            margin-top: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .telegram-link:hover {
            background: #0077b5;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 136, 204, 0.3);
        }
        
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É */
        .consent-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border: 2px solid #e9ecef;
        }
        
        .consent-title {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .consent-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .consent-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            accent-color: #667eea;
        }
        
        .consent-text {
            font-size: 14px;
            color: #555;
            line-height: 1.5;
        }
        
        .consent-text a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .consent-text a:hover {
            text-decoration: underline;
        }
        
        .telegram-connect {
            background: linear-gradient(135deg, #0088cc 0%, #006699 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .telegram-connect i {
            font-size: 24px;
        }
        
        .telegram-connect-content {
            flex: 1;
        }
        
        .telegram-connect-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .telegram-connect-description {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .telegram-connect-btn {
            background: white;
            color: #0088cc;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .telegram-connect-btn:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
        }
        
        .contact-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —Å–æ–≥–ª–∞—Å–∏–µ–º */
        .consent-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .consent-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: modalAppear 0.5s ease;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .consent-modal-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .consent-modal-header i {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .consent-modal-header h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .consent-modal-header p {
            color: #666;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .consent-modal-body {
            margin-bottom: 25px;
        }
        
        .consent-reason {
            background: rgba(102, 126, 234, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .consent-reason h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .consent-reason p {
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .consent-modal-footer {
            display: flex;
            gap: 15px;
        }
        
        .consent-modal-footer .btn {
            flex: 1;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
        }
        
        .btn-outline:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ */
        .import-contacts-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
        }
        
        .import-contacts-btn {
            background: white;
            color: #f5576c;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            transition: all 0.3s;
        }
        
        .import-contacts-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .contacts-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
        }
        
        .contact-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .contact-item:last-child {
            border-bottom: none;
        }
        
        .contact-info {
            flex: 1;
            text-align: left;
        }
        
        .contact-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .contact-phone {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .use-contact-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .use-contact-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º -->
    <div class="consent-modal" id="consentModal">
        <div class="consent-modal-content">
            <div class="consent-modal-header">
                <i class="fas fa-address-book"></i>
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Flower Market!</h2>
                <p>–î–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞–º –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</p>
            </div>
            
            <div class="consent-modal-body">
                <div class="consent-reason">
                    <h3><i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º</h3>
                    <p>–ú—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏–º –≤–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</p>
                </div>
                
                <div class="consent-reason">
                    <h3><i class="fas fa-users"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</h3>
                    <p>–í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è –±—É–¥—É—â–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                </div>
                
                <div class="consent-reason">
                    <h3><i class="fas fa-shield-alt"></i> –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö</h3>
                    <p>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞</p>
                </div>
            </div>
            
            <div class="consent-modal-footer">
                <button class="btn btn-outline" id="skipConsentBtn">
                    <i class="fas fa-times"></i> –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
                </button>
                <button class="btn" id="grantConsentBtn">
                    <i class="fas fa-check"></i> –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="progress-bar" id="progressBar">
            <div class="progress-step">
                <div class="step-number active">1</div>
                <div class="step-label active">–§–æ—Ç–æ</div>
            </div>
            <div class="progress-step">
                <div class="step-number">2</div>
                <div class="step-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
            </div>
            <div class="progress-step">
                <div class="step-number">3</div>
                <div class="step-label">–¶–µ–Ω–∞</div>
            </div>
            <div class="progress-step">
                <div class="step-number">4</div>
                <div class="step-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
            </div>
            <div class="progress-step">
                <div class="step-number">5</div>
                <div class="step-label">–õ–æ–∫–∞—Ü–∏—è</div>
            </div>
            <div class="progress-step">
                <div class="step-number">6</div>
                <div class="step-label">–ü—Ä–µ–≤—å—é</div>
            </div>
        </div>
        
        <div class="header">
            <h1><i class="fas fa-flower-tulip"></i> Flower Market –∏–º—Ç—å–∞–≤–∞–∞—Ä—å–∞–ø—Ç–≤</h1>
            <p>–°–æ–∑–¥–∞–π—Ç–µ –∫—Ä–∞—Å–∏–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–∞–∂–µ —Ü–≤–µ—Ç–æ–≤</p>
        </div>
    </div>

    <div class="notification" id="notification" style="transform: translateX(-50%) translateY(-100px);">
        <i class="fas fa-exclamation-circle notification-icon" id="notificationIcon"></i>
        <div class="notification-content">
            <div class="notification-title" id="notificationTitle">–û—à–∏–±–∫–∞</div>
            <div class="notification-message" id="notificationMessage"></div>
        </div>
    </div>

    <div class="container">
        <div class="form-container">
            <!-- –®–∞–≥ 1: –§–æ—Ç–æ -->
            <div class="form-step active" id="step1">
                <h2 class="step-title"><i class="fas fa-camera"></i> –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</h2>
                <div class="form-group">
                    <div class="photo-upload" id="photoUpload" role="button">
                        <i class="fas fa-cloud-upload-alt photo-upload-icon" id="uploadIcon"></i>
                        <p id="uploadMainText">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</p>
                        <p class="input-hint" id="uploadHint">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ 10 —Ñ–æ—Ç–æ (–º–∞–∫—Å–∏–º—É–º 5MB –∫–∞–∂–¥–æ–µ)</p>
                    </div> 
                    <input type="file" id="photoInput" accept="image/*" multiple>
                    <div id="photoPreview"></div>
                </div>
                <div class="navigation">
                    <button class="btn" id="nextStep1">
                        <i class="fas fa-arrow-right"></i> –î–∞–ª–µ–µ
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 2: –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="form-step" id="step2">
                <h2 class="step-title"><i class="fas fa-edit"></i> –û–ø–∏—Å–∞–Ω–∏–µ</h2>
                <div class="form-group">
                    <label for="flowerType">–¢–∏–ø —Ü–≤–µ—Ç–æ–≤</label>
                    <input type="text" id="flowerType" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ä–æ–∑—ã, —Ç—é–ª—å–ø–∞–Ω—ã, –±—É–∫–µ—Ç –Ω–µ–≤–µ—Å—Ç—ã">
                    <p class="input-hint">–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–∏–¥ —Ü–≤–µ—Ç–æ–≤ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—É–∫–µ—Ç–∞</p>
                </div>
                <div class="form-group">
                    <label for="description">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="description" placeholder="–û–ø–∏—à–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤, —Ä–∞–∑–º–µ—Ä –±—É–∫–µ—Ç–∞, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã..."></textarea>
                    <p class="input-hint">–ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, —Ç–µ–º –±–æ–ª—å—à–µ –æ—Ç–∫–ª–∏–∫–æ–≤</p>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" id="prevStep2">
                        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                    </button>
                    <button class="btn" id="nextStep2">
                        <i class="fas fa-arrow-right"></i> –î–∞–ª–µ–µ
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 3: –¶–µ–Ω–∞ -->
            <div class="form-step" id="step3">
                <h2 class="step-title"><i class="fas fa-tag"></i> –¶–µ–Ω–∞</h2>
                <div class="form-group">
                    <label for="price">–¶–µ–Ω–∞ (‚ÇΩ)</label>
                    <input type="number" id="price" placeholder="1000" min="0">
                    <p class="input-hint">–£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ —Ä—É–±–ª—è—Ö</p>
                </div>
                <div class="form-group">
                    <label for="priceType">–¢–∏–ø —Ü–µ–Ω—ã</label>
                    <select id="priceType">
                        <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞</option>
                        <option value="negotiable">–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è</option>
                        <option value="auction">–ê—É–∫—Ü–∏–æ–Ω (–Ω–∞—á–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞)</option>
                    </select>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" id="prevStep3">
                        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                    </button>
                    <button class="btn" id="nextStep3">
                        <i class="fas fa-arrow-right"></i> –î–∞–ª–µ–µ
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 4: –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
            <div class="form-step" id="step4">
                <h2 class="step-title"><i class="fas fa-address-book"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
                <p style="text-align: center; margin-bottom: 20px; color: #666; font-size: 14px;">
                    –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ —Å –≤–∞–º–∏
                </p>
                
                <div class="contact-options">
                    <div class="contact-option" data-type="phone">
                        <i class="fas fa-phone"></i>
                        <p>–¢–µ–ª–µ—Ñ–æ–Ω</p>
                        <small>–ó–≤–æ–Ω–∫–∏ –∏ SMS</small>
                    </div>
                    <div class="contact-option" data-type="telegram">
                        <i class="fab fa-telegram"></i>
                        <p>Telegram</p>
                        <small>–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</small>
                    </div>
                    <div class="contact-option" data-type="whatsapp">
                        <i class="fab fa-whatsapp"></i>
                        <p>WhatsApp</p>
                        <small>–ë—ã—Å—Ç—Ä–∞—è —Å–≤—è–∑—å</small>
                    </div>
                </div>
                
                <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
                <div class="import-contacts-section" id="importContactsSection" style="display: none;">
                    <h3><i class="fas fa-magic"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã</h3>
                    <p>–ú—ã –º–æ–∂–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</p>
                    <button class="import-contacts-btn" id="importContactsBtn">
                        <i class="fas fa-download"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã
                    </button>
                    <div class="contacts-list" id="contactsList" style="display: none;"></div>
                </div>
                
                <div id="contactInputs" style="display: none;">
                    <div class="form-group" id="phoneInput">
                        <label for="phoneNumber">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                        <div class="phone-input-wrapper">
                            <select id="countryCode" class="country-select">
                                <option value="+7">üá∑üá∫ +7 (–†–æ—Å—Å–∏—è)</option>
                                <option value="+375">üáßüáæ +375 (–ë–µ–ª–∞—Ä—É—Å—å)</option>
                                <option value="+7">üá∞üáø +7 (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω)</option>
                                <option value="+380">üá∫üá¶ +380 (–£–∫—Ä–∞–∏–Ω–∞)</option>
                            </select>
                            <input type="tel" id="phoneNumber" placeholder="999 123-45-67">
                        </div>
                    </div>
                    
                    <div class="form-group" id="telegramInput" style="display: none;">
                        <label for="telegramUsername">Telegram username</label>
                        <div class="input-wrapper">
                            <input type="text" id="telegramUsername" placeholder="@username">
                        </div>
                        <p class="input-hint">–£–∫–∞–∂–∏—Ç–µ –≤–∞—à Telegram username (–Ω–∞–ø—Ä–∏–º–µ—Ä, @ivanov)</p>
                    </div>

                    <div class="form-group" id="whatsappInput" style="display: none;">
                        <label for="whatsappNumber">WhatsApp –Ω–æ–º–µ—Ä</label>
                        <div class="phone-input-wrapper">
                            <select id="whatsappCountryCode" class="country-select">
                                <option value="+7">üá∑üá∫ +7 (–†–æ—Å—Å–∏—è)</option>
                                <option value="+375">üáßüáæ +375 (–ë–µ–ª–∞—Ä—É—Å—å)</option>
                                <option value="+7">üá∞üáø +7 (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω)</option>
                                <option value="+380">üá∫üá¶ +380 (–£–∫—Ä–∞–∏–Ω–∞)</option>
                            </select>
                            <input type="tel" id="whatsappNumber" placeholder="999 123-45-67">
                        </div>
                    </div>
                </div>

                <!-- –°–µ–∫—Ü–∏—è —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É -->
                <div class="consent-section" id="consentSection">
                    <div class="consent-title">
                        <i class="fas fa-bell"></i> –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    </div>
                    
                    <div class="consent-checkbox">
                        <input type="checkbox" id="newsletterConsent">
                        <div class="consent-text">
                            <label for="newsletterConsent">
                                –Ø —Ö–æ—á—É –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è—Ö —Ü–≤–µ—Ç–æ–≤, —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö –∏ –∞–∫—Ü–∏—è—Ö –æ—Ç Flower Market.
                                <span class="contact-badge">
                                    <i class="fas fa-user-check"></i> –ê–≤—Ç–æ–ø–æ–¥–ø–∏—Å–∫–∞
                                </span>
                            </label>
                            <p style="margin-top: 8px; font-size: 12px; color: #888;">
                                –í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö —Ü–≤–µ—Ç–∞—Ö –∏ –∞–∫—Ü–∏—è—Ö.
                            </p>
                        </div>
                    </div>
                    
                    <div class="telegram-connect" id="telegramConnect" style="display: none;">
                        <i class="fab fa-telegram"></i>
                        <div class="telegram-connect-content">
                            <div class="telegram-connect-title">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Telegram –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                            <div class="telegram-connect-description">
                                –ü–æ–ª—É—á–∞–π—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª—è—Ö –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö
                            </div>
                        </div>
                        <button class="telegram-connect-btn" id="connectTelegramBtn">
                            –ü–æ–¥–∫–ª—é—á–∏—Ç—å
                        </button>
                    </div>
                </div>
                
                <div class="navigation">
                    <button class="btn btn-secondary" id="prevStep4">
                        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                    </button>
                    <button class="btn" id="nextStep4">
                        <i class="fas fa-arrow-right"></i> –î–∞–ª–µ–µ
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 5: –õ–æ–∫–∞—Ü–∏—è -->
            <div class="form-step" id="step5">
                <h2 class="step-title"><i class="fas fa-map-marker-alt"></i> –õ–æ–∫–∞—Ü–∏—è</h2>
                <div class="form-group">
                    <label for="location">–ì–æ—Ä–æ–¥ / –†–∞–π–æ–Ω</label>
                    <input type="text" id="location" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥ –∏–ª–∏ —Ä–∞–π–æ–Ω">
                    <div id="addressSuggestions" class="address-suggestions"></div>
                </div>
                <div class="form-group">
                    <label>–£—Ç–æ—á–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ</label>
                    <div class="location-map" id="openMapPicker">
                        <i class="fas fa-map"></i>
                        <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</p>
                        <p class="input-hint">–í—ã–±—Ä–∞–Ω–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è: <span id="selectedLocationText">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span></p>
                    </div>
                    <input type="hidden" id="latitude">
                    <input type="hidden" id="longitude">
                </div>
                <div id="mapPicker" style="display: none;"></div>
                <div class="navigation">
                    <button class="btn btn-secondary" id="prevStep5">
                        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                    </button>
                    <button class="btn" id="nextStep5">
                        <i class="fas fa-arrow-right"></i> –î–∞–ª–µ–µ
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 6: –ü—Ä–µ–≤—å—é -->
            <div class="form-step" id="step6">
                <h2 class="step-title"><i class="fas fa-eye"></i> –ü—Ä–µ–≤—å—é –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
                
                <div class="preview-item">
                    <div class="preview-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</div>
                    <div class="photos-grid" id="previewPhotos"></div>
                </div>
                
                <div class="preview-item">
                    <div class="preview-label">–¢–∏–ø —Ü–≤–µ—Ç–æ–≤</div>
                    <div class="preview-value" id="previewFlowerType"></div>
                </div>
                
                <div class="preview-item">
                    <div class="preview-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                    <div class="preview-value" id="previewDescription"></div>
                </div>
                
                <div class="preview-item">
                    <div class="preview-label">–¶–µ–Ω–∞</div>
                    <div class="preview-value" id="previewPrice"></div>
                </div>
                
                <div class="preview-item">
                    <div class="preview-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
                    <div class="preview-value" id="previewContacts"></div>
                    <div class="preview-value" id="previewConsent" style="font-size: 14px; color: #667eea; margin-top: 5px;"></div>
                </div>
                
                <div class="preview-item">
                    <div class="preview-label">–õ–æ–∫–∞—Ü–∏—è</div>
                    <div class="preview-value" id="previewLocation"></div>
                </div>
                
                <div class="navigation">
                    <button class="btn btn-secondary" id="prevStep6">
                        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                    </button>
                    <button class="btn" id="publishBtn">
                        <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
                    </button>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ -->
        <div class="browser-info" id="browserInfo" style="display: none;">
            <h3><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ</h3>
            <p id="subscriptionInfo"></p>
            <div id="telegramChannelInfo" style="margin-top: 15px;"></div>
            <button class="btn btn-secondary" id="exportContactsBtn" style="margin-top: 15px; display: none;">
                <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (–∞–¥–º–∏–Ω)
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ / state
        let currentStep = 1;
        const totalSteps = 6;
        let photos = [];
        let selectedContactMethod = null;
        let newsletterConsent = false;
        let collectedContacts = JSON.parse(localStorage.getItem('flowerMarketContacts') || '[]');
        let map = null;
        let marker = null;
        let formData = {
            photos: [],
            flowerType: '',
            description: '',
            price: '',
            priceType: 'fixed',
            contactMethod: '',
            contactValue: '',
            location: '',
            latitude: '',
            longitude: '',
            newsletterConsent: false,
            userInfo: {}
        };

        // --- –£–¥–∞–ª–∏–ª–∏ BOT_TOKEN/ADMIN_ID –∏–∑ –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ)
        // const BOT_TOKEN = "..."; // –£–ë–†–ê–ù–û

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: –∞–¥—Ä–µ—Å fallback (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        const FORMSUBMIT_EMAIL = 'bayastan01@gmail.com';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º
        const isFirstVisit = !localStorage.getItem('hasVisitedBefore');

        // --- DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ, –µ—Å–ª–∏ –µ—Å—Ç—å (—Å–æ—Ö—Ä–∞–Ω—è–µ–º telegramUserInfo)
            const savedUserInfo = localStorage.getItem('telegramUserInfo');
            if (savedUserInfo) {
                formData.userInfo = JSON.parse(savedUserInfo);
            }

            if (isFirstVisit) {
                showConsentModal();
                localStorage.setItem('hasVisitedBefore', 'true');
            } else {
                document.getElementById('consentModal').style.display = 'none';
            }

            initPhotoUpload();
            initNavigation();
            initContactOptions();
            initConsentSection();
            initMap();
            initConsentModal();
            initUserInfoForm();

            if (collectedContacts.length > 0 && localStorage.getItem('isAdmin') === 'true') {
                document.getElementById('exportContactsBtn').style.display = 'block';
            }
            document.getElementById('exportContactsBtn').addEventListener('click', exportContacts);
        });

        // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º
        function initUserInfoForm() {
            const savedUserData = localStorage.getItem('userFormData');
            if (savedUserData) {
                const userData = JSON.parse(savedUserData);
                document.getElementById('telegramUsername').value = userData.telegram || '';
                document.getElementById('phoneNumber').value = userData.phone || '';
            }
        }

        function showConsentModal() {
            const modal = document.getElementById('consentModal');
            modal.style.display = 'flex';
        }

        function initConsentModal() {
            const skipBtn = document.getElementById('skipConsentBtn');
            const grantBtn = document.getElementById('grantConsentBtn');
            
            skipBtn.addEventListener('click', function() {
                document.getElementById('consentModal').style.display = 'none';
                localStorage.setItem('contactConsent', 'false');
                showNotification('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–í—ã –º–æ–∂–µ—Ç–µ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º –ø–æ–∑–∂–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö');
            });
            
            grantBtn.addEventListener('click', function() {
                document.getElementById('consentModal').style.display = 'none';
                localStorage.setItem('contactConsent', 'true');
                
                document.getElementById('importContactsSection').style.display = 'block';
                
                showNotification('–£—Å–ø–µ—à–Ω–æ', '–î–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º —Ä–∞–∑—Ä–µ—à–µ–Ω!', 'success');
                
                setTimeout(() => {
                    if (currentStep === 4) {
                        importContacts();
                    }
                }, 1000);
            });
        }

        // === Photo upload
        function initPhotoUpload() {
            const photoUpload = document.getElementById('photoUpload');
            const photoInput = document.getElementById('photoInput');

            photoUpload.addEventListener('click', () => {
                photoInput.click();
            });

            photoInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (photos.length + files.length > 10) {
                    showNotification('–û—à–∏–±–∫–∞', '–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ 10 —Ñ–æ—Ç–æ');
                    return;
                }
                files.forEach(file => {
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('–û—à–∏–±–∫–∞', `–§–∞–π–ª ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB`);
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const photoData = {
                            id: Date.now() + Math.random(),
                            url: ev.target.result,
                            file: file
                        };
                        photos.push(photoData);
                        updatePhotoPreview();
                        formData.photos = photos.map(p => p.url);
                    };
                    reader.readAsDataURL(file);
                });
                photoInput.value = '';
            });
        }

        function updatePhotoPreview() {
            const photoPreview = document.getElementById('photoPreview');
            const uploadMainText = document.getElementById('uploadMainText');
            const uploadHint = document.getElementById('uploadHint');
            const uploadIcon = document.getElementById('uploadIcon');

            if (photos.length === 0) {
                uploadMainText.textContent = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ';
                uploadHint.textContent = '–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ 10 —Ñ–æ—Ç–æ (–º–∞–∫—Å–∏–º—É–º 5MB –∫–∞–∂–¥–æ–µ)';
                uploadIcon.className = 'fas fa-cloud-upload-alt photo-upload-icon';
                uploadIcon.style.color = '#667eea';
            } else {
                uploadMainText.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${photos.length} —Ñ–æ—Ç–æ`;
                uploadHint.textContent = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –µ—â—ë —Ñ–æ—Ç–æ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞';
                uploadIcon.className = 'fas fa-check-circle photo-upload-icon';
                uploadIcon.style.color = '#34c759';
            }

            photoPreview.innerHTML = '';
            photos.forEach(photo => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `
                    <img src="${photo.url}" alt="–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ">
                    <div class="remove-photo" data-id="${photo.id}">√ó</div>
                `;
                photoPreview.appendChild(photoItem);
            });

            document.querySelectorAll('.remove-photo').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    photos = photos.filter(photo => photo.id != id);
                    updatePhotoPreview();
                    formData.photos = photos.map(p=>p.url);
                });
            });
        }

        // === Navigation
        function initNavigation() {
            document.getElementById('nextStep1').addEventListener('click', () => goToStep(2));
            document.getElementById('nextStep2').addEventListener('click', () => goToStep(3));
            document.getElementById('nextStep3').addEventListener('click', () => goToStep(4));
            document.getElementById('nextStep4').addEventListener('click', () => goToStep(5));
            document.getElementById('nextStep5').addEventListener('click', () => goToStep(6));
            
            document.getElementById('prevStep2').addEventListener('click', () => goToStep(1));
            document.getElementById('prevStep3').addEventListener('click', () => goToStep(2));
            document.getElementById('prevStep4').addEventListener('click', () => goToStep(3));
            document.getElementById('prevStep5').addEventListener('click', () => goToStep(4));
            document.getElementById('prevStep6').addEventListener('click', () => goToStep(5));

            document.getElementById('publishBtn').addEventListener('click', publishAd);
            
            document.getElementById('flowerType').addEventListener('input', (e) => { formData.flowerType = e.target.value; });
            document.getElementById('description').addEventListener('input', (e) => { formData.description = e.target.value; });
            document.getElementById('price').addEventListener('input', (e) => { formData.price = e.target.value; });
            document.getElementById('priceType').addEventListener('change', (e) => { formData.priceType = e.target.value; });
            document.getElementById('location').addEventListener('input', (e) => { formData.location = e.target.value; });
        }

        function goToStep(step) {
            if (step > currentStep) {
                if (!validateStep(currentStep)) return;
            }
            saveCurrentStepData();
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.querySelectorAll('.progress-step')[currentStep - 1].querySelector('.step-number').classList.remove('active');
            document.querySelectorAll('.progress-step')[currentStep - 1].querySelector('.step-label').classList.remove('active');
            document.getElementById(`step${step}`).classList.add('active');
            document.querySelectorAll('.progress-step')[step - 1].querySelector('.step-number').classList.add('active');
            document.querySelectorAll('.progress-step')[step - 1].querySelector('.step-label').classList.add('active');
            currentStep = step;
            if (step === 4 && localStorage.getItem('contactConsent') === 'true') {
                document.getElementById('importContactsSection').style.display = 'block';
            }
            if (step === 6) updatePreview();
        }

        function validateStep(step) {
            switch(step) {
                case 1:
                    if (photos.length === 0) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ'); return false; }
                    break;
                case 2:
                    if (!formData.flowerType.trim()) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–∏–ø —Ü–≤–µ—Ç–æ–≤'); return false; }
                    if (!formData.description.trim()) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ'); return false; }
                    break;
                case 3:
                    if ((formData.price === '' || formData.price === null || isNaN(Number(formData.price))) && formData.priceType !== 'negotiable') {
                        showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ "–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è"'); return false;
                    }
                    break;
                case 4:
                    if (!selectedContactMethod) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏'); return false; }
                    let contactValue = '';
                    if (selectedContactMethod === 'phone') {
                        const phoneNumber = document.getElementById('phoneNumber').value;
                        const countryCode = document.getElementById('countryCode').value;
                        if (!phoneNumber.trim()) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞'); return false; }
                        contactValue = countryCode + phoneNumber.replace(/\D/g, '');
                    } else if (selectedContactMethod === 'telegram') {
                        contactValue = document.getElementById('telegramUsername').value;
                        if (!contactValue.trim() || !contactValue.startsWith('@')) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram username (–Ω–∞–ø—Ä–∏–º–µ—Ä, @username)'); return false; }
                    } else if (selectedContactMethod === 'whatsapp') {
                        const whatsappNumber = document.getElementById('whatsappNumber').value;
                        const countryCode = document.getElementById('whatsappCountryCode').value;
                        if (!whatsappNumber.trim()) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä WhatsApp'); return false; }
                        contactValue = countryCode + whatsappNumber.replace(/\D/g, '');
                    }
                    formData.contactMethod = selectedContactMethod;
                    formData.contactValue = contactValue;
                    formData.newsletterConsent = newsletterConsent;
                    localStorage.setItem('userFormData', JSON.stringify({
                        telegram: selectedContactMethod === 'telegram' ? contactValue : '',
                        phone: (selectedContactMethod === 'phone' || selectedContactMethod === 'whatsapp') ? contactValue : ''
                    }));
                    break;
                case 5:
                    if (!formData.location.trim()) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é'); return false; }
                    break;
            }
            return true;
        }

        function saveCurrentStepData() {
            if (currentStep === 4 && selectedContactMethod) {
                let contactValue = '';
                if (selectedContactMethod === 'phone') {
                    const phoneNumber = document.getElementById('phoneNumber').value;
                    const countryCode = document.getElementById('countryCode').value;
                    contactValue = countryCode + phoneNumber.replace(/\D/g, '');
                } else if (selectedContactMethod === 'telegram') {
                    contactValue = document.getElementById('telegramUsername').value;
                } else if (selectedContactMethod === 'whatsapp') {
                    const whatsappNumber = document.getElementById('whatsappNumber').value;
                    const countryCode = document.getElementById('whatsappCountryCode').value;
                    contactValue = countryCode + whatsappNumber.replace(/\D/g, '');
                }
                formData.contactMethod = selectedContactMethod;
                formData.contactValue = contactValue;
                formData.newsletterConsent = newsletterConsent;
            }
        }

        // === –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –æ–ø—Ü–∏–∏
        function initContactOptions() {
            document.querySelectorAll('.contact-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.contact-option').forEach(opt => { opt.classList.remove('active'); });
                    this.classList.add('active');
                    selectedContactMethod = this.dataset.type;
                    const contactInputs = document.getElementById('contactInputs');
                    contactInputs.style.display = 'block';
                    document.getElementById('phoneInput').style.display = 'none';
                    document.getElementById('telegramInput').style.display = 'none';
                    document.getElementById('whatsappInput').style.display = 'none';
                    if (selectedContactMethod === 'phone') {
                        document.getElementById('phoneInput').style.display = 'block';
                        document.getElementById('telegramConnect').style.display = 'none';
                    } else if (selectedContactMethod === 'telegram') {
                        document.getElementById('telegramInput').style.display = 'block';
                        document.getElementById('telegramConnect').style.display = 'flex';
                    } else if (selectedContactMethod === 'whatsapp') {
                        document.getElementById('whatsappInput').style.display = 'block';
                        document.getElementById('telegramConnect').style.display = 'none';
                    }
                    if (localStorage.getItem('contactConsent') === 'true') {
                        document.getElementById('importContactsSection').style.display = 'block';
                    }
                });
            });
            document.getElementById('importContactsBtn').addEventListener('click', importContacts);
        }

        // === Consent section
        function initConsentSection() {
            const consentCheckbox = document.getElementById('newsletterConsent');
            consentCheckbox.addEventListener('change', function() { newsletterConsent = this.checked; });
            document.getElementById('connectTelegramBtn').addEventListener('click', function() {
                const telegramUsername = document.getElementById('telegramUsername').value;
                if (telegramUsername) {
                    const telegramLink = addToTelegramChannel(telegramUsername);
                    showNotification('Telegram –ø–æ–¥–∫–ª—é—á–µ–Ω', '–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram', 'success');
                    document.getElementById('telegramConnect').innerHTML = `
                        <i class="fab fa-telegram"></i>
                        <div class="telegram-connect-content">
                            <div class="telegram-connect-title">Telegram —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!</div>
                            <div class="telegram-connect-description">
                                –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É –∫–∞–Ω–∞–ª—É: 
                                <a href="${telegramLink}" target="_blank" style="color: white; text-decoration: underline;">
                                    Flower Market Channel
                                </a>
                            </div>
                        </div>
                    `;
                } else {
                    showNotification('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram username');
                }
            });
        }

        // === Contacts API import (fallback aware)
        function importContacts() {
            if (!('contacts' in navigator)) {
                showNotification('–û—à–∏–±–∫–∞', '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤');
                // fallback: show fake contacts
                showContactsFallback();
                return;
            }
            const props = ['name', 'tel', 'email'];
            const opts = {multiple: true};
            navigator.contacts.select(props, opts)
                .then(contacts => {
                    if (contacts && contacts.length > 0) {
                        displayContacts(contacts);
                        showNotification('–£—Å–ø–µ—à–Ω–æ', `–ù–∞–π–¥–µ–Ω–æ ${contacts.length} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤`, 'success');
                    } else {
                        showNotification('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω');
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', err);
                    showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º');
                    showContactsFallback();
                });
        }

        function showContactsFallback() {
            const fakeContacts = [
                { name: ['–ê–Ω–Ω–∞'], tel: ['+7 (999) 111-22-33'] },
                { name: ['–ò–≤–∞–Ω'], tel: ['+7 (701) 222-33-44'] },
                { name: ['–ú–∞—Ä–∏—è'], tel: ['+380 (67) 333-44-55'] }
            ];
            displayContacts(fakeContacts);
        }

        function displayContacts(contacts) {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';
            contactsList.style.display = 'block';
            contacts.forEach((contact) => {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                const contactInfo = document.createElement('div');
                contactInfo.className = 'contact-info';
                const contactName = document.createElement('div');
                contactName.className = 'contact-name';
                contactName.textContent = contact.name ? contact.name[0] : '–ë–µ–∑ –∏–º–µ–Ω–∏';
                const contactPhone = document.createElement('div');
                contactPhone.className = 'contact-phone';
                contactPhone.textContent = contact.tel ? contact.tel[0] : '–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
                contactInfo.appendChild(contactName);
                contactInfo.appendChild(contactPhone);
                const useBtn = document.createElement('button');
                useBtn.className = 'use-contact-btn';
                useBtn.innerHTML = '<i class="fas fa-check"></i>';
                useBtn.title = '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∫–æ–Ω—Ç–∞–∫—Ç';
                useBtn.addEventListener('click', () => {
                    if (contact.tel && contact.tel[0]) {
                        const phoneNumberRaw = contact.tel[0].replace(/\D/g, '');
                        let countryCode = '+7';
                        if (phoneNumberRaw.startsWith('375')) countryCode = '+375';
                        else if (phoneNumberRaw.startsWith('380')) countryCode = '+380';
                        else if (phoneNumberRaw.startsWith('77') || phoneNumberRaw.startsWith('7')) countryCode = '+7';
                        const localNumber = phoneNumberRaw.replace(/^(\+?\d{1,3})/, '');
                        document.querySelectorAll('.contact-option').forEach(opt => opt.classList.remove('active'));
                        document.querySelector('.contact-option[data-type="phone"]').classList.add('active');
                        selectedContactMethod = 'phone';
                        document.getElementById('contactInputs').style.display = 'block';
                        document.getElementById('phoneInput').style.display = 'block';
                        document.getElementById('telegramInput').style.display = 'none';
                        document.getElementById('whatsappInput').style.display = 'none';
                        document.getElementById('countryCode').value = countryCode;
                        document.getElementById('phoneNumber').value = localNumber;
                        showNotification('–£—Å–ø–µ—à–Ω–æ', '–ö–æ–Ω—Ç–∞–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω', 'success');
                    }
                });
                contactItem.appendChild(contactInfo);
                contactItem.appendChild(useBtn);
                contactsList.appendChild(contactItem);
            });
        }

        function saveContact(contactInfo) {
            if (!newsletterConsent) return;
            const contact = {
                ...contactInfo,
                date: new Date().toISOString(),
                consentGiven: true,
                source: 'flower_market_ad'
            };
            const existingContactIndex = collectedContacts.findIndex(c => 
                (c.phone && contactInfo.phone && c.phone === contactInfo.phone) || 
                (c.telegram && contactInfo.telegram && c.telegram === contactInfo.telegram)
            );
            if (existingContactIndex === -1) {
                collectedContacts.push(contact);
                localStorage.setItem('flowerMarketContacts', JSON.stringify(collectedContacts));
                if (contactInfo.telegram) addToTelegramChannel(contactInfo.telegram);
            } else {
                collectedContacts[existingContactIndex] = contact;
                localStorage.setItem('flowerMarketContacts', JSON.stringify(collectedContacts));
            }
        }

        function addToTelegramChannel(telegramUsername) {
            const telegramLink = `https://t.me/flower_market_channel?start=${encodeURIComponent(telegramUsername)}`;
            localStorage.setItem('telegramConnected', 'true');
            localStorage.setItem('telegramUsername', telegramUsername);
            return telegramLink;
        }

        function showNotification(title, message, type = 'error') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            const notificationIcon = document.getElementById('notificationIcon');
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            if (type === 'success') {
                notification.classList.add('success');
                notificationIcon.className = 'fas fa-check-circle notification-icon';
            } else {
                notification.classList.remove('success');
                notificationIcon.className = 'fas fa-exclamation-circle notification-icon';
            }
            notification.style.transform = 'translateX(-50%) translateY(0)';
            notification.classList.add('show');
            setTimeout(() => {
                notification.style.transform = 'translateX(-50%) translateY(-100px)';
                notification.classList.remove('show');
            }, 5000);
        }

        // === Map initialization
        function initMap() {
            const openMapPicker = document.getElementById('openMapPicker');
            const mapPicker = document.getElementById('mapPicker');
            openMapPicker.addEventListener('click', () => {
                mapPicker.style.display = 'block';
                openMapPicker.style.display = 'none';
                if (!map) {
                    map = L.map('mapPicker').setView([55.7558, 37.6173], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(map);
                    map.on('click', (e) => {
                        const { lat, lng } = e.latlng;
                        formData.latitude = lat;
                        formData.longitude = lng;
                        if (marker) map.removeLayer(marker);
                        marker = L.marker([lat, lng]).addTo(map);
                        updateLocationText(lat, lng);
                    });
                }
            });
        }

        function updateLocationText(lat, lng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data.display_name) {
                        const locationText = data.display_name.split(',').slice(0, 3).join(',');
                        document.getElementById('selectedLocationText').textContent = locationText;
                        document.getElementById('location').value = locationText;
                        formData.location = locationText;
                    }
                })
                .catch(() => {
                    const locationText = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    document.getElementById('selectedLocationText').textContent = locationText;
                    document.getElementById('location').value = locationText;
                    formData.location = locationText;
                });
        }

        function updatePreview() {
            const previewPhotos = document.getElementById('previewPhotos');
            previewPhotos.innerHTML = '';
            photos.slice(0, 6).forEach((photo) => {
                const img = document.createElement('img');
                img.src = photo.url;
                img.className = 'photo-preview';
                previewPhotos.appendChild(img);
            });
            if (photos.length > 6) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'photo-preview photo-more';
                moreDiv.textContent = `+${photos.length - 6}`;
                previewPhotos.appendChild(moreDiv);
            }
            document.getElementById('previewFlowerType').textContent = formData.flowerType || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            document.getElementById('previewDescription').textContent = formData.description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            let priceText = '';
            if (formData.priceType === 'fixed') priceText = `${formData.price} ‚ÇΩ`;
            else if (formData.priceType === 'negotiable') priceText = '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è';
            else priceText = `–ê—É–∫—Ü–∏–æ–Ω (–æ—Ç ${formData.price} ‚ÇΩ)`;
            document.getElementById('previewPrice').textContent = priceText;
            let contactText = '';
            if (formData.contactMethod === 'phone') contactText = `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${formData.contactValue}`;
            else if (formData.contactMethod === 'telegram') contactText = `üì± Telegram: ${formData.contactValue}`;
            else if (formData.contactMethod === 'whatsapp') contactText = `üí¨ WhatsApp: ${formData.contactValue}`;
            document.getElementById('previewContacts').textContent = contactText || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const previewConsent = document.getElementById('previewConsent');
            if (formData.newsletterConsent) {
                previewConsent.innerHTML = `<i class="fas fa-bell" style="color: #34c759;"></i> –í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è`;
            } else {
                previewConsent.innerHTML = `<i class="fas fa-bell-slash" style="color: #ff3b30;"></i> –í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è`;
            }
            document.getElementById('previewLocation').textContent = formData.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        }

        // === –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö: –∫–ª—é—á–µ–≤–∞—è —á–∞—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ===
        // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±: WebApp.sendData -> –±–æ—Ç –ø–æ–ª—É—á–∏—Ç message.web_app_data
        async function publishAd() {
            // validate current data first
            if (!validateStep(1) || !validateStep(2) || !validateStep(3) || !validateStep(4) || !validateStep(5)) {
                // validation will show notifications
                return;
            }

            // finalize data before sending
            formData.photos = photos.map(p => p.url);
            formData.newsletterConsent = newsletterConsent;
            formData.userInfo = formData.userInfo || {};

            // Try to fetch Telegram WebApp user info if available
            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
                try {
                    const ui = Telegram.WebApp.initDataUnsafe.user;
                    if (ui) {
                        formData.userInfo = {
                            id: ui.id,
                            username: ui.username,
                            first_name: ui.first_name,
                            last_name: ui.last_name
                        };
                    }
                } catch (e) {
                    console.warn('No Telegram WebApp user info', e);
                }
            }

            // –ï—Å–ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ Telegram WebApp, –∏—Å–ø–æ–ª—å–∑—É–µ–º sendData
            if (window.Telegram && Telegram.WebApp && typeof Telegram.WebApp.sendData === 'function') {
                try {
                    Telegram.WebApp.sendData(JSON.stringify(formData));
                    showNotification('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', '–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —á–µ—Ä–µ–∑ Telegram.', 'success');
                    // disable button briefly
                    const btn = document.getElementById('publishBtn');
                    btn.disabled = true;
                    btn.innerHTML = '<div class="loader"></div> –û—Ç–ø—Ä–∞–≤–∫–∞...';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É';
                    }, 3000);
                    return;
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Telegram.WebApp.sendData', err);
                    // fallthrough to fallback
                }
            }

            // FALLBACK: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ FormSubmit (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª—Å—è –≤–Ω–µ Telegram)
            try {
                const resp = await fetch(`https://formsubmit.co/ajax/${encodeURIComponent(FORMSUBMIT_EMAIL)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({
                        _subject: 'üå∏ –ù–û–í–û–ï –û–ë–™–Ø–í–õ–ï–ù–ò–ï –û –¶–í–ï–¢–ê–•',
                        flowerType: formData.flowerType,
                        description: formData.description,
                        price: formData.price,
                        contacts: formData.contactValue || '',
                        contact_type: formData.contactMethod || '',
                        location: formData.location || '',
                        photosCount: formData.photos ? formData.photos.length : 0,
                        _template: 'table'
                    })
                });
                const result = await resp.json();
                if (result.success || resp.ok) {
                    showNotification('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', '–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–∞–Ω–∞–ª).', 'success');
                } else {
                    console.error('FormSubmit failed', result);
                    showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
                }
            } catch (err) {
                console.error('Error sending via FormSubmit', err);
                showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
            }
        }

        // === payment screenshot & admin interactions handled in bot (server) ===
        // –û—Å—Ç–∞–ª—å–Ω–æ–π JS: –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, —ç–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ –ø—Ä.
        // –Ø –æ—Å—Ç–∞–≤–∏–ª –æ—Å—Ç–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –∫–∞–∫ —É —Ç–µ–±—è ‚Äî –æ–Ω–∞ –Ω–µ –º–µ—à–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞.

        // –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤
        let nominatimTimer = null;
        document.getElementById('location').addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.length < 3) {
                document.getElementById('addressSuggestions').innerHTML = '';
                return;
            }
            if (nominatimTimer) clearTimeout(nominatimTimer);
            nominatimTimer = setTimeout(() => {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=ru,by,kz,ua`)
                    .then(response => response.json())
                    .then(data => {
                        const suggestions = document.getElementById('addressSuggestions');
                        suggestions.innerHTML = '';
                        if (data.length === 0) {
                            suggestions.innerHTML = '<div class="address-suggestion">–ê–¥—Ä–µ—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                            return;
                        }
                        data.forEach(item => {
                            const suggestion = document.createElement('div');
                            suggestion.className = 'address-suggestion';
                            suggestion.textContent = item.display_name;
                            suggestion.addEventListener('click', () => {
                                document.getElementById('location').value = item.display_name;
                                formData.location = item.display_name;
                                formData.latitude = item.lat;
                                formData.longitude = item.lon;
                                document.getElementById('selectedLocationText').textContent = item.display_name.split(',').slice(0, 3).join(',');
                                suggestions.innerHTML = '';
                                if (map) {
                                    map.setView([item.lat, item.lon], 13);
                                    if (marker) marker.setLatLng([item.lat, item.lon]);
                                    else marker = L.marker([item.lat, item.lon]).addTo(map);
                                }
                            });
                            suggestions.appendChild(suggestion);
                        });
                    })
                    .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∞–¥—Ä–µ—Å–∞:', error));
            }, 300);
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('#location') && !e.target.closest('.address-suggestion')) {
                document.getElementById('addressSuggestions').innerHTML = '';
            }
        });
    </script>
</body>
</html>
