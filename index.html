<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flower Market - Создать объявление</title>
    <style>
        /* Стили остаются такими же, только добавляем новые классы */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .connection-status.online { background: rgba(52, 199, 89, 0.9); }
        .connection-status.offline { background: rgba(255, 59, 48, 0.9); }
        .connection-status.checking { background: rgba(255, 149, 0, 0.9); }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .connection-dot.online { background: #34c759; animation: pulse 2s infinite; }
        .connection-dot.offline { background: #ff3b30; }
        .connection-dot.checking { background: #ff9500; animation: blink 1s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .retry-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .retry-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .error-details {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 13px;
            color: #666;
            display: none;
        }
        
        .error-details.show {
            display: block;
        }
        
        .error-toggle {
            color: #ff3b30;
            text-decoration: underline;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            display: inline-block;
        }
        
        /* Остальные стили остаются такими же как в предыдущей версии */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: env(safe-area-inset-bottom, 20px); }
        .header { text-align: center; color: white; margin-bottom: 30px; padding-top: env(safe-area-inset-top, 0); }
        .header h1 { font-size: 24px; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .form-container { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .form-step { display: none; animation-duration: 0.3s; animation-fill-mode: both; }
        .form-step.active { display: block; animation-name: fadeInUp; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .step-title { font-size: 20px; color: #333; margin-bottom: 25px; text-align: center; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 10px; color: #555; font-weight: 500; font-size: 15px; }
        .input-wrapper { position: relative; }
        input, textarea, select { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; font-family: inherit; transition: all 0.3s ease; background: #fff; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        textarea { min-height: 140px; resize: vertical; line-height: 1.5; }
        .input-hint { display: block; margin-top: 8px; color: #888; font-size: 13px; }
        .photo-upload { border: 3px dashed #667eea; border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: rgba(102, 126, 234, 0.05); }
        .photo-upload:hover, .photo-upload:active { background: rgba(102, 126, 234, 0.1); }
        .photo-upload-icon { font-size: 48px; color: #667eea; margin-bottom: 15px; display: block; }
        #photoInput { display: none; }
        #photoPreview { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px; }
        .photo-item { position: relative; width: 100px; height: 100px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
        .photo-item:hover { transform: scale(1.05); }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-photo { position: absolute; top: 6px; right: 6px; background: rgba(255, 59, 48, 0.9); color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.2s; border: 2px solid white; }
        .remove-photo:hover { background: rgba(255, 59, 48, 1); }
        .contact-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        @media (max-width: 480px) { .contact-options { grid-template-columns: 1fr; } }
        .contact-option { padding: 20px 15px; border: 2px solid #e0e0e0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #fff; }
        .contact-option:hover { border-color: #667eea; background: rgba(102, 126, 234, 0.05); }
        .contact-option.active { border-color: #667eea; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3); }
        .contact-option i { font-size: 28px; margin-bottom: 12px; display: block; }
        .contact-option p { font-size: 15px; font-weight: 500; margin-bottom: 5px; }
        .contact-option small { font-size: 12px; opacity: 0.8; }
        .location-map { width: 100%; height: 200px; border-radius: 12px; overflow: hidden; margin-bottom: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #667eea; border: 2px solid #e0e0e0; }
        .location-map i { font-size: 48px; margin-bottom: 10px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 30px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; position: relative; overflow: hidden; }
        .btn:after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%); opacity: 0; transition: opacity 0.3s; }
        .btn:hover:after, .btn:active:after { opacity: 1; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .btn:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn-secondary { background: #f0f0f0; color: #333; background-image: none; }
        .btn-secondary:hover { background: #e0e0e0; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .navigation { display: flex; gap: 15px; margin-top: 30px; }
        .navigation .btn { flex: 1; }
        .preview-item { background: rgba(102, 126, 234, 0.05); padding: 18px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #667eea; }
        .preview-label { font-weight: 600; color: #667eea; margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .preview-value { color: #333; font-size: 16px; line-height: 1.5; }
        .photos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .photo-preview { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .photo-more { display: flex; align-items: center; justify-content: center; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 20px; font-weight: bold; color: #667eea; }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .progress-bar:before { content: ''; position: absolute; top: 15px; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.3); z-index: 1; }
        .progress-step { position: relative; z-index: 2; text-align: center; flex: 1; }
        .step-number { width: 36px; height: 36px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; color: white; font-weight: 600; transition: all 0.3s; }
        .step-number.active { background: white; color: #667eea; box-shadow: 0 0 0 4px rgba(255,255,255,0.3); }
        .step-label { color: rgba(255,255,255,0.7); font-size: 12px; transition: color 0.3s; }
        .step-label.active { color: white; font-weight: 500; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; gap: 12px; transition: transform 0.4s ease; max-width: 90%; width: 400px; }
        .notification.show { transform: translateX(-50%) translateY(0); }
        .notification-icon { font-size: 22px; color: #ff3b30; }
        .notification.success .notification-icon { color: #34c759; }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 600; margin-bottom: 4px; color: #333; }
        .notification-message { color: #666; font-size: 14px; }
        .loader { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .success-screen { text-align: center; padding: 40px 20px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .success-icon { font-size: 80px; color: #34c759; margin-bottom: 25px; animation: bounce 1s ease infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .success-title { font-size: 28px; color: #333; margin-bottom: 15px; font-weight: 600; }
        .success-message { color: #666; line-height: 1.6; margin-bottom: 30px; font-size: 16px; }
        .success-steps { background: rgba(102, 126, 234, 0.05); border-radius: 12px; padding: 20px; margin: 30px 0; text-align: left; }
        .success-step { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .success-step:last-child { margin-bottom: 0; }
        .step-badge { background: #667eea; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; flex-shrink: 0; }
        .step-text { flex: 1; color: #555; }
        @media (max-width: 600px) { body { padding: 15px; } .form-container { padding: 20px; border-radius: 16px; } .step-title { font-size: 18px; } .photo-item { width: 80px; height: 80px; } .btn { padding: 14px 20px; font-size: 15px; } }
        @media (max-width: 380px) { .photos-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Индикатор соединения -->
    <div class="connection-status" id="connectionStatus">
        <div class="connection-dot" id="connectionDot"></div>
        <span id="connectionText">Проверка соединения...</span>
        <button class="retry-btn" onclick="checkConnection()" id="retryBtn" style="display: none;">Повторить</button>
    </div>

    <div class="container">
        <div class="progress-bar" id="progressBar">
            <div class="progress-step"><div class="step-number active">1</div><div class="step-label active">Фото</div></div>
            <div class="progress-step"><div class="step-number">2</div><div class="step-label">Описание</div></div>
            <div class="progress-step"><div class="step-number">3</div><div class="step-label">Цена</div></div>
            <div class="progress-step"><div class="step-number">4</div><div class="step-label">Контакты</div></div>
            <div class="progress-step"><div class="step-number">5</div><div class="step-label">Локация</div></div>
            <div class="progress-step"><div class="step-number">6</div><div class="step-label">Превью</div></div>
        </div>
        
        <div class="header">
            <h1><i class="fas fa-flower-tulip"></i> Flower Market</h1>
            <p>Создайте красивое объявление о продаже цветов</p>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-exclamation-circle notification-icon"></i>
        <div class="notification-content">
            <div class="notification-title" id="notificationTitle">Ошибка</div>
            <div class="notification-message" id="notificationMessage"></div>
        </div>
    </div>

    <div class="container">
        <div class="form-container" id="formContainer">
            <!-- Шаг 1: Фото -->
            <div class="form-step active" id="step1">
                <h2 class="step-title"><i class="fas fa-camera"></i> Загрузите фото</h2>
                <div class="form-group">
                    <div class="photo-upload" id="photoUpload" role="button" aria-label="Загрузить фото">
                        <i class="fas fa-cloud-upload-alt photo-upload-icon"></i>
                        <p>Нажмите для загрузки фото</p>
                        <p class="input-hint">Можно загрузить до 10 фото (рекомендуемый размер до 5MB)</p>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" multiple>
                    <div id="photoPreview"></div>
                </div>
                <div class="navigation"><button class="btn" onclick="nextStep()" id="nextBtn1">Далее <i class="fas fa-arrow-right"></i></button></div>
            </div>
            
            <!-- Шаг 2: Описание -->
            <div class="form-step" id="step2">
                <h2 class="step-title"><i class="fas fa-edit"></i> Описание товара</h2>
                <div class="form-group">
                    <label for="description">Опишите ваш товар:</label>
                    <textarea id="description" placeholder="Например: Свежие розы из Эквадора, идеально подходят для свадебных букетов. Доставка по городу."></textarea>
                    <p class="input-hint">Минимум 3 символа. Опишите ваши цветы подробно</p>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
                    <button class="btn" onclick="nextStep()" id="nextBtn2">Далее <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            
            <!-- Шаг 3: Цена -->
            <div class="form-step" id="step3">
                <h2 class="step-title"><i class="fas fa-tag"></i> Укажите цену</h2>
                <div class="form-group">
                    <label for="price">Цена в сомах:</label>
                    <input type="text" id="price" placeholder="Например: 1500 или Договорная">
                    <p class="input-hint">Можно указать диапазон: 1000-1500, или "Договорная"</p>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
                    <button class="btn" onclick="nextStep()" id="nextBtn3">Далее <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            
            <!-- Шаг 4: Контакты -->
            <div class="form-step" id="step4">
                <h2 class="step-title"><i class="fas fa-phone"></i> Контакты для связи</h2>
                <div class="contact-options">
                    <div class="contact-option active" id="telegramOption" onclick="selectContactType('telegram')" role="button">
                        <i class="fab fa-telegram"></i>
                        <p>Telegram</p>
                        <small>Ввести username</small>
                    </div>
                    <div class="contact-option" id="phoneOption" onclick="selectContactType('phone')" role="button">
                        <i class="fas fa-mobile-alt"></i>
                        <p>Телефон</p>
                        <small>Ввести номер</small>
                    </div>
                </div>
                <div class="form-group" id="telegramInputGroup">
                    <label for="telegram">Введите Telegram username:</label>
                    <input type="text" id="telegram" placeholder="@username">
                    <p class="input-hint">Например: @username (без пробелов)</p>
                </div>
                <div class="form-group" id="phoneInputGroup" style="display: none;">
                    <label for="phone">Введите номер телефона:</label>
                    <input type="tel" id="phone" placeholder="+996 XXX XXX XXX">
                    <p class="input-hint">Формат: +996XXXYYYZZZ (без пробелов)</p>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
                    <button class="btn" onclick="nextStep()" id="nextBtn4">Далее <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            
            <!-- Шаг 5: Локация -->
            <div class="form-step" id="step5">
                <h2 class="step-title"><i class="fas fa-map-marker-alt"></i> Локация</h2>
                <div class="form-group">
                    <div class="location-map" id="map"><i class="fas fa-map"></i><p style="margin-top: 10px; font-size: 14px;">Ваше местоположение</p></div>
                    <label for="locationInput">Адрес или район:</label>
                    <input type="text" id="locationInput" placeholder="Например: г. Бишкек, ул. Чуй, 123">
                    <p class="input-hint" style="margin: 15px 0;">Или используйте текущую геолокацию:</p>
                    <button class="btn btn-secondary" onclick="getCurrentLocation()" id="locationBtn"><i class="fas fa-location-crosshairs"></i> Использовать мое местоположение</button>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
                    <button class="btn" onclick="nextStep()" id="nextBtn5">Далее <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            
            <!-- Шаг 6: Превью -->
            <div class="form-step" id="step6">
                <h2 class="step-title"><i class="fas fa-eye"></i> Превью объявления</h2>
                
                <div class="preview-item"><div class="preview-label">Фото</div><div id="previewPhotos" class="photos-grid"></div></div>
                <div class="preview-item"><div class="preview-label">Описание</div><div class="preview-value" id="previewDescription"></div></div>
                <div class="preview-item"><div class="preview-label">Цена</div><div class="preview-value" id="previewPrice"></div></div>
                <div class="preview-item"><div class="preview-label">Контакты</div><div class="preview-value" id="previewContacts"></div></div>
                <div class="preview-item"><div class="preview-label">Локация</div><div class="preview-value" id="previewLocation"></div></div>
                
                <div id="errorDetails" class="error-details">
                    <div id="errorDetailsContent"></div>
                </div>
                
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
                    <button class="btn" onclick="submitForm()" id="submitBtn">Опубликовать <i class="fas fa-paper-plane"></i></button>
                </div>
                
                <p class="error-toggle" onclick="toggleErrorDetails()" id="errorToggle" style="display: none;">Показать подробности ошибки</p>
            </div>
        </div>

        <!-- Экран успешной публикации -->
        <div class="form-container" id="successScreen" style="display: none;">
            <div class="success-screen">
                <i class="fas fa-check-circle success-icon"></i>
                <h2 class="success-title">Объявление успешно опубликовано!</h2>
                <p class="success-message">Ваше объявление было опубликовано в канале @FlowerMarketKG.<br>Теперь его могут видеть все покупатели.</p>
                
                <div class="success-steps">
                    <div class="success-step">
                        <div class="step-badge">1</div>
                        <div class="step-text">Объявление опубликовано в канале</div>
                    </div>
                    <div class="success-step">
                        <div class="step-badge">2</div>
                        <div class="step-text">Покупатели могут связаться с вами по указанным контактам</div>
                    </div>
                    <div class="success-step">
                        <div class="step-badge">3</div>
                        <div class="step-text">Объявление будет активно 7 дней</div>
                    </div>
                </div>
                
                <p style="margin-top: 20px; color: #667eea; font-weight: 600;">
                    <i class="fas fa-info-circle"></i> Объявление можно посмотреть в канале: 
                    <a href="https://t.me/FlowerMarketKG" target="_blank" style="color: #667eea; text-decoration: underline;">@FlowerMarketKG</a>
                </p>
                
                <button class="btn" onclick="createNewAd()" style="margin-top: 30px;">
                    <i class="fas fa-plus"></i> Создать новое объявление
                </button>
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let formData = {
            photos: [],
            description: '',
            price: '',
            contact_type: 'telegram',
            contacts: '',
            location: { type: 'none', address: 'Не указано' }
        };
        
        let currentStep = 1;
        const totalSteps = 6;
        const MAX_PHOTOS = 10;
        const MAX_PHOTO_SIZE = 10 * 1024 * 1024; // 10MB
        
        // Улучшенная проверка соединения
        async function checkConnection() {
            const statusElement = document.getElementById('connectionStatus');
            const dotElement = document.getElementById('connectionDot');
            const textElement = document.getElementById('connectionText');
            const retryBtn = document.getElementById('retryBtn');
            
            statusElement.className = 'connection-status checking';
            dotElement.className = 'connection-dot checking';
            textElement.textContent = 'Проверка соединения...';
            retryBtn.style.display = 'none';
            
            try {
                console.log('Проверка соединения с сервером...');
                
                const response = await fetch('/api/check-health', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    timeout: 10000
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ошибка: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    statusElement.className = 'connection-status online';
                    dotElement.className = 'connection-dot online';
                    textElement.textContent = 'Соединение установлено ✓';
                    
                    // Сохраняем статус в localStorage
                    localStorage.setItem('lastConnectionCheck', Date.now());
                    localStorage.setItem('connectionStatus', 'online');
                    
                    return true;
                } else {
                    throw new Error(result.error || 'Ошибка соединения');
                }
                
            } catch (error) {
                console.error('Ошибка проверки соединения:', error);
                
                statusElement.className = 'connection-status offline';
                dotElement.className = 'connection-dot offline';
                textElement.textContent = 'Нет соединения с сервером';
                retryBtn.style.display = 'inline-block';
                
                localStorage.setItem('connectionStatus', 'offline');
                localStorage.setItem('lastConnectionError', error.message);
                
                return false;
            }
        }
        
        // Проверка размера фото перед загрузкой
        function validatePhotoSize(file) {
            if (file.size > MAX_PHOTO_SIZE) {
                const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
                const maxMB = (MAX_PHOTO_SIZE / (1024 * 1024)).toFixed(1);
                
                showNotification(
                    'Фото слишком большое', 
                    `Фото "${file.name}" весит ${sizeMB}MB. Максимальный размер: ${maxMB}MB.`,
                    'warning'
                );
                return false;
            }
            return true;
        }
        
        // Улучшенная обработка ошибок JSON
        async function safeJsonResponse(response) {
            try {
                const text = await response.text();
                
                if (!text.trim()) {
                    throw new Error('Пустой ответ от сервера');
                }
                
                return JSON.parse(text);
            } catch (error) {
                console.error('Ошибка парсинга JSON:', error, 'Ответ:', response.statusText);
                
                // Пытаемся извлечь информацию из текста ошибки
                let errorMessage = 'Ошибка обработки ответа от сервера';
                let errorDetails = error.message;
                
                if (response.status === 413) {
                    errorMessage = 'Данные слишком большие';
                    errorDetails = 'Попробуйте уменьшить размер фото';
                } else if (response.status === 400) {
                    errorMessage = 'Неверные данные';
                    errorDetails = 'Проверьте правильность заполнения полей';
                } else if (response.status === 500) {
                    errorMessage = 'Ошибка сервера';
                    errorDetails = 'Пожалуйста, попробуйте позже';
                }
                
                return {
                    success: false,
                    error: errorMessage,
                    details: errorDetails
                };
            }
        }
        
        // Улучшенная функция отправки данных
        async function sendDataWithRetry(data, retries = 3) {
            let lastError = null;
            
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    console.log(`Попытка ${attempt} отправки данных...`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 секунд
                    
                    const response = await fetch('/api/create-ad', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    const result = await safeJsonResponse(response);
                    
                    if (response.ok && result.success) {
                        console.log('Данные успешно отправлены');
                        return result;
                    } else {
                        throw new Error(result.error || `HTTP ${response.status}`);
                    }
                    
                } catch (error) {
                    lastError = error;
                    console.error(`Попытка ${attempt} не удалась:`, error.message);
                    
                    if (attempt === retries) {
                        break;
                    }
                    
                    // Экспоненциальная задержка между попытками
                    const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
                    console.log(`Ждем ${delay}ms перед следующей попыткой...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            throw lastError || new Error('Не удалось отправить данные после всех попыток');
        }
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            document.getElementById('photoUpload').addEventListener('click', () => {
                document.getElementById('photoInput').click();
            });
            
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
            
            document.getElementById('description').addEventListener('input', debounce(() => {
                formData.description = document.getElementById('description').value;
            }, 500));
            
            document.getElementById('price').addEventListener('input', debounce(() => {
                formData.price = document.getElementById('price').value;
            }, 300));
            
            document.getElementById('telegram').addEventListener('input', debounce(() => {
                if (formData.contact_type === 'telegram') {
                    let telegram = document.getElementById('telegram').value.trim();
                    if (!telegram.startsWith('@') && telegram.length > 0) {
                        telegram = '@' + telegram;
                        document.getElementById('telegram').value = telegram;
                    }
                    formData.contacts = telegram;
                }
            }, 300));
            
            document.getElementById('phone').addEventListener('input', debounce(() => {
                if (formData.contact_type === 'phone') {
                    formData.contacts = document.getElementById('phone').value;
                }
            }, 300));
            
            document.getElementById('locationInput').addEventListener('input', debounce(() => {
                const value = document.getElementById('locationInput').value.trim();
                if (value) {
                    formData.location = {
                        type: 'address',
                        address: value
                    };
                }
            }, 500));
            
            // Обработка нажатия Enter
            document.getElementById('description').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && currentStep === 2) {
                    e.preventDefault();
                    nextStep();
                }
            });
            
            document.getElementById('price').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && currentStep === 3) {
                    e.preventDefault();
                    nextStep();
                }
            });
            
            document.getElementById('telegram').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && currentStep === 4 && formData.contact_type === 'telegram') {
                    e.preventDefault();
                    nextStep();
                }
            });
            
            document.getElementById('phone').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && currentStep === 4 && formData.contact_type === 'phone') {
                    e.preventDefault();
                    nextStep();
                }
            });
            
            document.getElementById('locationInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && currentStep === 5) {
                    e.preventDefault();
                    nextStep();
                }
            });
        }
        
        // Показать уведомление
        function showNotification(title, message, type = 'error') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            const icon = notification.querySelector('.notification-icon');
            
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            notification.className = 'notification';
            if (type === 'success') {
                notification.classList.add('success');
                icon.className = 'fas fa-check-circle notification-icon';
            } else if (type === 'warning') {
                icon.className = 'fas fa-exclamation-triangle notification-icon';
            } else if (type === 'info') {
                icon.className = 'fas fa-info-circle notification-icon';
            } else {
                icon.className = 'fas fa-exclamation-circle notification-icon';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // Обработка загрузки фото
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            const currentCount = formData.photos.length;
            
            if (currentCount + files.length > MAX_PHOTOS) {
                showNotification('Ошибка', `Максимальное количество фото: ${MAX_PHOTOS}. У вас уже ${currentCount} фото.`);
                event.target.value = '';
                return;
            }
            
            const validFiles = files.filter(file => {
                if (!file.type.startsWith('image/')) {
                    showNotification('Ошибка', `Файл "${file.name}" не является изображением.`);
                    return false;
                }
                
                if (!validatePhotoSize(file)) {
                    return false;
                }
                
                return true;
            });
            
            validFiles.forEach(file => {
                const reader = new FileReader();
                
                reader.onloadstart = function() {
                    console.log(`Начало загрузки фото: ${file.name}`);
                };
                
                reader.onload = function(e) {
                    console.log(`Фото "${file.name}" успешно загружено, размер: ${e.total} байт`);
                    formData.photos.push(e.target.result);
                    createPhotoPreview(e.target.result, formData.photos.length - 1);
                    updatePhotoCounter();
                };
                
                reader.onerror = function() {
                    console.error(`Ошибка загрузки фото "${file.name}"`);
                    showNotification('Ошибка', `Не удалось загрузить фото "${file.name}"`);
                };
                
                reader.onabort = function() {
                    console.warn(`Загрузка фото "${file.name}" отменена`);
                };
                
                reader.readAsDataURL(file);
            });
            
            event.target.value = '';
        }
        
        // Создание превью фото
        function createPhotoPreview(dataUrl, index) {
            const preview = document.getElementById('photoPreview');
            
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            photoItem.setAttribute('data-index', index);
            
            const img = document.createElement('img');
            img.src = dataUrl;
            img.alt = `Фото ${index + 1}`;
            img.loading = 'lazy';
            img.onerror = function() {
                console.error(`Ошибка загрузки превью фото ${index + 1}`);
                this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><text x="50" y="50" font-family="Arial" font-size="12" fill="%23999" text-anchor="middle" dominant-baseline="middle">Ошибка фото</text></svg>';
            };
            
            const removeBtn = document.createElement('div');
            removeBtn.className = 'remove-photo';
            removeBtn.innerHTML = '×';
            removeBtn.setAttribute('aria-label', 'Удалить фото');
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removePhoto(index);
            };
            
            photoItem.appendChild(img);
            photoItem.appendChild(removeBtn);
            preview.appendChild(photoItem);
        }
        
        // Удаление фото
        function removePhoto(index) {
            formData.photos.splice(index, 1);
            updatePhotoPreview();
            updatePhotoCounter();
        }
        
        // Обновление всех превью фото
        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            
            formData.photos.forEach((photo, index) => {
                createPhotoPreview(photo, index);
            });
        }
        
        // Обновление счетчика фото
        function updatePhotoCounter() {
            const photoUpload = document.getElementById('photoUpload');
            const photoCount = formData.photos.length;
            
            if (photoCount > 0) {
                photoUpload.innerHTML = `
                    <i class="fas fa-check-circle photo-upload-icon" style="color: #34c759;"></i>
                    <p>Загружено фото: ${photoCount}</p>
                    <p class="input-hint">Можно добавить еще ${MAX_PHOTOS - photoCount} фото</p>
                `;
            } else {
                photoUpload.innerHTML = `
                    <i class="fas fa-cloud-upload-alt photo-upload-icon"></i>
                    <p>Нажмите для загрузки фото</p>
                    <p class="input-hint">Можно загрузить до ${MAX_PHOTOS} фото</p>
                `;
            }
        }
        
        // Навигация по шагам
        function showStep(step) {
            saveCurrentStepData();
            
            for (let i = 1; i <= totalSteps; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (stepElement) {
                    stepElement.classList.remove('active');
                }
            }
            
            const currentStepElement = document.getElementById(`step${step}`);
            if (currentStepElement) {
                currentStepElement.classList.add('active');
            }
            
            currentStep = step;
            updateProgressBar();
            
            if (step === 6) {
                updatePreview();
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Следующий шаг
        function nextStep() {
            if (!validateStep(currentStep)) {
                return;
            }
            
            if (currentStep < totalSteps) {
                showStep(currentStep + 1);
            }
        }
        
        // Предыдущий шаг
        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }
        
        // Сохранение данных текущего шага
        function saveCurrentStepData() {
            switch(currentStep) {
                case 2:
                    formData.description = document.getElementById('description').value.trim();
                    break;
                case 3:
                    formData.price = document.getElementById('price').value.trim();
                    break;
                case 4:
                    if (formData.contact_type === 'telegram') {
                        let telegram = document.getElementById('telegram').value.trim();
                        if (!telegram.startsWith('@') && telegram.length > 0) {
                            telegram = '@' + telegram;
                        }
                        formData.contacts = telegram;
                    } else if (formData.contact_type === 'phone') {
                        formData.contacts = document.getElementById('phone').value.trim();
                    }
                    break;
                case 5:
                    const locationInput = document.getElementById('locationInput').value.trim();
                    if (locationInput) {
                        formData.location = {
                            type: 'address',
                            address: locationInput
                        };
                    }
                    break;
            }
        }
        
        // Валидация шагов
        function validateStep(step) {
            switch(step) {
                case 1:
                    if (formData.photos.length === 0) {
                        showNotification('Ошибка', 'Пожалуйста, загрузите хотя бы одно фото');
                        return false;
                    }
                    break;
                    
                case 2:
                    const description = document.getElementById('description').value.trim();
                    if (!description) {
                        showNotification('Ошибка', 'Пожалуйста, напишите описание товара');
                        document.getElementById('description').focus();
                        return false;
                    }
                    if (description.length < 3) {
                        showNotification('Ошибка', 'Описание должно содержать минимум 3 символа');
                        document.getElementById('description').focus();
                        return false;
                    }
                    formData.description = description;
                    break;
                    
                case 3:
                    const price = document.getElementById('price').value.trim();
                    if (!price) {
                        showNotification('Ошибка', 'Пожалуйста, укажите цену');
                        document.getElementById('price').focus();
                        return false;
                    }
                    formData.price = price;
                    break;
                    
                case 4:
                    if (formData.contact_type === 'telegram') {
                        let telegram = document.getElementById('telegram').value.trim();
                        if (!telegram) {
                            showNotification('Ошибка', 'Пожалуйста, введите Telegram username');
                            document.getElementById('telegram').focus();
                            return false;
                        }
                        if (!telegram.startsWith('@') && telegram.length > 0) {
                            telegram = '@' + telegram;
                            document.getElementById('telegram').value = telegram;
                        }
                        formData.contacts = telegram;
                    } else if (formData.contact_type === 'phone') {
                        const phone = document.getElementById('phone').value.trim();
                        
                        if (!phone) {
                            showNotification('Ошибка', 'Пожалуйста, введите номер телефона');
                            document.getElementById('phone').focus();
                            return false;
                        }
                        
                        formData.contacts = phone;
                    }
                    break;
                    
                case 5:
                    const locationInput = document.getElementById('locationInput').value.trim();
                    if (locationInput) {
                        formData.location = {
                            type: 'address',
                            address: locationInput
                        };
                    } else if (!formData.location.address || formData.location.address === 'Не указано') {
                        formData.location = {
                            type: 'none',
                            address: 'Не указано'
                        };
                    }
                    break;
            }
            
            return true;
        }
        
        // Выбор типа контактов
        function selectContactType(type) {
            formData.contact_type = type;
            
            document.getElementById('telegramOption').classList.remove('active');
            document.getElementById('phoneOption').classList.remove('active');
            document.getElementById(`${type}Option`).classList.add('active');
            
            const telegramInputGroup = document.getElementById('telegramInputGroup');
            const phoneInputGroup = document.getElementById('phoneInputGroup');
            
            if (type === 'telegram') {
                telegramInputGroup.style.display = 'block';
                phoneInputGroup.style.display = 'none';
            } else {
                telegramInputGroup.style.display = 'none';
                phoneInputGroup.style.display = 'block';
            }
        }
        
        // Получение геолокации
        async function getCurrentLocation() {
            const locationBtn = document.getElementById('locationBtn');
            const originalText = locationBtn.innerHTML;
            
            locationBtn.innerHTML = '<div class="loader"></div> Определение...';
            locationBtn.disabled = true;
            
            if (!navigator.geolocation) {
                showNotification('Ошибка', 'Ваш браузер не поддерживает геолокацию');
                resetLocationButton(locationBtn, originalText);
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    formData.location = {
                        type: 'coordinates',
                        latitude: lat,
                        longitude: lng,
                        address: ''
                    };
                    
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
                            {
                                headers: {
                                    'User-Agent': 'FlowerMarketBot/1.0',
                                    'Accept-Language': 'ru,en-US;q=0.9,en;q=0.8'
                                }
                            }
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.display_name) {
                                const addressParts = data.display_name.split(',');
                                const shortAddress = addressParts.slice(0, 3).join(', ');
                                document.getElementById('locationInput').value = shortAddress;
                                formData.location.address = shortAddress;
                                locationBtn.innerHTML = '<i class="fas fa-check"></i> Адрес определен';
                                showNotification('Успешно', 'Местоположение определено', 'success');
                            }
                        }
                    } catch (error) {
                        console.error('Ошибка получения адреса:', error);
                        document.getElementById('locationInput').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        formData.location.address = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        locationBtn.innerHTML = '<i class="fas fa-check"></i> Координаты получены';
                        showNotification('Успешно', 'Координаты получены', 'success');
                    }
                    
                    setTimeout(() => {
                        resetLocationButton(locationBtn, originalText);
                    }, 2000);
                },
                function(error) {
                    let errorMessage = 'Не удалось получить местоположение';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Вы отказали в доступе к геолокации. Разрешите доступ в настройках браузера.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Информация о местоположении недоступна.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Время ожидания истекло. Попробуйте еще раз.';
                            break;
                    }
                    showNotification('Ошибка геолокации', errorMessage);
                    resetLocationButton(locationBtn, originalText);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        // Сброс кнопки геолокации
        function resetLocationButton(button, originalText) {
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 1000);
        }
        
        // Обновление превью
        function updatePreview() {
            const previewPhotos = document.getElementById('previewPhotos');
            previewPhotos.innerHTML = '';
            
            const photosToShow = formData.photos.slice(0, 6);
            
            photosToShow.forEach((photo, index) => {
                const img = document.createElement('img');
                img.className = 'photo-preview';
                img.src = photo;
                img.alt = `Фото ${index + 1}`;
                img.loading = 'lazy';
                previewPhotos.appendChild(img);
            });
            
            if (formData.photos.length > 6) {
                const moreCount = document.createElement('div');
                moreCount.className = 'photo-preview photo-more';
                moreCount.textContent = `+${formData.photos.length - 6}`;
                previewPhotos.appendChild(moreCount);
            }
            
            document.getElementById('previewDescription').textContent = formData.description || 'Не указано';
            document.getElementById('previewPrice').textContent = formData.price || 'Не указана';
            
            let contactsText = '';
            if (formData.contact_type === 'telegram') {
                contactsText = `Telegram: ${formData.contacts || 'Не указано'}`;
            } else {
                contactsText = `Телефон: ${formData.contacts || 'Не указано'}`;
            }
            document.getElementById('previewContacts').textContent = contactsText;
            
            let locationText = '';
            if (formData.location.type === 'coordinates') {
                locationText = `📍 Геолокация: ${formData.location.address || 'Координаты получены'}`;
            } else if (formData.location.type === 'address') {
                locationText = `📍 Адрес: ${formData.location.address}`;
            } else {
                locationText = '📍 Не указана';
            }
            document.getElementById('previewLocation').textContent = locationText;
        }
        
        // Обновление прогресс бара
        function updateProgressBar() {
            const stepNumbers = document.querySelectorAll('.step-number');
            const stepLabels = document.querySelectorAll('.step-label');
            
            stepNumbers.forEach((number, index) => {
                if (index + 1 === currentStep) {
                    number.classList.add('active');
                } else {
                    number.classList.remove('active');
                }
            });
            
            stepLabels.forEach((label, index) => {
                if (index + 1 <= currentStep) {
                    label.classList.add('active');
                } else {
                    label.classList.remove('active');
                }
            });
        }
        
        // Показать/скрыть детали ошибки
        function toggleErrorDetails() {
            const errorDetails = document.getElementById('errorDetails');
            const errorToggle = document.getElementById('errorToggle');
            
            if (errorDetails.classList.contains('show')) {
                errorDetails.classList.remove('show');
                errorToggle.textContent = 'Показать подробности ошибки';
            } else {
                errorDetails.classList.add('show');
                errorToggle.textContent = 'Скрыть подробности ошибки';
            }
        }
        
        // Отправка формы с улучшенной обработкой ошибок
        async function submitForm() {
            if (!validateStep(currentStep)) {
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            const errorToggle = document.getElementById('errorToggle');
            const errorDetails = document.getElementById('errorDetails');
            const errorDetailsContent = document.getElementById('errorDetailsContent');
            
            // Скрываем предыдущие ошибки
            errorToggle.style.display = 'none';
            errorDetails.classList.remove('show');
            
            submitBtn.innerHTML = '<div class="loader"></div> Публикация...';
            submitBtn.disabled = true;
            
            try {
                // Проверяем соединение перед отправкой
                const isConnected = await checkConnection();
                if (!isConnected) {
                    throw new Error('Нет соединения с сервером. Проверьте подключение к интернету.');
                }
                
                // Проверяем данные перед отправкой
                if (!formData.description || !formData.price || !formData.contacts) {
                    throw new Error('Не все обязательные поля заполнены');
                }
                
                // Логируем данные для отладки
                console.log('Отправка объявления:', {
                    description_length: formData.description.length,
                    price: formData.price,
                    contacts: formData.contacts,
                    photos_count: formData.photos.length,
                    location: formData.location
                });
                
                const finalData = {
                    photos: formData.photos,
                    description: formData.description.trim(),
                    price: formData.price.trim(),
                    contact_type: formData.contact_type,
                    contacts: formData.contacts.trim(),
                    location: formData.location,
                    timestamp: new Date().toISOString()
                };
                
                // Отправляем данные с повторными попытками
                const result = await sendDataWithRetry(finalData, 3);
                
                if (result.success) {
                    showSuccessScreen();
                } else {
                    throw new Error(result.error || 'Не удалось опубликовать объявление');
                }
                
            } catch (error) {
                console.error('Ошибка отправки формы:', error);
                
                // Формируем понятное сообщение об ошибке
                let errorMessage = error.message || 'Не удалось отправить объявление';
                let errorDetail = '';
                
                if (error.message.includes('network') || error.message.includes('Network')) {
                    errorMessage = 'Проблемы с интернет-соединением';
                    errorDetail = 'Проверьте подключение к интернету и попробуйте снова';
                } else if (error.message.includes('timeout') || error.message.includes('Timeout')) {
                    errorMessage = 'Превышено время ожидания';
                    errorDetail = 'Сервер долго не отвечает. Попробуйте позже или проверьте интернет-соединение';
                } else if (error.message.includes('JSON') || error.message.includes('парсинга')) {
                    errorMessage = 'Ошибка обработки данных';
                    errorDetail = 'Попробуйте перезагрузить страницу и отправить объявление заново';
                } else if (error.message.includes('413')) {
                    errorMessage = 'Данные слишком большие';
                    errorDetail = 'Попробуйте уменьшить размер фото или количество фото';
                }
                
                showNotification('Ошибка отправки', errorMessage);
                
                // Показываем детали ошибки
                if (errorDetail || error.stack) {
                    errorDetailsContent.innerHTML = `
                        <strong>Детали ошибки:</strong><br>
                        ${errorDetail || error.message}<br><br>
                        <strong>Что можно сделать:</strong><br>
                        1. Проверьте интернет-соединение<br>
                        2. Уменьшите размер фото<br>
                        3. Попробуйте отправить без фото<br>
                        4. Обновите страницу и попробуйте снова<br><br>
                        <small>Код ошибки: ${Date.now().toString(36)}</small>
                    `;
                    errorToggle.style.display = 'block';
                }
                
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                // Сохраняем данные формы в localStorage на случай ошибки
                try {
                    localStorage.setItem('lastFormData', JSON.stringify(formData));
                    localStorage.setItem('lastFormError', error.message);
                    localStorage.setItem('lastFormErrorTime', Date.now());
                } catch (e) {
                    console.error('Не удалось сохранить данные формы:', e);
                }
            }
        }
        
        // Восстановление данных формы из localStorage
        function restoreFormData() {
            try {
                const savedData = localStorage.getItem('lastFormData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (parsedData && parsedData.description) {
                        if (confirm('Найдены неотправленные данные предыдущего объявления. Восстановить?')) {
                            formData = parsedData;
                            
                            // Восстанавливаем поля формы
                            if (formData.description) {
                                document.getElementById('description').value = formData.description;
                            }
                            if (formData.price) {
                                document.getElementById('price').value = formData.price;
                            }
                            if (formData.contacts) {
                                if (formData.contact_type === 'telegram') {
                                    document.getElementById('telegram').value = formData.contacts;
                                } else {
                                    document.getElementById('phone').value = formData.contacts;
                                }
                            }
                            if (formData.location && formData.location.address) {
                                document.getElementById('locationInput').value = formData.location.address;
                            }
                            
                            // Восстанавливаем фото
                            updatePhotoPreview();
                            updatePhotoCounter();
                            
                            showNotification('Восстановлено', 'Данные предыдущего объявления восстановлены', 'info');
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка восстановления данных:', error);
            }
        }
        
        // Показать экран успешной публикации
        function showSuccessScreen() {
            document.getElementById('formContainer').style.display = 'none';
            document.getElementById('successScreen').style.display = 'block';
            
            showNotification('Успешно', 'Объявление опубликовано в канале!', 'success');
            
            // Очищаем сохраненные данные
            localStorage.removeItem('lastFormData');
            localStorage.removeItem('lastFormError');
        }
        
        // Создать новое объявление
        function createNewAd() {
            // Сброс данных формы
            formData = {
                photos: [],
                description: '',
                price: '',
                contact_type: 'telegram',
                contacts: '',
                location: { type: 'none', address: 'Не указано' }
            };
            
            // Сброс полей формы
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('description').value = '';
            document.getElementById('price').value = '';
            document.getElementById('telegram').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('locationInput').value = '';
            
            // Показать первую форму
            document.getElementById('successScreen').style.display = 'none';
            document.getElementById('formContainer').style.display = 'block';
            
            // Вернуться к первому шагу
            currentStep = 1;
            showStep(1);
            updatePhotoCounter();
            selectContactType('telegram');
            
            // Очищаем уведомления об ошибках
            document.getElementById('errorToggle').style.display = 'none';
            document.getElementById('errorDetails').classList.remove('show');
        }
        
        // Вспомогательная функция debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Основная инициализация
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Инициализация Flower Market Web App...');
            
            setupEventListeners();
            updateProgressBar();
            updatePhotoCounter();
            
            // Проверяем соединение при загрузке
            checkConnection().then(isConnected => {
                if (!isConnected) {
                    showNotification('Внимание', 'Проверьте интернет-соединение', 'warning');
                }
            });
            
            // Проверяем наличие сохраненных данных
            restoreFormData();
            
            // Периодически проверяем соединение
            setInterval(checkConnection, 30000); // Каждые 30 секунд
            
            // Предупреждение при закрытии страницы с неотправленными данными
            window.addEventListener('beforeunload', function(e) {
                if (formData.description || formData.photos.length > 0) {
                    e.preventDefault();
                    e.returnValue = 'У вас есть неотправленные данные. Вы уверены, что хотите покинуть страницу?';
                }
            });
            
            console.log('Приложение инициализировано');
        });
    </script>
</body>
</html>