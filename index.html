<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flower Market - –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: env(safe-area-inset-bottom, 20px); }
        .header { text-align: center; color: white; margin-bottom: 30px; padding-top: env(safe-area-inset-top, 0); }
        .header h1 { font-size: 24px; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .form-container { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .form-step { display: none; animation-duration: 0.3s; animation-fill-mode: both; }
        .form-step.active { display: block; animation-name: fadeInUp; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .step-title { font-size: 20px; color: #333; margin-bottom: 25px; text-align: center; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 10px; color: #555; font-weight: 500; font-size: 15px; }
        .input-wrapper { position: relative; }
        input, textarea, select { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; font-family: inherit; transition: all 0.3s ease; background: #fff; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        textarea { min-height: 140px; resize: vertical; line-height: 1.5; }
        .input-hint { display: block; margin-top: 8px; color: #888; font-size: 13px; }
        .photo-upload { border: 3px dashed #667eea; border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: rgba(102, 126, 234, 0.05); }
        .photo-upload:hover, .photo-upload:active { background: rgba(102, 126, 234, 0.1); }
        .photo-upload-icon { font-size: 48px; color: #667eea; margin-bottom: 15px; display: block; }
        #photoInput { display: none; }
        #photoPreview { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px; }
        .photo-item { position: relative; width: 100px; height: 100px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
        .photo-item:hover { transform: scale(1.05); }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-photo { position: absolute; top: 6px; right: 6px; background: rgba(255, 59, 48, 0.9); color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.2s; border: 2px solid white; }
        .remove-photo:hover { background: rgba(255, 59, 48, 1); }
        .contact-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        @media (max-width: 480px) { .contact-options { grid-template-columns: 1fr; } }
        .contact-option { padding: 20px 15px; border: 2px solid #e0e0e0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #fff; }
        .contact-option:hover { border-color: #667eea; background: rgba(102, 126, 234, 0.05); }
        .contact-option.active { border-color: #667eea; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3); }
        .contact-option i { font-size: 28px; margin-bottom: 12px; display: block; }
        .contact-option p { font-size: 15px; font-weight: 500; margin-bottom: 5px; }
        .contact-option small { font-size: 12px; opacity: 0.8; }
        .location-map { width: 100%; height: 200px; border-radius: 12px; overflow: hidden; margin-bottom: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #667eea; border: 2px solid #e0e0e0; }
        .location-map i { font-size: 48px; margin-bottom: 10px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 30px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; position: relative; overflow: hidden; }
        .btn:after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%); opacity: 0; transition: opacity 0.3s; }
        .btn:hover:after, .btn:active:after { opacity: 1; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .btn:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn-secondary { background: #f0f0f0; color: #333; background-image: none; }
        .btn-secondary:hover { background: #e0e0e0; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .navigation { display: flex; gap: 15px; margin-top: 30px; }
        .navigation .btn { flex: 1; }
        .preview-item { background: rgba(102, 126, 234, 0.05); padding: 18px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #667eea; }
        .preview-label { font-weight: 600; color: #667eea; margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .preview-value { color: #333; font-size: 16px; line-height: 1.5; }
        .photos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .photo-preview { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .photo-more { display: flex; align-items: center; justify-content: center; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 20px; font-weight: bold; color: #667eea; }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .progress-bar:before { content: ''; position: absolute; top: 15px; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.3); z-index: 1; }
        .progress-step { position: relative; z-index: 2; text-align: center; flex: 1; }
        .step-number { width: 36px; height: 36px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; color: white; font-weight: 600; transition: all 0.3s; }
        .step-number.active { background: white; color: #667eea; box-shadow: 0 0 0 4px rgba(255,255,255,0.3); }
        .step-label { color: rgba(255,255,255,0.7); font-size: 12px; transition: color 0.3s; }
        .step-label.active { color: white; font-weight: 500; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; gap: 12px; transition: transform 0.4s ease; max-width: 90%; width: 400px; }
        .notification.show { transform: translateX(-50%) translateY(0); }
        .notification-icon { font-size: 22px; color: #ff3b30; }
        .notification.success .notification-icon { color: #34c759; }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 600; margin-bottom: 4px; color: #333; }
        .notification-message { color: #666; font-size: 14px; }
        .loader { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 600px) { body { padding: 15px; } .form-container { padding: 20px; border-radius: 16px; } .step-title { font-size: 18px; } .photo-item { width: 80px; height: 80px; } .btn { padding: 14px 20px; font-size: 15px; } }
        @media (max-width: 380px) { .photos-grid { grid-template-columns: repeat(2, 1fr); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .loading { animation: pulse 1.5s ease-in-out infinite; }
        .telegram-only { display: none; text-align: center; color: white; padding: 50px 20px; }
        .telegram-only h2 { font-size: 24px; margin-bottom: 20px; }
        .telegram-only p { font-size: 16px; margin-bottom: 30px; opacity: 0.9; }
        .telegram-btn { display: inline-block; background: white; color: #667eea; padding: 12px 30px; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 16px; transition: all 0.3s; }
        .telegram-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255,255,255,0.2); }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="telegram-only" id="telegramOnly">
        <h2><i class="fab fa-telegram"></i> –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram</h2>
        <p>–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram.<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.</p>
        <a href="https://t.me/FlowerMarket_KG_bot" class="telegram-btn"><i class="fab fa-telegram"></i> –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram</a>
        <p style="margin-top: 20px; font-size: 14px; opacity: 0.7;">–ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ ?test=1 –∫ URL –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="container">
            <div class="progress-bar" id="progressBar">
                <div class="progress-step"><div class="step-number active">1</div><div class="step-label active">–§–æ—Ç–æ</div></div>
                <div class="progress-step"><div class="step-number">2</div><div class="step-label">–û–ø–∏—Å–∞–Ω–∏–µ</div></div>
                <div class="progress-step"><div class="step-number">3</div><div class="step-label">–¶–µ–Ω–∞</div></div>
                <div class="progress-step"><div class="step-number">4</div><div class="step-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div></div>
                <div class="progress-step"><div class="step-number">5</div><div class="step-label">–õ–æ–∫–∞—Ü–∏—è</div></div>
                <div class="progress-step"><div class="step-number">6</div><div class="step-label">–ü—Ä–µ–≤—å—é</div></div>
            </div>
            
            <div class="header">
                <h1><i class="fas fa-flower-tulip"></i> Flower Market</h1>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –∫—Ä–∞—Å–∏–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–∞–∂–µ —Ü–≤–µ—Ç–æ–≤</p>
            </div>
        </div>

        <div class="notification" id="notification">
            <i class="fas fa-exclamation-circle notification-icon"></i>
            <div class="notification-content">
                <div class="notification-title" id="notificationTitle">–û—à–∏–±–∫–∞</div>
                <div class="notification-message" id="notificationMessage"></div>
            </div>
        </div>

        <div class="container">
            <div class="form-container">
                <div class="form-step active" id="step1">
                    <h2 class="step-title"><i class="fas fa-camera"></i> –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</h2>
                    <div class="form-group">
                        <div class="photo-upload" id="photoUpload" role="button" aria-label="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ">
                            <i class="fas fa-cloud-upload-alt photo-upload-icon"></i>
                            <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</p>
                            <p class="input-hint">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ 10 —Ñ–æ—Ç–æ (–º–∞–∫—Å–∏–º—É–º 5MB –∫–∞–∂–¥–æ–µ)</p>
                        </div>
                        <input type="file" id="photoInput" accept="image/*" multiple>
                        <div id="photoPreview"></div>
                    </div>
                    <div class="navigation"><button class="btn" onclick="nextStep()" id="nextBtn1">–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i></button></div>
                </div>
                
                <div class="form-step" id="step2">
                    <h2 class="step-title"><i class="fas fa-edit"></i> –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h2>
                    <div class="form-group">
                        <label for="description">–û–ø–∏—à–∏—Ç–µ –≤–∞—à —Ç–æ–≤–∞—Ä –ø–æ–¥—Ä–æ–±–Ω–æ:</label>
                        <textarea id="description" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–≤–µ–∂–∏–µ —Ä–æ–∑—ã –∏–∑ –≠–∫–≤–∞–¥–æ—Ä–∞, –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Å–≤–∞–¥–µ–±–Ω—ã—Ö –±—É–∫–µ—Ç–æ–≤. –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É."></textarea>
                        <p class="input-hint">–ú–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —É–∫–∞–∑–∞—Ç—å —Å–æ—Ä—Ç, —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏</p>
                    </div>
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                        <button class="btn" onclick="nextStep()" id="nextBtn2">–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <div class="form-step" id="step3">
                    <h2 class="step-title"><i class="fas fa-tag"></i> –£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É</h2>
                    <div class="form-group">
                        <label for="price">–¶–µ–Ω–∞ –≤ —Å–æ–º–∞—Ö:</label>
                        <input type="text" id="price" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1500 –∏–ª–∏ –î–æ–≥–æ–≤–æ—Ä–Ω–∞—è">
                        <p class="input-hint">–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω: 1000-1500, –∏–ª–∏ "–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è"</p>
                    </div>
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                        <button class="btn" onclick="nextStep()" id="nextBtn3">–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <div class="form-step" id="step4">
                    <h2 class="step-title"><i class="fas fa-phone"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏</h2>
                    <div class="contact-options">
                        <div class="contact-option active" id="telegramOption" onclick="selectContactType('telegram')" role="button">
                            <i class="fab fa-telegram"></i>
                            <p>Telegram</p>
                            <small>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π username</small>
                        </div>
                        <div class="contact-option" id="phoneOption" onclick="selectContactType('phone')" role="button">
                            <i class="fas fa-mobile-alt"></i>
                            <p>–¢–µ–ª–µ—Ñ–æ–Ω</p>
                            <small>–í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä</small>
                        </div>
                    </div>
                    <div class="form-group" id="phoneInputGroup" style="display: none;">
                        <label for="phone">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                        <input type="tel" id="phone" placeholder="+996 XXX XXX XXX" pattern="^\+996\d{9}$">
                        <p class="input-hint">–§–æ—Ä–º–∞—Ç: +996XXXYYYZZZ (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)</p>
                    </div>
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                        <button class="btn" onclick="nextStep()" id="nextBtn4">–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <div class="form-step" id="step5">
                    <h2 class="step-title"><i class="fas fa-map-marker-alt"></i> –õ–æ–∫–∞—Ü–∏—è</h2>
                    <div class="form-group">
                        <div class="location-map" id="map"><i class="fas fa-map"></i><p style="margin-top: 10px; font-size: 14px;">–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</p></div>
                        <label for="locationInput">–ê–¥—Ä–µ—Å –∏–ª–∏ —Ä–∞–π–æ–Ω:</label>
                        <input type="text" id="locationInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≥. –ë–∏—à–∫–µ–∫, —É–ª. –ß—É–π, 123">
                        <p class="input-hint" style="margin: 15px 0;">–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–∫—É—â—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é:</p>
                        <button class="btn btn-secondary" onclick="getCurrentLocation()" id="locationBtn"><i class="fas fa-location-crosshairs"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
                    </div>
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                        <button class="btn" onclick="nextStep()" id="nextBtn5">–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <div class="form-step" id="step6">
                    <h2 class="step-title"><i class="fas fa-eye"></i> –ü—Ä–µ–≤—å—é –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
                    
                    <div class="preview-item"><div class="preview-label">–§–æ—Ç–æ</div><div id="previewPhotos" class="photos-grid"></div></div>
                    <div class="preview-item"><div class="preview-label">–û–ø–∏—Å–∞–Ω–∏–µ</div><div class="preview-value" id="previewDescription"></div></div>
                    <div class="preview-item"><div class="preview-label">–¶–µ–Ω–∞</div><div class="preview-value" id="previewPrice"></div></div>
                    <div class="preview-item"><div class="preview-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div><div class="preview-value" id="previewContacts"></div></div>
                    <div class="preview-item"><div class="preview-label">–õ–æ–∫–∞—Ü–∏—è</div><div class="preview-value" id="previewLocation"></div></div>
                    <div class="preview-item"><div class="preview-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</div><div class="preview-value">50 —Å–æ–º</div></div>
                    
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                        <button class="btn" onclick="submitForm()" id="submitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å <i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tg = null;
        let isTelegramInitialized = false;
        let formData = { photos: [], description: '', price: '', contact_type: 'telegram', contacts: '', location: { type: 'none', address: '–ù–µ —É–∫–∞–∑–∞–Ω–æ' } };
        let currentStep = 1;
        const totalSteps = 6;
        const MAX_PHOTOS = 10;
        const MAX_PHOTO_SIZE = 5 * 1024 * 1024;
        
        function checkTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) return true;
            const userAgent = navigator.userAgent.toLowerCase();
            if (userAgent.includes('telegram') || userAgent.includes('webview')) return true;
            if (window.location.search.includes('tgWebAppData=') || window.location.hash.includes('tgWebAppData=')) return true;
            return false;
        }
        
        function initTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                isTelegramInitialized = true;
                tg.expand();
                tg.enableClosingConfirmation();
                tg.MainButton.hide();
                tg.BackButton.hide();
                console.log('Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return true;
            }
            return false;
        }
        
        function createTestTelegramStub() {
            window.Telegram = {
                WebApp: {
                    initDataUnsafe: {
                        user: {
                            id: Math.floor(Math.random() * 1000000000),
                            username: 'test_user_' + Math.floor(Math.random() * 1000),
                            first_name: '–¢–µ—Å—Ç–æ–≤—ã–π',
                            last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                            language_code: 'ru'
                        }
                    },
                    expand: function() { console.log('[TEST MODE] Telegram WebApp: expand()'); document.body.style.backgroundColor = '#667eea'; },
                    enableClosingConfirmation: function() { console.log('[TEST MODE] Telegram WebApp: enableClosingConfirmation()'); },
                    MainButton: {
                        hide: function() { console.log('[TEST MODE] MainButton: hide()'); },
                        show: function() { console.log('[TEST MODE] MainButton: show()'); },
                        showProgress: function() { console.log('[TEST MODE] MainButton: showProgress()'); },
                        hideProgress: function() { console.log('[TEST MODE] MainButton: hideProgress()'); },
                        setText: function(text) { console.log('[TEST MODE] MainButton: setText("' + text + '")'); },
                        onClick: function(callback) { console.log('[TEST MODE] MainButton: onClick()'); this._clickCallback = callback; },
                        offClick: function() { console.log('[TEST MODE] MainButton: offClick()'); delete this._clickCallback; },
                        _clickCallback: null
                    },
                    BackButton: {
                        hide: function() { console.log('[TEST MODE] BackButton: hide()'); },
                        show: function() { console.log('[TEST MODE] BackButton: show()'); },
                        onClick: function(callback) { console.log('[TEST MODE] BackButton: onClick()'); this._clickCallback = callback; },
                        offClick: function() { console.log('[TEST MODE] BackButton: offClick()'); delete this._clickCallback; },
                        _clickCallback: null
                    },
                    sendData: function(data) {
                        console.log('[TEST MODE] Telegram WebApp: sendData()', JSON.parse(data));
                        showNotification('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º', '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç–∞! –í —Ä–µ–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –æ–Ω–∏ –±—ã–ª–∏ –±—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram.', 'success');
                        setTimeout(() => {
                            alert('–î–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –±—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É:\n\n' + JSON.stringify(JSON.parse(data), null, 2));
                        }, 1000);
                    },
                    close: function() {
                        console.log('[TEST MODE] Telegram WebApp: close()');
                        showNotification('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º', '–í —Ä–µ–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—ã–ª–æ –±—ã –∑–∞–∫—Ä—ã—Ç–æ', 'info');
                    },
                    showAlert: function(message) { alert('[Telegram Alert] ' + message); },
                    showConfirm: function(message, callback) { const result = confirm('[Telegram Confirm] ' + message); if (callback) callback(result); }
                }
            };
            tg = window.Telegram.WebApp;
            isTelegramInitialized = true;
            console.log('–°–æ–∑–¥–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥–ª—É—à–∫–∞ Telegram Web App');
        }
        
        function initApp() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram:', user);
                if (user.username) {
                    formData.contacts = `@${user.username}`;
                    console.log('Telegram username –æ–±–Ω–∞—Ä—É–∂–µ–Ω:', user.username);
                    const firstName = user.first_name || '';
                    const lastName = user.last_name || '';
                    const fullName = `${firstName} ${lastName}`.trim();
                    if (fullName) showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', `–ü—Ä–∏–≤–µ—Ç, ${fullName}!`, 'info');
                } else {
                    console.warn('–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç username –≤ Telegram');
                    showNotification('–í–Ω–∏–º–∞–Ω–∏–µ', '–£ –≤–∞—Å –Ω–µ—Ç username –≤ Telegram. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ username –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Telegram.', 'warning');
                    selectContactType('phone');
                }
            } else console.warn('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã');
            if (tg && tg.BackButton) tg.BackButton.onClick(handleTelegramBack);
            selectContactType('telegram');
        }
        
        function setupEventListeners() {
            console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π...');
            document.getElementById('photoUpload').addEventListener('click', () => document.getElementById('photoInput').click());
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
            document.getElementById('description').addEventListener('input', debounce(() => formData.description = document.getElementById('description').value, 500));
            document.getElementById('price').addEventListener('input', debounce(() => formData.price = document.getElementById('price').value, 300));
            document.getElementById('phone').addEventListener('input', debounce(() => { if (formData.contact_type === 'phone') formData.contacts = document.getElementById('phone').value; }, 300));
            document.getElementById('locationInput').addEventListener('input', debounce(() => { const value = document.getElementById('locationInput').value; if (value) formData.location = { type: 'address', address: value }; }, 500));
            document.getElementById('description').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey && currentStep === 2) { e.preventDefault(); nextStep(); } });
            document.getElementById('price').addEventListener('keydown', (e) => { if (e.key === 'Enter' && currentStep === 3) { e.preventDefault(); nextStep(); } });
            document.getElementById('phone').addEventListener('keydown', (e) => { if (e.key === 'Enter' && currentStep === 4 && formData.contact_type === 'phone') { e.preventDefault(); nextStep(); } });
            document.getElementById('locationInput').addEventListener('keydown', (e) => { if (e.key === 'Enter' && currentStep === 5) { e.preventDefault(); nextStep(); } });
            let touchStartX = 0; let touchEndX = 0;
            document.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
            document.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); });
            function handleSwipe() { const swipeThreshold = 50; const diff = touchStartX - touchEndX; if (Math.abs(diff) > swipeThreshold) { if (diff > 0 && currentStep < totalSteps) nextStep(); else if (diff < 0 && currentStep > 1) prevStep(); } }
        }
        
        function handleTelegramBack() {
            console.log('Telegram BackButton –Ω–∞–∂–∞—Ç–∞');
            if (currentStep > 1) prevStep();
            else { if (tg && tg.close) tg.close(); else showNotification('–í—ã—Ö–æ–¥', '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ', 'info'); }
        }
        
        function showNotification(title, message, type = 'error') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            const icon = notification.querySelector('.notification-icon');
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notification.className = 'notification';
            if (type === 'success') { notification.classList.add('success'); icon.className = 'fas fa-check-circle notification-icon'; }
            else if (type === 'warning') { icon.className = 'fas fa-exclamation-triangle notification-icon'; }
            else if (type === 'info') { icon.className = 'fas fa-info-circle notification-icon'; }
            else { icon.className = 'fas fa-exclamation-circle notification-icon'; }
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 4000);
        }
        
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            const preview = document.getElementById('photoPreview');
            const currentCount = formData.photos.length;
            if (currentCount + files.length > MAX_PHOTOS) { showNotification('–û—à–∏–±–∫–∞', `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ: ${MAX_PHOTOS}. –£ –≤–∞—Å —É–∂–µ ${currentCount} —Ñ–æ—Ç–æ.`); event.target.value = ''; return; }
            files.forEach(file => {
                if (file.size > MAX_PHOTO_SIZE) { showNotification('–û—à–∏–±–∫–∞', `–§–æ—Ç–æ "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (${(file.size/1024/1024).toFixed(1)}MB). –ú–∞–∫—Å–∏–º—É–º 5MB.`); return; }
                if (!file.type.startsWith('image/')) { showNotification('–û—à–∏–±–∫–∞', `–§–∞–π–ª "${file.name}" –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º.`); return; }
                const reader = new FileReader();
                reader.onload = function(e) {
                    formData.photos.push(e.target.result);
                    createPhotoPreview(e.target.result, formData.photos.length - 1);
                    updatePhotoCounter();
                    console.log(`–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${file.name} (${(file.size/1024).toFixed(0)}KB)`);
                };
                reader.onerror = function() { showNotification('–û—à–∏–±–∫–∞', `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ "${file.name}"`); };
                reader.readAsDataURL(file);
            });
            event.target.value = '';
        }
        
        function createPhotoPreview(dataUrl, index) {
            const preview = document.getElementById('photoPreview');
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            photoItem.setAttribute('data-index', index);
            const img = document.createElement('img');
            img.src = dataUrl;
            img.alt = `–§–æ—Ç–æ ${index + 1}`;
            img.loading = 'lazy';
            const removeBtn = document.createElement('div');
            removeBtn.className = 'remove-photo';
            removeBtn.innerHTML = '√ó';
            removeBtn.setAttribute('aria-label', '–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ');
            removeBtn.onclick = (e) => { e.stopPropagation(); removePhoto(index); };
            photoItem.appendChild(img);
            photoItem.appendChild(removeBtn);
            preview.appendChild(photoItem);
        }
        
        function removePhoto(index) { formData.photos.splice(index, 1); updatePhotoPreview(); updatePhotoCounter(); console.log(`–§–æ—Ç–æ ${index + 1} —É–¥–∞–ª–µ–Ω–æ`); }
        
        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            formData.photos.forEach((photo, index) => createPhotoPreview(photo, index));
        }
        
        function updatePhotoCounter() {
            const photoUpload = document.getElementById('photoUpload');
            const photoCount = formData.photos.length;
            if (photoCount > 0) photoUpload.innerHTML = `<i class="fas fa-check-circle photo-upload-icon" style="color: #34c759;"></i><p>–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${photoCount}</p><p class="input-hint">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ ${MAX_PHOTOS - photoCount} —Ñ–æ—Ç–æ</p>`;
            else photoUpload.innerHTML = `<i class="fas fa-cloud-upload-alt photo-upload-icon"></i><p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</p><p class="input-hint">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ ${MAX_PHOTOS} —Ñ–æ—Ç–æ (–º–∞–∫—Å–∏–º—É–º 5MB –∫–∞–∂–¥–æ–µ)</p>`;
        }
        
        function showStep(step) {
            console.log(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É ${step} –∏–∑ ${currentStep}`);
            saveCurrentStepData();
            for (let i = 1; i <= totalSteps; i++) { const stepElement = document.getElementById(`step${i}`); if (stepElement) stepElement.classList.remove('active'); }
            const currentStepElement = document.getElementById(`step${step}`);
            if (currentStepElement) currentStepElement.classList.add('active');
            currentStep = step;
            updateProgressBar();
            updateTelegramButtons();
            if (step === 6) updatePreview();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(() => { const firstInput = currentStepElement.querySelector('input, textarea'); if (firstInput && currentStep !== 1) firstInput.focus(); }, 300);
        }
        
        function nextStep() {
            console.log(`–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ —Å ${currentStep}`);
            if (!validateStep(currentStep)) return;
            if (currentStep < totalSteps) showStep(currentStep + 1);
        }
        
        function prevStep() {
            console.log(`–ü—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥ —Å ${currentStep}`);
            if (currentStep > 1) showStep(currentStep - 1);
        }
        
        function saveCurrentStepData() {
            switch(currentStep) {
                case 1: break;
                case 2: formData.description = document.getElementById('description').value.trim(); break;
                case 3: formData.price = document.getElementById('price').value.trim(); break;
                case 4: if (formData.contact_type === 'phone') formData.contacts = document.getElementById('phone').value.trim(); break;
                case 5: const locationInput = document.getElementById('locationInput').value.trim(); if (locationInput) formData.location = { type: 'address', address: locationInput }; break;
            }
            console.log('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è —à–∞–≥–∞', currentStep, formData);
        }
        
        function validateStep(step) {
            console.log(`–í–∞–ª–∏–¥–∞—Ü–∏—è —à–∞–≥–∞ ${step}`);
            switch(step) {
                case 1: if (formData.photos.length === 0) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ'); return false; } break;
                case 2: const description = document.getElementById('description').value.trim(); if (!description) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞'); document.getElementById('description').focus(); return false; } if (description.length < 10) { showNotification('–û—à–∏–±–∫–∞', '–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤'); document.getElementById('description').focus(); return false; } formData.description = description; break;
                case 3: const price = document.getElementById('price').value.trim(); if (!price) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É'); document.getElementById('price').focus(); return false; } formData.price = price; break;
                case 4: if (formData.contact_type === 'phone') { const phone = document.getElementById('phone').value.trim(); const phoneRegex = /^\+996\d{9}$/; if (!phone) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞'); document.getElementById('phone').focus(); return false; } if (!phoneRegex.test(phone)) { showNotification('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ +996XXXXXXXXX'); document.getElementById('phone').focus(); return false; } formData.contacts = phone; } break;
                case 5: const locationInput = document.getElementById('locationInput').value.trim(); if (locationInput) { formData.location = { type: 'address', address: locationInput }; } else if (!formData.location.address || formData.location.address === '–ù–µ —É–∫–∞–∑–∞–Ω–æ') { formData.location = { type: 'none', address: '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }; } break;
            }
            return true;
        }
        
        function selectContactType(type) {
            console.log(`–í—ã–±—Ä–∞–Ω —Ç–∏–ø –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤: ${type}`);
            formData.contact_type = type;
            document.getElementById('telegramOption').classList.remove('active');
            document.getElementById('phoneOption').classList.remove('active');
            document.getElementById(`${type}Option`).classList.add('active');
            const phoneInputGroup = document.getElementById('phoneInputGroup');
            phoneInputGroup.style.display = type === 'phone' ? 'block' : 'none';
            if (type === 'telegram' && tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const username = tg.initDataUnsafe.user.username;
                if (username) formData.contacts = `@${username}`;
                else { showNotification('–í–Ω–∏–º–∞–Ω–∏–µ', '–£ –≤–∞—Å –Ω–µ—Ç username –≤ Telegram. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ username –≤ Telegram.', 'warning'); setTimeout(() => selectContactType('phone'), 2000); }
            }
        }
        
        async function getCurrentLocation() {
            const locationBtn = document.getElementById('locationBtn');
            const originalText = locationBtn.innerHTML;
            locationBtn.innerHTML = '<div class="loader"></div> –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...';
            locationBtn.disabled = true;
            if (!navigator.geolocation) { showNotification('–û—à–∏–±–∫–∞', '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é'); resetLocationButton(locationBtn, originalText); return; }
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    console.log(`–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞: ${lat}, ${lng}`);
                    formData.location = { type: 'coordinates', latitude: lat, longitude: lng, address: '' };
                    try {
                        const address = await getAddressFromCoords(lat, lng);
                        if (address) { formData.location.address = address; document.getElementById('locationInput').value = address; locationBtn.innerHTML = '<i class="fas fa-check"></i> –ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'; showNotification('–£—Å–ø–µ—à–Ω–æ', '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ', 'success'); }
                        else { locationBtn.innerHTML = '<i class="fas fa-check"></i> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã'; document.getElementById('locationInput').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`; formData.location.address = `${lat.toFixed(6)}, ${lng.toFixed(6)}`; showNotification('–£—Å–ø–µ—à–Ω–æ', '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã', 'success'); }
                    } catch (error) { console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', error); locationBtn.innerHTML = '<i class="fas fa-check"></i> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã'; document.getElementById('locationInput').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`; formData.location.address = `${lat.toFixed(6)}, ${lng.toFixed(6)}`; showNotification('–£—Å–ø–µ—à–Ω–æ', '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã', 'success'); }
                    setTimeout(() => resetLocationButton(locationBtn, originalText), 2000);
                },
                function(error) {
                    let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED: errorMessage = '–í—ã –æ—Ç–∫–∞–∑–∞–ª–∏ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.'; break;
                        case error.POSITION_UNAVAILABLE: errorMessage = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.'; break;
                        case error.TIMEOUT: errorMessage = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'; break;
                    }
                    showNotification('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏', errorMessage);
                    resetLocationButton(locationBtn, originalText);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        function resetLocationButton(button, originalText) {
            setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 1000);
        }
        
        async function getAddressFromCoords(lat, lng) {
            try {
                console.log(`–ó–∞–ø—Ä–æ—Å –∞–¥—Ä–µ—Å–∞ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: ${lat}, ${lng}`);
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, { headers: { 'User-Agent': 'FlowerMarketBot/1.0', 'Accept-Language': 'ru,en-US;q=0.9,en;q=0.8' } });
                if (!response.ok) throw new Error(`HTTP –æ—à–∏–±–∫–∞! —Å—Ç–∞—Ç—É—Å: ${response.status}`);
                const data = await response.json();
                if (data.display_name) {
                    const addressParts = data.display_name.split(',');
                    if (addressParts.length > 3) return addressParts.slice(0, 3).join(', ');
                    return data.display_name;
                }
                return null;
            } catch (error) { console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', error); return null; }
        }
        
        function updatePreview() {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é');
            const previewPhotos = document.getElementById('previewPhotos');
            previewPhotos.innerHTML = '';
            const photosToShow = formData.photos.slice(0, 6);
            photosToShow.forEach((photo, index) => {
                const img = document.createElement('img');
                img.className = 'photo-preview';
                img.src = photo;
                img.alt = `–§–æ—Ç–æ ${index + 1}`;
                img.loading = 'lazy';
                previewPhotos.appendChild(img);
            });
            if (formData.photos.length > 6) {
                const moreCount = document.createElement('div');
                moreCount.className = 'photo-preview photo-more';
                moreCount.textContent = `+${formData.photos.length - 6}`;
                previewPhotos.appendChild(moreCount);
            }
            document.getElementById('previewDescription').textContent = formData.description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            document.getElementById('previewPrice').textContent = formData.price || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            let contactsText = '';
            if (formData.contact_type === 'telegram') contactsText = `Telegram: ${formData.contacts || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}`;
            else contactsText = `–¢–µ–ª–µ—Ñ–æ–Ω: ${formData.contacts || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}`;
            document.getElementById('previewContacts').textContent = contactsText;
            let locationText = '';
            if (formData.location.type === 'coordinates') locationText = `üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: ${formData.location.address || '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã'}`;
            else if (formData.location.type === 'address') locationText = `üìç –ê–¥—Ä–µ—Å: ${formData.location.address}`;
            else locationText = 'üìç –ù–µ —É–∫–∞–∑–∞–Ω–∞';
            document.getElementById('previewLocation').textContent = locationText;
        }
        
        function updateProgressBar() {
            const stepNumbers = document.querySelectorAll('.step-number');
            const stepLabels = document.querySelectorAll('.step-label');
            stepNumbers.forEach((number, index) => { if (index + 1 === currentStep) number.classList.add('active'); else number.classList.remove('active'); });
            stepLabels.forEach((label, index) => { if (index + 1 <= currentStep) label.classList.add('active'); else label.classList.remove('active'); });
        }
        
        function updateTelegramButtons() {
            if (!tg) return;
            if (currentStep > 1) tg.BackButton.show(); else tg.BackButton.hide();
            if (currentStep === totalSteps) { tg.MainButton.setText("–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ"); tg.MainButton.onClick(submitForm); tg.MainButton.show(); }
            else { tg.MainButton.hide(); tg.MainButton.offClick(submitForm); }
        }
        
        async function submitForm() {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã...');
            if (!validateStep(currentStep)) return;
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loader"></div> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            submitBtn.disabled = true;
            try {
                if (!formData.description || !formData.price || !formData.contacts) throw new Error('–ù–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã');
                const finalData = {
                    photos: formData.photos,
                    description: formData.description.trim(),
                    price: formData.price.trim(),
                    contact_type: formData.contact_type,
                    contacts: formData.contacts.trim(),
                    location: formData.location,
                    timestamp: new Date().toISOString(),
                    action: 'create_advertisement'
                };
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    finalData.user_id = tg.initDataUnsafe.user.id;
                    finalData.username = tg.initDataUnsafe.user.username || '';
                    finalData.first_name = tg.initDataUnsafe.user.first_name || '';
                    finalData.last_name = tg.initDataUnsafe.user.last_name || '';
                }
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', finalData);
                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify(finalData));
                    showNotification('–£—Å–ø–µ—à–Ω–æ', '–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É! –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞.', 'success');
                    setTimeout(() => {
                        submitBtn.innerHTML = '<i class="fas fa-check"></i> –ì–æ—Ç–æ–≤–æ! –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –±–æ—Ç–∞';
                        submitBtn.disabled = false;
                        submitBtn.onclick = () => { if (tg && tg.close) tg.close(); };
                        const previewContainer = document.querySelector('.form-container');
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'preview-item';
                        infoDiv.style.marginTop = '20px';
                        infoDiv.style.textAlign = 'center';
                        infoDiv.innerHTML = `<div class="preview-label">–ß—Ç–æ –¥–∞–ª—å—à–µ?</div><div class="preview-value"><p>1. –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</p><p>2. –í—ã –ø–æ–ª—É—á–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º</p><p>3. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</p><p style="margin-top: 15px; color: #667eea; font-weight: bold;"><i class="fas fa-info-circle"></i> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∞—Ç —Å –±–æ—Ç–æ–º –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π</p></div>`;
                        previewContainer.appendChild(infoDiv);
                    }, 1500);
                } else {
                    console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', finalData);
                    showNotification('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º', '–í —Ä–µ–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –±—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.', 'info');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
            console.log('User Agent:', navigator.userAgent);
            console.log('URL:', window.location.href);
            const urlParams = new URLSearchParams(window.location.search);
            const isTestMode = urlParams.get('test') === '1';
            const isForceMode = urlParams.get('force') === '1';
            const isTelegram = checkTelegramWebApp();
            if (isTelegram || isTestMode || isForceMode) {
                document.getElementById('telegramOnly').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                let telegramInitialized = initTelegramWebApp();
                if (!telegramInitialized && (isTestMode || isForceMode)) {
                    console.log('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                    createTestTelegramStub();
                    telegramInitialized = true;
                }
                setTimeout(() => {
                    if (telegramInitialized) {
                        initApp();
                        setupEventListeners();
                        updateProgressBar();
                        updateTelegramButtons();
                        console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                        if (isTestMode) showNotification('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º', '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ. –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram.', 'info');
                    } else {
                        console.warn('Telegram Web App –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–æ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–∫–∞–∑–∞–Ω');
                        initApp();
                        setupEventListeners();
                        updateProgressBar();
                    }
                }, 300);
            } else {
                document.getElementById('telegramOnly').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                console.warn('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ —á–µ—Ä–µ–∑ Telegram Web App');
            }
        });
    </script>
</body>
</html>