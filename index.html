<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flower Market - Создать объявление</title>
    <style>
        /* === ВСЁ ОРИГИНАЛЬНОЕ СТИЛЕВОЕ ОПИСАНИЕ === */
        /* Основные стили */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: env(safe-area-inset-bottom, 20px); position: relative; z-index: 2; }
        .header { text-align: center; color: white; margin-bottom: 30px; padding-top: env(safe-area-inset-top, 0); position: relative; z-index: 2; }
        .header h1 { font-size: 24px; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .form-container { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 20px; position: relative; z-index: 2; }
        .form-step { display: none; animation-duration: 0.3s; animation-fill-mode: both; position: relative; z-index: 2; }
        .form-step.active { display: block; animation-name: fadeInUp; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .step-title { font-size: 20px; color: #333; margin-bottom: 25px; text-align: center; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; position: relative; z-index: 2; }
        .form-group { margin-bottom: 25px; position: relative; z-index: 2; }
        label { display: block; margin-bottom: 10px; color: #555; font-weight: 500; font-size: 15px; position: relative; z-index: 2; }
        input, textarea, select { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; font-family: inherit; transition: all 0.3s ease; background: #fff; position: relative; z-index: 2; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        textarea { min-height: 140px; resize: vertical; line-height: 1.5; position: relative; z-index: 2; }
        .input-hint { display: block; margin-top: 8px; color: #888; font-size: 13px; position: relative; z-index: 2; }
        .photo-upload { border: 3px dashed #667eea; border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: rgba(102, 126, 234, 0.05); position: relative; z-index: 2; }
        .photo-upload:hover, .photo-upload:active { background: rgba(102, 126, 234, 0.1); }
        .photo-upload-icon { font-size: 48px; color: #667eea; margin-bottom: 15px; display: block; }
        #photoInput { display: none; }
        #photoPreview { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px; position: relative; z-index: 2; }
        .photo-item { position: relative; width: 100px; height: 100px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s ease; position: relative; z-index: 2; }
        .photo-item:hover { transform: scale(1.05); }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-photo { position: absolute; top: 6px; right: 6px; background: rgba(255, 59, 48, 0.9); color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.2s; border: 2px solid white; position: relative; z-index: 3; }
        .remove-photo:hover { background: rgba(255, 59, 48, 1); }
        .contact-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; position: relative; z-index: 2; }
        @media (max-width: 480px) { .contact-options { grid-template-columns: 1fr; } }
        .contact-option { padding: 20px 15px; border: 2px solid #e0e0e0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #fff; position: relative; z-index: 2; }
        .contact-option:hover { border-color: #667eea; background: rgba(102, 126, 234, 0.05); }
        .contact-option.active { border-color: #667eea; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3); }
        .contact-option i { font-size: 28px; margin-bottom: 12px; display: block; }
        .contact-option p { font-size: 15px; font-weight: 500; margin-bottom: 5px; }
        .contact-option small { font-size: 12px; opacity: 0.8; }
        .location-map { width: 100%; height: 300px; border-radius: 12px; overflow: hidden; margin-bottom: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #667eea; border: 2px solid #e0e0e0; position: relative; z-index: 2; }
        .location-map i { font-size: 48px; margin-bottom: 10px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 30px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; position: relative; z-index: 2; overflow: hidden; }
        .btn:after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%); opacity: 0; transition: opacity 0.3s; }
        .btn:hover:after, .btn:active:after { opacity: 1; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .btn:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; background: linear-gradient(135deg, #a0aec0 0%, #718096 100%); }
        .btn:disabled:hover { transform: none !important; box-shadow: none !important; }
        .btn:disabled:after { opacity: 0; }
        .btn-secondary { background: #f0f0f0; color: #333; background-image: none; }
        .btn-secondary:hover { background: #e0e0e0; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .navigation { display: flex; gap: 15px; margin-top: 30px; position: relative; z-index: 2; }
        .navigation .btn { flex: 1; }
        .preview-item { background: rgba(102, 126, 234, 0.05); padding: 18px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #667eea; position: relative; z-index: 2; }
        .preview-label { font-weight: 600; color: #667eea; margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .preview-value { color: #333; font-size: 16px; line-height: 1.5; }
        .photos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; position: relative; z-index: 2; }
        .photo-preview { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .photo-more { display: flex; align-items: center; justify-content: center; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 20px; font-weight: bold; color: #667eea; }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; z-index: 2; }
        .progress-bar:before { content: ''; position: absolute; top: 15px; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.3); z-index: 1; }
        .progress-step { position: relative; z-index: 2; text-align: center; flex: 1; }
        .step-number { width: 36px; height: 36px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; color: white; font-weight: 600; transition: all 0.3s; }
        .step-number.active { background: white; color: #667eea; box-shadow: 0 0 0 4px rgba(255,255,255,0.3); }
        .step-label { color: rgba(255,255,255,0.7); font-size: 12px; transition: color 0.3s; }
        .step-label.active { color: white; font-weight: 500; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; gap: 12px; transition: transform 0.4s ease; max-width: 90%; width: 400px; }
        .notification.show { transform: translateX(-50%) translateY(0); }
        .notification-icon { font-size: 22px; color: #ff3b30; }
        .notification.success .notification-icon { color: #34c759; }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 600; margin-bottom: 4px; color: #333; }
        .notification-message { color: #666; font-size: 14px; }
        .loader { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .success-screen { text-align: center; padding: 40px 20px; animation: fadeIn 0.5s ease; position: relative; z-index: 2; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .success-icon { font-size: 80px; color: #34c759; margin-bottom: 25px; animation: bounce 1s ease infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .success-title { font-size: 28px; color: #333; margin-bottom: 15px; font-weight: 600; }
        .success-message { color: #666; line-height: 1.6; margin-bottom: 30px; font-size: 16px; }
        .success-steps { background: rgba(102, 126, 234, 0.05); border-radius: 12px; padding: 20px; margin: 30px 0; text-align: left; position: relative; z-index: 2; }
        .success-step { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .success-step:last-child { margin-bottom: 0; }
        .step-badge { background: #667eea; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; flex-shrink: 0; }
        .step-text { flex: 1; color: #555; }
        .telegram-info { background: linear-gradient(135deg, #0088cc 0%, #34aadc 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; display: none; }
        .telegram-info.show { display: block; animation: fadeIn 0.5s ease; }
        .telegram-info p { margin: 5px 0; }
        .telegram-info i { font-size: 24px; margin-bottom: 10px; display: block; }
        .close-telegram-btn { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; margin-top: 10px; display: inline-block; font-size: 14px; }
        .channel-link { display: inline-block; background: white; color: #0088cc; padding: 8px 16px; border-radius: 20px; text-decoration: none; margin-top: 10px; font-weight: bold; }
        .server-url { position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 8px; font-size: 12px; z-index: 999; font-family: monospace; }

        /* Стили для карты в стиле 2GIS */
        .map-container { width: 100%; height: 300px; border-radius: 12px; overflow: hidden; margin-bottom: 20px; border: 2px solid #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; z-index: 2; }
        .map-controls { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .map-btn { background: white; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 16px; color: #333; transition: all 0.3s; z-index: 1000; }
        .map-btn:hover { background: #f5f5f5; transform: scale(1.05); }
        .map-btn.active { background: #667eea; color: white; }
        .map-search-container { position: absolute; top: 10px; left: 10px; right: 50px; z-index: 1000; }
        .map-search { width: 100%; padding: 10px 40px 10px 15px; border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 14px; z-index: 1000; }
        .map-search:focus { outline: none; box-shadow: 0 2px 12px rgba(0,0,0,0.2); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #667eea; }
        .location-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 500; color: #ff3b30; font-size: 32px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); pointer-events: none; }
        .map-address-display { position: absolute; bottom: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 10px 15px; border-radius: 8px; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000; }
        .map-layer-controls { position: absolute; bottom: 50px; right: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .layer-btn { background: rgba(255,255,255,0.9); border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s; z-index: 1000; }
        .layer-btn:hover { background: white; }
        .layer-btn.active { background: #667eea; color: white; border-color: #667eea; }

        /* Petal layer - ИСПРАВЛЕННЫЕ СТИЛИ */
        #petalLayer { 
            pointer-events: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            z-index: 1; /* Уменьшен z-index чтобы был под формой */
            overflow: hidden; 
        }
        .petal { 
            position: absolute; 
            top: -50px; 
            will-change: transform, opacity; 
            user-select: none;
            -webkit-user-select: none;
            z-index: 1; /* Лепестки под всеми элементами формы */
        }
        @keyframes petalFall {
            0% { 
                transform: translateY(0) rotate(0deg); 
                opacity: 0.6; /* Уменьшена прозрачность */
            }
            10% { 
                opacity: 0.8; /* Уменьшена прозрачность */
            }
            100% { 
                transform: translateY(110vh) rotate(360deg); /* Уменьшено вращение */
                opacity: 0.1; /* Сильно уменьшена прозрачность в конце */
            }
        }

        /* Новые стили для выбора региона и города */
        .location-select-group { display: flex; gap: 15px; margin-bottom: 20px; }
        .location-select-group .form-group { flex: 1; margin-bottom: 0; }
        .location-select-group label { margin-bottom: 8px; font-size: 14px; }
        .location-select-group select { padding: 12px 14px; font-size: 15px; }
        .auto-location-btn { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .auto-location-btn i { font-size: 14px; }

        /* Стиль для индикатора заполнения */
        .field-required { position: relative; }
        .field-required:after { content: '*'; color: #ff3b30; margin-left: 4px; }
        .field-hint { color: #ff6b6b; font-size: 13px; margin-top: 5px; display: none; }
        .field-hint.show { display: block; }

        @media (max-width: 600px) {
            body { padding: 15px; }
            .form-container { padding: 20px; border-radius: 16px; }
            .step-title { font-size: 18px; }
            .photo-item { width: 80px; height: 80px; }
            .btn { padding: 14px 20px; font-size: 15px; }
            .server-url { display: none; }
            .map-container { height: 250px; }
            .map-controls { top: 5px; right: 5px; }
            .map-btn { width: 32px; height: 32px; font-size: 14px; }
            .location-select-group { flex-direction: column; gap: 10px; }
        }
        @media (max-width: 380px) { .photos-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js?1"></script>
</head>
<body>
  <!-- слой лепестков -->
  <div id="petalLayer" aria-hidden="true"></div>

  <div class="container">
    <div class="progress-bar" id="progressBar">
        <div class="progress-step"><div class="step-number active">1</div><div class="step-label active">Фото</div></div>
        <div class="progress-step"><div class="step-number">2</div><div class="step-label">Описание</div></div>
        <div class="progress-step"><div class="step-number">3</div><div class="step-label">Цена</div></div>
        <div class="progress-step"><div class="step-number">4</div><div class="step-label">Контакты</div></div>
        <div class="progress-step"><div class="step-number">5</div><div class="step-label">Локация</div></div>
        <div class="progress-step"><div class="step-number">6</div><div class="step-label">Превью</div></div>
    </div>

    <div class="header">
        <h1><i class="fas fa-flower-tulip"></i> Flower Market Kyrgyzstan</h1>
        <p>Создайте красивое объявление о продаже цветов</p>
    </div>
  </div>


  <div class="notification" id="notification">
      <i class="fas fa-exclamation-circle notification-icon"></i>
      <div class="notification-content">
          <div class="notification-title" id="notificationTitle">Ошибка</div>
          <div class="notification-message" id="notificationMessage"></div>
      </div>
  </div>

  <div class="container">
    <div class="form-container" id="formContainer">
      <!-- Шаг 1 -->
      <div class="form-step active" id="step1">
          <h2 class="step-title"><i class="fas fa-camera"></i> Загрузите фото</h2>
          <div class="form-group">
              <div class="photo-upload" id="photoUpload" role="button" aria-label="Загрузить фото">
                  <i class="fas fa-cloud-upload-alt photo-upload-icon"></i>
                  <p>Нажмите для загрузки фото</p>
                  <p class="input-hint">Можно загрузить до 10 фото</p>
                  <div id="photoHint" class="field-hint">Загрузите хотя бы одно фото для продолжения</div>
              </div>
              <input type="file" id="photoInput" accept="image/*" multiple>
              <div id="photoPreview"></div>
          </div>
          <div class="navigation">
              <button class="btn" onclick="nextStep()" id="nextBtn1" disabled>Далее <i class="fas fa-arrow-right"></i></button>
          </div>
      </div>

      <!-- Шаг 2 -->
      <div class="form-step" id="step2">
          <h2 class="step-title"><i class="fas fa-edit"></i> Описание товара</h2>
          <div class="form-group">
              <label for="description" class="field-required">Опишите ваш товар:</label>
              <textarea id="description" placeholder="Например: Свежие розы из Эквадора, идеально подходят для свадебных букетов. Доставка по городу."></textarea>
              <p class="input-hint">Минимум 3 символа. Опишите ваши цветы подробно</p>
              <div id="descriptionHint" class="field-hint">Описание должно содержать минимум 3 символа</div>
          </div>
          <div class="navigation">
              <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
              <button class="btn" onclick="nextStep()" id="nextBtn2" disabled>Далее <i class="fas fa-arrow-right"></i></button>
          </div>
      </div>

      <!-- Шаг 3 -->
      <div class="form-step" id="step3">
          <h2 class="step-title"><i class="fas fa-tag"></i> Укажите цену</h2>
          <div class="form-group">
              <label for="price" class="field-required">Цена в сомах:</label>
              <input type="text" id="price" placeholder="Например: 1500 или Договорная">
              <p class="input-hint">Можно указать диапазон: 1000-1500, или "Договорная"</p>
              <div id="priceHint" class="field-hint">Укажите цену для продолжения</div>
          </div>
          <div class="navigation">
              <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
              <button class="btn" onclick="nextStep()" id="nextBtn3" disabled>Далее <i class="fas fa-arrow-right"></i></button>
          </div>
      </div>

      <!-- Шаг 4 -->
      <div class="form-step" id="step4">
          <h2 class="step-title"><i class="fas fa-phone"></i> Контакты для связи</h2>
          <div class="contact-options">
              <div class="contact-option active" id="telegramOption" onclick="selectContactType('telegram')" role="button">
                  <i class="fab fa-telegram"></i>
                  <p>Telegram</p>
                  <small>Ввести username</small>
              </div>
              <div class="contact-option" id="phoneOption" onclick="selectContactType('phone')" role="button">
                  <i class="fas fa-mobile-alt"></i>
                  <p>Телефон</p>
                  <small>Ввести номер</small>
              </div>
          </div>
          <div class="form-group" id="telegramInputGroup">
              <label for="telegram" class="field-required">Введите Telegram username:</label>
              <input type="text" id="telegram" placeholder="@username">
              <p class="input-hint">Например: @username (без пробелов)</p>
              <div id="telegramHint" class="field-hint">Введите Telegram username для продолжения</div>
          </div>
          <div class="form-group" id="phoneInputGroup" style="display: none;">
              <label for="phone" class="field-required">Введите номер телефона:</label>
              <input type="tel" id="phone" placeholder="+996 XXX XXX XXX">
              <p class="input-hint">Формат: +996XXXYYYZZZ (без пробелов)</p>
              <div id="phoneHint" class="field-hint">Введите номер телефона для продолжения</div>
          </div>
          <div class="navigation">
              <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
              <button class="btn" onclick="nextStep()" id="nextBtn4" disabled>Далее <i class="fas fa-arrow-right"></i></button>
          </div>
      </div>

      <!-- Шаг 5 -->
      <div class="form-step" id="step5">
          <h2 class="step-title"><i class="fas fa-map-marker-alt"></i> Локация</h2>
          <div class="form-group">
              <!-- Кнопка автоматического определения местоположения через Telegram -->
              <button class="btn auto-location-btn" onclick="getTelegramLocation()" id="telegramLocationBtn" style="margin-bottom: 20px;">
                  <i class="fas fa-location-crosshairs"></i> Определить мое местоположение через Telegram
              </button>
              
              <div class="location-select-group">
                  <div class="form-group">
                      <label for="regionSelect" class="field-required">Регион:</label>
                      <select id="regionSelect" onchange="updateCities(); checkStep5Fields();">
                          <option value="">Выберите регион</option>
                          <option value="Бишкек">г. Бишкек</option>
                          <option value="Ош">г. Ош</option>
                          <option value="Чуйская">Чуйская область</option>
                          <option value="Ошская">Ошская область</option>
                          <option value="Джалал-Абадская">Джалал-Абадская область</option>
                          <option value="Иссык-Кульская">Иссык-Кульская область</option>
                          <option value="Нарынская">Нарынская область</option>
                          <option value="Таласская">Таласская область</option>
                          <option value="Баткенская">Баткенская область</option>
                      </select>
                      <div id="regionHint" class="field-hint">Выберите регион для продолжения</div>
                  </div>
                  
                  <div class="form-group">
                      <label for="citySelect" class="field-required">Город/Район:</label>
                      <select id="citySelect" onchange="checkStep5Fields();">
                          <option value="">Сначала выберите регион</option>
                      </select>
                      <div id="cityHint" class="field-hint">Выберите город/район для продолжения</div>
                  </div>
              </div>
              
              <div class="form-group">
                  <label for="addressInput">Адрес или район (улица, дом):</label>
                  <input type="text" id="addressInput" placeholder="Например: ул. Чуй, 123 или район Аламедин" oninput="checkStep5Fields();">
                  <p class="input-hint">Укажите улицу, дом или название района для точности</p>
              </div>
              
              <div class="map-container" id="mapContainer">
                  <div class="map-search-container">
                      <input type="text" id="mapSearch" class="map-search" placeholder="Поиск адреса...">
                      <i class="fas fa-search search-icon"></i>
                  </div>
                  <div class="map-controls">
                      <button class="map-btn" id="locateBtn" title="Мое местоположение"><i class="fas fa-location-crosshairs"></i></button>
                      <button class="map-btn" id="zoomInBtn" title="Приблизить"><i class="fas fa-plus"></i></button>
                      <button class="map-btn" id="zoomOutBtn" title="Отдалить"><i class="fas fa-minus"></i></button>
                  </div>
                  <div class="location-pin">
                      <i class="fas fa-map-pin"></i>
                  </div>
                  <div class="map-address-display" id="addressDisplay">
                      <i class="fas fa-info-circle"></i> Укажите место на карте или используйте поиск
                  </div>
                  <div class="map-layer-controls">
                      <button class="layer-btn active" id="mapLayerBtn"><i class="fas fa-map"></i> Карта</button>
                      <button class="layer-btn" id="satelliteLayerBtn"><i class="fas fa-satellite"></i> Спутник</button>
                  </div>
              </div>
              
              <button class="btn btn-secondary" onclick="getCurrentLocation()" id="locationBtn" style="margin-top: 15px;">
                  <i class="fas fa-location-crosshairs"></i> Использовать текущую геолокацию
              </button>
          </div>
          <div class="navigation">
              <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
              <button class="btn" onclick="nextStep()" id="nextBtn5" disabled>Далее <i class="fas fa-arrow-right"></i></button>
          </div>
      </div>

      <!-- Шаг 6 -->
      <div class="form-step" id="step6">
          <h2 class="step-title"><i class="fas fa-eye"></i> Превью объявления</h2>

          <div class="preview-item"><div class="preview-label">Фото</div><div id="previewPhotos" class="photos-grid"></div></div>
          <div class="preview-item"><div class="preview-label">Описание</div><div class="preview-value" id="previewDescription"></div></div>
          <div class="preview-item"><div class="preview-label">Цена</div><div class="preview-value" id="previewPrice"></div></div>
          <div class="preview-item"><div class="preview-label">Контакты</div><div class="preview-value" id="previewContacts"></div></div>
          <div class="preview-item"><div class="preview-label">Локация</div><div class="preview-value" id="previewLocation"></div></div>

          <div class="navigation">
              <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
              <button class="btn" onclick="submitForm()" id="submitBtn">Опубликовать <i class="fas fa-paper-plane"></i></button>
          </div>
      </div>
    </div>

    <!-- Экран успешной публикации -->
    <div class="form-container" id="successScreen" style="display: none;">
        <div class="success-screen">
            <i class="fas fa-check-circle success-icon"></i>
            <h2 class="success-title">Объявление успешно опубликовано!</h2>
            <p class="success-message">Ваше объявление было опубликовано в канале @Flowers_Kg.<br>Теперь его могут видеть все покупатели.</p>

            <div class="success-steps">
                <div class="success-step"><div class="step-badge">1</div><div class="step-text">Объявление опубликовано в канале</div></div>
                <div class="success-step"><div class="step-badge">2</div><div class="step-text">Покупатели могут связаться с вами по указанным контактам</div></div>
                <div class="success-step"><div class="step-badge">3</div><div class="step-text">Объявление будет активно 7 дней</div></div>
            </div>

            <p style="margin-top: 20px; color: #667eea; font-weight: 600;">
                <i class="fas fa-info-circle"></i> Объявление можно посмотреть в канале:
                 <a href="https://t.me/flowers_kg" target="_blank" style="color: #667eea; text-decoration: underline;">@Flowers_Kg</a>
            </p>

            <div id="telegramCloseSection" style="display: none; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeTelegramApp()" style="margin-top: 10px;">
                    <i class="fas fa-times"></i> Закрыть приложение
                </button>
            </div>

            <button class="btn" onclick="createNewAd()" style="margin-top: 30px;">
                <i class="fas fa-plus"></i> Создать новое объявление
            </button>
        </div>
    </div>
  </div>

  <div class="server-url" id="currentServerUrl"></div>

  <script>
    // Основные переменные
    let formData = {
        photos: [],
        description: '',
        price: '',
        contact_type: 'telegram',
        contacts: '',
        location: { 
            region: '',
            city: '',
            address: '',
            coordinates: null 
        }
    };
    let currentStep = 1;
    const totalSteps = 6;
    const MAX_PHOTOS = 10;
    
    let tg = null;
    let isTelegram = false;
    let map = null;
    let marker = null;
    let initialTelegramUsername = '';
    
    // Данные по регионам и городам Кыргызстана
    const kyrgyzstanRegions = {
        'Бишкек': ['Бишкек (все районы)', 'Аламединский район', 'Ленинский район', 'Октябрьский район', 'Первомайский район', 'Свердловский район'],
        'Ош': ['Ош (все районы)', 'Араванский район', 'Кара-Сууйский район', 'Ноокатский район'],
        'Чуйская': ['Токмок', 'Кара-Балта', 'Кант', 'Шопоков', 'Каинды', 'Каракол (Чуйская)', 'Сокулук', 'Иссык-Атинский район', 'Жайылский район', 'Кеминский район', 'Московский район', 'Панфиловский район', 'Сокулукский район', 'Чуйский район', 'Аламедин', 'Орто-Сай', 'Чон-Арык'],
        'Ошская': ['Ош (город)', 'Араван', 'Кара-Суу', 'Ноокат', 'Узген', 'Гулча', 'Дараут-Курган', 'Кызыл-Кия'],
        'Джалал-Абадская': ['Джалал-Абад', 'Кара-Куль', 'Кок-Жангак', 'Майлуу-Суу', 'Таш-Кумыр', 'Сузак', 'Базар-Коргон', 'Ноокен', 'Аксый', 'Ала-Бука', 'Чаткал', 'Токтогул'],
        'Иссык-Кульская': ['Каракол', 'Балыкчы', 'Чолпон-Ата', 'Тамга', 'Тюп', 'Ананьево', 'Каджи-Сай', 'Бостери', 'Ак-Суу', 'Джети-Огуз', 'Тон', 'Ысык-Куль'],
        'Нарынская': ['Нарын', 'Ат-Баши', 'Кочкор', 'Казарман', 'Чаек', 'Ак-Талаа', 'Жумгал', 'Кочкорка'],
        'Таласская': ['Талас', 'Кара-Буура', 'Манас', 'Бакай-Ата', 'Кызыл-Адыр'],
        'Баткенская': ['Баткен', 'Кызыл-Кия', 'Сульфа', 'Исфана', 'Кадамжай', 'Лейлек', 'Айдаркен']
    };
    
    // URL сервера
    const SERVER_URL = "https://backend-flower-production.up.railway.app";
    document.getElementById('currentServerUrl').textContent = SERVER_URL.replace('https://', '');
    
    // Проверка Telegram Web App и автозаполнение username
    function checkTelegram() {
        if (window.Telegram && Telegram.WebApp) {
            try {
                tg = Telegram.WebApp;
                isTelegram = true;
                
                // Раскрываем приложение на весь экран
                if (tg.expand) tg.expand();
                
                // Включаем подтверждение закрытия
                if (tg.enableClosingConfirmation) tg.enableClosingConfirmation();
                
                // Автозаполнение username из Telegram
                if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.username) {
                    const username = tg.initDataUnsafe.user.username;
                    initialTelegramUsername = username.startsWith('@') ? username : '@' + username;
                    
                    // Заполняем поле Telegram
                    document.getElementById('telegram').value = initialTelegramUsername;
                    formData.contact_type = 'telegram';
                    formData.contacts = initialTelegramUsername;
                    
                    // Сохраняем также для быстрого доступа
                    selectContactType('telegram');
                    
                    // Проверяем поля после автозаполнения
                    setTimeout(() => {
                        checkStep4Fields();
                    }, 100);
                }
                
                // Показываем секцию для закрытия в Telegram
                document.getElementById('telegramCloseSection').style.display = 'block';
                
                console.log('Telegram Web App detected, user:', tg.initDataUnsafe?.user);
                return true;
            } catch (e) {
                console.error('Ошибка Telegram Web App:', e);
            }
        } else {
            console.log('Telegram Web App not detected - running in regular browser');
        }
        return false;
    }
    
    // Получение местоположения через Telegram
    function getTelegramLocation() {
        if (!isTelegram || !tg) {
            showNotification('Внимание', 'Функция доступна только в Telegram приложении', 'info');
            return;
        }
        
        const btn = document.getElementById('telegramLocationBtn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<div class="loader"></div> Определение местоположения...';
        btn.disabled = true;
        
        // Используем Telegram Web App API для получения геолокации
        if (tg.showPopup) {
            tg.showPopup({
                title: 'Доступ к местоположению',
                message: 'Разрешить доступ к вашему местоположению для автоматического определения города?',
                buttons: [
                    {id: 'allow', type: 'ok', text: 'Разрешить'},
                    {id: 'deny', type: 'cancel', text: 'Отмена'}
                ]
            }, function(buttonId) {
                if (buttonId === 'allow') {
                    // В реальном приложении здесь должен быть вызов метода геолокации Telegram
                    // Но пока используем fallback - браузерную геолокацию
                    getCurrentLocationFromBrowser(true);
                } else {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        } else {
            // Fallback для старых версий Telegram
            getCurrentLocationFromBrowser(true);
        }
    }
    
    // Получение местоположения из браузера (с определением города)
    async function getCurrentLocationFromBrowser(isTelegramRequest = false) {
        const btn = isTelegramRequest ? document.getElementById('telegramLocationBtn') : document.getElementById('locationBtn');
        const originalText = btn.innerHTML;
        
        if (isTelegramRequest) {
            btn.innerHTML = '<div class="loader"></div> Определение...';
        } else {
            btn.innerHTML = '<div class="loader"></div> Определение местоположения...';
        }
        btn.disabled = true;
        
        if (!navigator.geolocation) {
            alert('Геолокация не поддерживается вашим браузером');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            async function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                // Сохраняем координаты
                formData.location.coordinates = {
                    latitude: lat,
                    longitude: lon
                };
                
                try {
                    // Используем обратное геокодирование для определения города
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.address) {
                            // Определяем регион и город по данным геокодирования
                            determineRegionAndCity(data.address, lat, lon);
                            
                            // Устанавливаем маркер на карте
                            if (map) {
                                placeMarker(lat, lon);
                            }
                            
                            // Формируем адрес для отображения
                            let displayAddress = '';
                            if (data.address.road) displayAddress += data.address.road;
                            if (data.address.house_number) displayAddress += ', ' + data.address.house_number;
                            
                            if (displayAddress) {
                                document.getElementById('addressInput').value = displayAddress;
                                formData.location.address = displayAddress;
                            }
                            
                            // Обновляем отображение адреса
                            const addressText = data.display_name || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                            document.getElementById('addressDisplay').innerHTML = `<i class="fas fa-check-circle" style="color: #34c759;"></i> ${addressText.substring(0, 100)}`;
                            
                            // Проверяем заполненность полей
                            checkStep5Fields();
                            
                            showNotification('Успешно', 'Местоположение определено! Город автоматически выбран.', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Ошибка геокодирования:', error);
                    // Если не удалось определить по адресу, используем приблизительное определение по координатам
                    approximateLocationByCoordinates(lat, lon);
                }
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1200);
            },
            function(error) {
                let errorMessage = 'Не удалось определить местоположение';
                
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Доступ к геолокации запрещен. Разрешите доступ в настройках браузера.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Информация о местоположении недоступна.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Время ожидания определения местоположения истекло.';
                        break;
                }
                
                if (isTelegramRequest) {
                    showNotification('Ошибка', errorMessage, 'error');
                } else {
                    alert(errorMessage);
                }
                btn.innerHTML = originalText;
                btn.disabled = false;
            },
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            }
        );
    }
    
    // Определение региона и города по данным геокодирования
    function determineRegionAndCity(addressData, lat, lon) {
        let region = '';
        let city = '';
        
        // Пытаемся определить регион по разным полям
        if (addressData.state) {
            // Проверяем соответствие с нашими регионами
            const state = addressData.state.toLowerCase();
            if (state.includes('бишкек') || state.includes('bishkek')) {
                region = 'Бишкек';
                city = 'Бишкек (все районы)';
            } else if (state.includes('ош') || state.includes('osh')) {
                region = 'Ош';
                city = 'Ош (все районы)';
            } else if (state.includes('чуй') || state.includes('chuy')) {
                region = 'Чуйская';
            } else if (state.includes('джалал') || state.includes('jalal')) {
                region = 'Джалал-Абадская';
            } else if (state.includes('иссык') || state.includes('issyk')) {
                region = 'Иссык-Кульская';
            } else if (state.includes('нарын') || state.includes('naryn')) {
                region = 'Нарынская';
            } else if (state.includes('талас') || state.includes('talas')) {
                region = 'Таласская';
            } else if (state.includes('баткен') || state.includes('batken')) {
                region = 'Баткенская';
            }
        }
        
        // Если регион не определился, пытаемся определить по городу
        if (!region) {
            const locationName = (addressData.city || addressData.town || addressData.village || '').toLowerCase();
            
            // Проверяем крупные города
            if (locationName.includes('бишкек') || locationName.includes('bishkek')) {
                region = 'Бишкек';
                city = 'Бишкек (все районы)';
            } else if (locationName.includes('ош') || locationName.includes('osh')) {
                region = 'Ош';
                city = 'Ош (все районы)';
            } else if (locationName.includes('токмок') || locationName.includes('tokmok')) {
                region = 'Чуйская';
                city = 'Токмок';
            } else if (locationName.includes('каракол') || locationName.includes('karakol')) {
                region = 'Иссык-Кульская';
                city = 'Каракол';
            } else if (locationName.includes('джалал') || locationName.includes('jalal')) {
                region = 'Джалал-Абадская';
                city = 'Джалал-Абад';
            } else if (locationName.includes('нарын') || locationName.includes('naryn')) {
                region = 'Нарынская';
                city = 'Нарын';
            } else if (locationName.includes('талас') || locationName.includes('talas')) {
                region = 'Таласская';
                city = 'Талас';
            } else if (locationName.includes('баткен') || locationName.includes('batken')) {
                region = 'Баткенская';
                city = 'Баткен';
            }
        }
        
        // Если все еще не определили, используем приблизительное определение по координатам
        if (!region) {
            approximateLocationByCoordinates(lat, lon);
            return;
        }
        
        // Устанавливаем регион в select
        const regionSelect = document.getElementById('regionSelect');
        regionSelect.value = region;
        
        // Обновляем список городов
        updateCities();
        
        // Устанавливаем город если определили
        if (city) {
            setTimeout(() => {
                const citySelect = document.getElementById('citySelect');
                citySelect.value = city;
                formData.location.city = city;
                
                // Проверяем заполненность полей
                checkStep5Fields();
            }, 100);
        }
        
        formData.location.region = region;
        
        // Проверяем заполненность полей
        setTimeout(() => {
            checkStep5Fields();
        }, 200);
    }
    
    // Приблизительное определение местоположения по координатам
    function approximateLocationByCoordinates(lat, lon) {
        // Приблизительные границы регионов Кыргызстана
        // Бишкек и Чуйская область
        if (lat > 42.8 && lat < 43.0 && lon > 74.5 && lon < 74.7) {
            setRegionAndCity('Бишкек', 'Бишкек (все районы)');
        }
        // Ош
        else if (lat > 40.5 && lat < 40.6 && lon > 72.7 && lon < 72.9) {
            setRegionAndCity('Ош', 'Ош (все районы)');
        }
        // Иссык-Кульская область
        else if (lat > 42.1 && lat < 42.7 && lon > 76.0 && lon < 78.5) {
            setRegionAndCity('Иссык-Кульская', 'Балыкчы');
        }
        // Джалал-Абадская область
        else if (lat > 41.0 && lat < 41.6 && lon > 72.0 && lon < 73.5) {
            setRegionAndCity('Джалал-Абадская', 'Джалал-Абад');
        }
        // Нарынская область
        else if (lat > 41.0 && lat < 42.0 && lon > 74.0 && lon < 76.5) {
            setRegionAndCity('Нарынская', 'Нарын');
        }
        // Таласская область
        else if (lat > 42.3 && lat < 42.6 && lon > 71.5 && lon < 72.5) {
            setRegionAndCity('Таласская', 'Талас');
        }
        // Баткенская область
        else if (lat > 39.8 && lat < 40.5 && lon > 70.0 && lon < 71.5) {
            setRegionAndCity('Баткенская', 'Баткен');
        }
        // Ошская область
        else if (lat > 40.0 && lat < 40.8 && lon > 72.5 && lon < 73.5) {
            setRegionAndCity('Ошская', 'Ош (город)');
        }
        // По умолчанию - Чуйская область
        else {
            setRegionAndCity('Чуйская', 'Токмок');
        }
        
        showNotification('Информация', 'Город определен приблизительно по координатам. Проверьте правильность выбора.', 'info');
    }
    
    function setRegionAndCity(region, city) {
        const regionSelect = document.getElementById('regionSelect');
        regionSelect.value = region;
        
        updateCities();
        
        setTimeout(() => {
            const citySelect = document.getElementById('citySelect');
            citySelect.value = city;
            formData.location.region = region;
            formData.location.city = city;
            
            // Проверяем заполненность полей
            checkStep5Fields();
        }, 100);
    }
    
    // Обновление списка городов при выборе региона
    function updateCities() {
        const regionSelect = document.getElementById('regionSelect');
        const citySelect = document.getElementById('citySelect');
        const selectedRegion = regionSelect.value;
        
        citySelect.innerHTML = '<option value="">Выберите город/район</option>';
        
        if (selectedRegion && kyrgyzstanRegions[selectedRegion]) {
            kyrgyzstanRegions[selectedRegion].forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
            
            // Сохраняем регион в данных формы
            formData.location.region = selectedRegion;
        } else {
            formData.location.region = '';
            formData.location.city = '';
        }
    }
    
    // Проверка полей шага 1
    function checkStep1Fields() {
        const photosCount = formData.photos.length;
        const nextBtn = document.getElementById('nextBtn1');
        const photoHint = document.getElementById('photoHint');
        
        if (photosCount > 0) {
            nextBtn.disabled = false;
            photoHint.classList.remove('show');
        } else {
            nextBtn.disabled = true;
            photoHint.classList.add('show');
        }
    }
    
    // Проверка полей шага 2
    function checkStep2Fields() {
        const description = document.getElementById('description').value.trim();
        const nextBtn = document.getElementById('nextBtn2');
        const descriptionHint = document.getElementById('descriptionHint');
        
        if (description.length >= 3) {
            nextBtn.disabled = false;
            descriptionHint.classList.remove('show');
        } else {
            nextBtn.disabled = true;
            descriptionHint.classList.add('show');
        }
    }
    
    // Проверка полей шага 3
    function checkStep3Fields() {
        const price = document.getElementById('price').value.trim();
        const nextBtn = document.getElementById('nextBtn3');
        const priceHint = document.getElementById('priceHint');
        
        if (price.length > 0) {
            nextBtn.disabled = false;
            priceHint.classList.remove('show');
        } else {
            nextBtn.disabled = true;
            priceHint.classList.add('show');
        }
    }
    
    // Проверка полей шага 4
    function checkStep4Fields() {
        const contactType = formData.contact_type;
        let isValid = false;
        const nextBtn = document.getElementById('nextBtn4');
        
        if (contactType === 'telegram') {
            const telegram = document.getElementById('telegram').value.trim();
            const telegramHint = document.getElementById('telegramHint');
            
            if (telegram.length > 0) {
                isValid = true;
                telegramHint.classList.remove('show');
            } else {
                telegramHint.classList.add('show');
            }
            
            // Скрываем подсказку для телефона
            document.getElementById('phoneHint').classList.remove('show');
        } else {
            const phone = document.getElementById('phone').value.trim();
            const phoneHint = document.getElementById('phoneHint');
            
            if (phone.length > 0 && phone !== '+996') {
                isValid = true;
                phoneHint.classList.remove('show');
            } else {
                phoneHint.classList.add('show');
            }
            
            // Скрываем подсказку для телеграма
            document.getElementById('telegramHint').classList.remove('show');
        }
        
        nextBtn.disabled = !isValid;
    }
    
    // Проверка полей шага 5
    function checkStep5Fields() {
        const region = document.getElementById('regionSelect').value;
        const city = document.getElementById('citySelect').value;
        const nextBtn = document.getElementById('nextBtn5');
        const regionHint = document.getElementById('regionHint');
        const cityHint = document.getElementById('cityHint');
        
        let regionValid = false;
        let cityValid = false;
        
        if (region && region.length > 0) {
            regionValid = true;
            regionHint.classList.remove('show');
        } else {
            regionHint.classList.add('show');
        }
        
        if (city && city.length > 0) {
            cityValid = true;
            cityHint.classList.remove('show');
        } else {
            cityHint.classList.add('show');
        }
        
        nextBtn.disabled = !(regionValid && cityValid);
    }
    
    // Закрытие Telegram приложения - ИСПРАВЛЕННАЯ ВЕРСИЯ
    function closeTelegramApp() {
        console.log('Attempting to close Telegram app, isTelegram:', isTelegram);
        
        // Способ 1: Используем Telegram Web App API
        if (window.Telegram && Telegram.WebApp) {
            try {
                const webApp = Telegram.WebApp;
                console.log('Closing via Telegram.WebApp.close()');
                if (webApp.close) {
                    webApp.close();
                    return true;
                }
            } catch (e) {
                console.error('Error closing via Telegram.WebApp:', e);
            }
        }
        
        // Способ 2: Используем сохраненный объект tg
        if (isTelegram && tg && typeof tg.close === 'function') {
            try {
                console.log('Closing via tg.close()');
                tg.close();
                return true;
            } catch (e) {
                console.error('Error closing via tg.close():', e);
            }
        }
        
        // Способ 3: Попробуем использовать postMessage для закрытия
        try {
            console.log('Trying postMessage method');
            if (window.parent !== window) {
                window.parent.postMessage('web_app_close', '*');
            }
        } catch (e) {
            console.error('Error with postMessage:', e);
        }
        
        // Способ 4: Покажем сообщение, если не получилось закрыть
        alert('Не удалось закрыть приложение. Вы можете закрыть вкладку вручную.');
        console.warn('Could not close Telegram app, showing manual close message');
        return false;
    }
    
    // Отправка данных на сервер
    async function sendDataToServer(data) {
        try {
            // Отправка через обычный API
            const response = await fetch(`${SERVER_URL}/api/create-ad`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                const text = await response.text();
                throw new Error(text || `HTTP ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error('Ошибка отправки:', error);
            throw error;
        }
    }
    
    // Обработчики фото
    document.getElementById('photoUpload').addEventListener('click', () => {
        document.getElementById('photoInput').click();
    });
    
    document.getElementById('photoInput').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        
        if (formData.photos.length + files.length > MAX_PHOTOS) {
            alert(`Максимум можно загрузить ${MAX_PHOTOS} фото`);
            e.target.value = '';
            return;
        }
        
        files.forEach(file => {
            if (!file.type.startsWith('image/')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                formData.photos.push(event.target.result);
                createPhotoPreview(event.target.result, formData.photos.length - 1);
                updatePhotoCounter();
                checkStep1Fields();
            };
            reader.readAsDataURL(file);
        });
        
        e.target.value = '';
    });
    
    function createPhotoPreview(src, index) {
        const preview = document.getElementById('photoPreview');
        const div = document.createElement('div');
        div.className = 'photo-item';
        div.setAttribute('data-index', index);
        
        const img = document.createElement('img');
        img.src = src;
        img.alt = `Фото ${index + 1}`;
        
        const removeBtn = document.createElement('div');
        removeBtn.className = 'remove-photo';
        removeBtn.innerText = '×';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            removePhoto(index);
        };
        
        div.appendChild(img);
        div.appendChild(removeBtn);
        preview.appendChild(div);
    }
    
    function removePhoto(index) {
        formData.photos.splice(index, 1);
        refreshPhotos();
        updatePhotoCounter();
        checkStep1Fields();
    }
    
    function refreshPhotos() {
        const preview = document.getElementById('photoPreview');
        preview.innerHTML = '';
        formData.photos.forEach((photo, index) => {
            createPhotoPreview(photo, index);
        });
    }
    
    function updatePhotoCounter() {
        const upload = document.getElementById('photoUpload');
        const count = formData.photos.length;
        
        if (count > 0) {
            upload.innerHTML = `
                <i class="fas fa-check-circle photo-upload-icon" style="color: #34c759"></i>
                <p>Загружено фото: ${count}</p>
                <p class="input-hint">Можно добавить ещё ${MAX_PHOTOS - count} фото</p>
            `;
        } else {
            upload.innerHTML = `
                <i class="fas fa-cloud-upload-alt photo-upload-icon"></i>
                <p>Нажмите для загрузки фото</p>
                <p class="input-hint">Можно загрузить до ${MAX_PHOTOS} фото</p>
            `;
        }
    }
    
    // Навигация по шагам
    function showStep(step) {
        for (let i = 1; i <= totalSteps; i++) {
            document.getElementById(`step${i}`).classList.remove('active');
        }
        document.getElementById(`step${step}`).classList.add('active');
        currentStep = step;
        updateProgressBar();
        
        if (step === 5) {
            // Инициализируем карту при показе шага 5
            setTimeout(initMap, 100);
            // Проверяем поля шага 5
            setTimeout(checkStep5Fields, 200);
        }
        
        if (step === 6) {
            updatePreview();
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function nextStep() {
        if (!validateStep(currentStep)) {
            return;
        }
        
        saveCurrentStepData();
        
        if (currentStep < totalSteps) {
            showStep(currentStep + 1);
        }
    }
    
    function prevStep() {
        if (currentStep > 1) {
            showStep(currentStep - 1);
        }
    }
    
    function saveCurrentStepData() {
        if (currentStep === 2) {
            const description = document.getElementById('description');
            if (description) {
                formData.description = description.value.trim();
            }
        }
        
        if (currentStep === 3) {
            const price = document.getElementById('price');
            if (price) {
                formData.price = price.value.trim();
            }
        }
        
        if (currentStep === 4) {
            if (formData.contact_type === 'telegram') {
                const telegram = document.getElementById('telegram');
                if (telegram) {
                    let t = telegram.value.trim();
                    if (t && !t.startsWith('@')) {
                        t = '@' + t;
                    }
                    telegram.value = t;
                    formData.contacts = t;
                }
            } else {
                const phone = document.getElementById('phone');
                if (phone) {
                    formatPhoneInput();
                    formData.contacts = phone.value.trim();
                }
            }
        }
        
        if (currentStep === 5) {
            const region = document.getElementById('regionSelect').value;
            const city = document.getElementById('citySelect').value;
            const address = document.getElementById('addressInput').value.trim();
            
            formData.location.region = region;
            formData.location.city = city;
            formData.location.address = address;
        }
    }
    
    function validateStep(step) {
        if (step === 1) {
            if (formData.photos.length === 0) {
                alert('Загрузите хотя бы одно фото');
                return false;
            }
            return true;
        }
        
        if (step === 2) {
            const description = document.getElementById('description').value.trim();
            if (!description || description.length < 3) {
                alert('Описание должно содержать минимум 3 символа');
                return false;
            }
            return true;
        }
        
        if (step === 3) {
            const price = document.getElementById('price').value.trim();
            if (!price) {
                alert('Укажите цену');
                return false;
            }
            return true;
        }
        
        if (step === 4) {
            if (formData.contact_type === 'telegram') {
                const telegram = document.getElementById('telegram').value.trim();
                if (!telegram) {
                    alert('Введите Telegram username');
                    return false;
                }
            } else {
                const phone = document.getElementById('phone').value.trim();
                if (!phone || phone === '+996') {
                    alert('Введите номер телефона');
                    return false;
                }
            }
            return true;
        }
        
        if (step === 5) {
            const region = document.getElementById('regionSelect').value;
            const city = document.getElementById('citySelect').value;
            
            if (!region) {
                alert('Выберите регион');
                return false;
            }
            
            if (!city) {
                alert('Выберите город или район');
                return false;
            }
            
            return true;
        }
        
        if (step === 6) {
            return true;
        }
        
        return true;
    }
    
    // Выбор типа контактов с автозаполнением Telegram
    function selectContactType(type) {
        formData.contact_type = type;
        
        document.getElementById('telegramOption').classList.toggle('active', type === 'telegram');
        document.getElementById('phoneOption').classList.toggle('active', type === 'phone');
        
        document.getElementById('telegramInputGroup').style.display = type === 'telegram' ? 'block' : 'none';
        document.getElementById('phoneInputGroup').style.display = type === 'phone' ? 'block' : 'none';
        
        if (type === 'telegram') {
            // Если поле пустое и есть сохраненный username, заполняем его
            const telegramField = document.getElementById('telegram');
            if (!telegramField.value.trim() && initialTelegramUsername) {
                telegramField.value = initialTelegramUsername;
                formData.contacts = initialTelegramUsername;
            }
        } else {
            const phone = document.getElementById('phone');
            if (!phone.value.trim()) {
                phone.value = '+996';
                formData.contacts = '+996';
            }
        }
        
        // Проверяем поля после смены типа контакта
        checkStep4Fields();
    }
    
    // Форматирование номера телефона
    function formatPhoneInput() {
        const phoneInput = document.getElementById('phone');
        let value = phoneInput.value.replace(/[^\d+]/g, '');
        
        if (!value.startsWith('+')) {
            value = '+' + value.replace(/^\++/, '');
        }
        
        if (!value.startsWith('+996')) {
            value = '+996' + value.replace(/^\+?996/, '').replace(/^\+?/, '');
        }
        
        const rest = value.slice(4).replace(/\D/g, '').slice(0, 9);
        phoneInput.value = '+996' + rest;
        
        // Проверяем поля после форматирования
        checkStep4Fields();
    }
    
    document.getElementById('phone').addEventListener('input', function() {
        formatPhoneInput();
        formData.contacts = this.value;
        checkStep4Fields();
    });
    
    // Инициализация карты в стиле 2GIS
    function initMap() {
        // Убедимся, что контейнер карты существует
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || map) return; // Карта уже инициализирована
        
        // Загружаем Leaflet динамически
        if (typeof L === 'undefined') {
            // Загружаем CSS Leaflet
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
            document.head.appendChild(link);
            
            // Загружаем JS Leaflet
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            script.onload = function() {
                setTimeout(createMap, 100);
            };
            document.head.appendChild(script);
        } else {
            createMap();
        }
    }
    
    function createMap() {
        try {
            // Центр на Бишкек
            const centerLat = 42.8746;
            const centerLng = 74.5698;
            
            // Создаем карту
            map = L.map('mapContainer').setView([centerLat, centerLng], 13);
            
            // Слои карты (в стиле 2GIS)
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap',
                maxZoom: 19,
                detectRetina: true
            });
            
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri',
                maxZoom: 19,
                detectRetina: true
            });
            
            // Добавляем слой по умолчанию
            streetLayer.addTo(map);
            
            // Сохранение ссылок на слои
            map.streetLayer = streetLayer;
            map.satelliteLayer = satelliteLayer;
            
            // Обработчики кнопок слоев
            document.getElementById('mapLayerBtn').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('satelliteLayerBtn').classList.remove('active');
                map.removeLayer(map.satelliteLayer);
                map.streetLayer.addTo(map);
            });
            
            document.getElementById('satelliteLayerBtn').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('mapLayerBtn').classList.remove('active');
                map.removeLayer(map.streetLayer);
                map.satelliteLayer.addTo(map);
            });
            
            // Обработчики кнопок управления
            document.getElementById('zoomInBtn').addEventListener('click', function() {
                map.zoomIn();
            });
            
            document.getElementById('zoomOutBtn').addEventListener('click', function() {
                map.zoomOut();
            });
            
            // Кнопка определения местоположения
            document.getElementById('locateBtn').addEventListener('click', function() {
                getCurrentLocationFromBrowser(false);
            });
            
            // Обработчик поиска
            let searchTimeout;
            document.getElementById('mapSearch').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                if (query.length >= 3) {
                    searchTimeout = setTimeout(() => searchAddress(query), 500);
                }
            });
            
            // Добавляем обработчик клика по карте
            map.on('click', function(e) {
                placeMarker(e.latlng.lat, e.latlng.lng);
                reverseGeocode(e.latlng.lat, e.latlng.lng);
            });
            
            // Автоматически определяем местоположение при загрузке (если в Telegram)
            if (isTelegram) {
                setTimeout(() => {
                    // В Telegram можно попробовать получить местоположение сразу
                    map.locate({ 
                        setView: true, 
                        maxZoom: 16, 
                        enableHighAccuracy: true,
                        timeout: 10000 
                    });
                    
                    map.on('locationfound', function(e) {
                        placeMarker(e.latlng.lat, e.latlng.lng);
                        reverseGeocode(e.latlng.lat, e.latlng.lng);
                        
                        // Определяем город по координатам
                        determineRegionAndCity({}, e.latlng.lat, e.latlng.lng);
                    });
                    
                    map.on('locationerror', function(e) {
                        console.warn('Не удалось определить местоположение:', e.message);
                    });
                }, 1000);
            }
            
        } catch (e) {
            console.error('Ошибка инициализации карты:', e);
        }
    }
    
    function placeMarker(lat, lng) {
        if (!map) return;
        
        // Создаем красивую иконку маркера в стиле 2GIS
        const markerIcon = L.divIcon({
            html: '<i class="fas fa-map-pin" style="font-size: 32px; color: #ff3b30; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            className: 'custom-marker'
        });
        
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng], { 
                icon: markerIcon,
                draggable: true 
            }).addTo(map);
            
            marker.on('dragend', function(e) {
                const position = marker.getLatLng();
                reverseGeocode(position.lat, position.lng);
            });
        }
        
        map.setView([lat, lng], 15);
        
        formData.location.coordinates = {
            latitude: lat,
            longitude: lng
        };
    }
    
    async function searchAddress(query) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=kg`);
            
            if (response.ok) {
                const data = await response.json();
                if (data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    
                    placeMarker(lat, lon);
                    
                    // Пытаемся определить город
                    determineRegionAndCity({}, lat, lon);
                    
                    // Обновляем поле адреса
                    document.getElementById('addressInput').value = result.display_name;
                    formData.location.address = result.display_name;
                    
                    // Обновляем отображение адреса
                    document.getElementById('addressDisplay').innerHTML = `<i class="fas fa-check-circle" style="color: #34c759;"></i> ${result.display_name}`;
                    
                    // Проверяем поля
                    checkStep5Fields();
                    
                    showNotification('Успешно', 'Адрес найден', 'success');
                } else {
                    showNotification('Информация', 'Адрес не найден', 'info');
                }
            }
        } catch (error) {
            console.error('Ошибка поиска адреса:', error);
            showNotification('Ошибка', 'Не удалось найти адрес', 'error');
        }
    }
    
    async function reverseGeocode(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
            
            if (response.ok) {
                const data = await response.json();
                if (data.display_name) {
                    // Пытаемся определить регион и город
                    determineRegionAndCity(data.address || {}, lat, lng);
                    
                    // Устанавливаем адрес
                    document.getElementById('addressInput').value = data.display_name;
                    formData.location.address = data.display_name;
                    
                    // Обновляем отображение адреса
                    document.getElementById('addressDisplay').innerHTML = `<i class="fas fa-map-pin" style="color: #ff3b30;"></i> ${data.display_name}`;
                    
                    // Проверяем поля
                    checkStep5Fields();
                }
            }
        } catch (error) {
            document.getElementById('addressInput').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            formData.location.address = document.getElementById('addressInput').value;
            
            // Обновляем отображение адреса
            document.getElementById('addressDisplay').innerHTML = `<i class="fas fa-map-pin" style="color: #ff3b30;"></i> ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            
            // Проверяем поля
            checkStep5Fields();
        }
    }
    
    // Получение текущей геолокации
    function getCurrentLocation() {
        getCurrentLocationFromBrowser(false);
    }
    
    // Обновление превью
    function updatePreview() {
        // Фото
        const previewPhotos = document.getElementById('previewPhotos');
        previewPhotos.innerHTML = '';
        
        formData.photos.slice(0, 6).forEach(photo => {
            const img = document.createElement('img');
            img.className = 'photo-preview';
            img.src = photo;
            previewPhotos.appendChild(img);
        });
        
        if (formData.photos.length > 6) {
            const more = document.createElement('div');
            more.className = 'photo-preview photo-more';
            more.textContent = '+' + (formData.photos.length - 6);
            previewPhotos.appendChild(more);
        }
        
        // Описание
        document.getElementById('previewDescription').textContent = formData.description || 'Не указано';
        
        // Цена
        document.getElementById('previewPrice').textContent = formData.price || 'Не указана';
        
        // Контакты
        const contactsPreview = document.getElementById('previewContacts');
        if (formData.contact_type === 'telegram') {
            const username = (formData.contacts || '').replace(/^@/, '');
            contactsPreview.innerHTML = username ? `<a href="https://t.me/${username}" target="_blank">@${username}</a>` : 'Не указано';
        } else {
            const phone = (formData.contacts || '').replace(/[^\d+]/g, '');
            contactsPreview.innerHTML = phone ? `<a href="https://wa.me/${phone}" target="_blank">WhatsApp</a> • <a href="tel:${phone}">Позвонить</a>` : 'Не указано';
        }
        
        // Локация
        const locationPreview = document.getElementById('previewLocation');
        let locationText = '';
        
        if (formData.location.region) {
            locationText += formData.location.region;
        }
        
        if (formData.location.city) {
            locationText += (locationText ? ', ' : '') + formData.location.city;
        }
        
        if (formData.location.address) {
            locationText += (locationText ? ', ' : '') + formData.location.address;
        }
        
        if (formData.location.coordinates) {
            locationText += (locationText ? ' (' : '') + '📍 по координатам' + (locationText ? ')' : '');
        }
        
        if (!locationText) {
            locationText = '📍 Не указана';
        }
        
        locationPreview.textContent = locationText;
    }
    
    // Сохранение всех данных формы
    function saveAllData() {
        // Шаг 2: Описание
        const description = document.getElementById('description');
        if (description) {
            formData.description = description.value.trim();
        }
        
        // Шаг 3: Цена
        const price = document.getElementById('price');
        if (price) {
            formData.price = price.value.trim();
        }
        
        // Шаг 4: Контакты
        if (formData.contact_type === 'telegram') {
            const telegram = document.getElementById('telegram');
            if (telegram) {
                let t = telegram.value.trim();
                if (t && !t.startsWith('@')) {
                    t = '@' + t;
                }
                telegram.value = t;
                formData.contacts = t;
            }
        } else {
            const phone = document.getElementById('phone');
            if (phone) {
                formatPhoneInput();
                formData.contacts = phone.value.trim();
            }
        }
        
        // Шаг 5: Локация
        const region = document.getElementById('regionSelect').value;
        const city = document.getElementById('citySelect').value;
        const address = document.getElementById('addressInput').value.trim();
        
        formData.location.region = region;
        formData.location.city = city;
        formData.location.address = address;
    }
    
    // Отправка формы
    async function submitForm() {
        // Сохраняем все данные перед отправкой
        saveAllData();
        
        // Проверяем обязательные поля
        if (formData.photos.length === 0) {
            alert('Загрузите хотя бы одно фото');
            showStep(1);
            return;
        }
        
        if (!formData.description || formData.description.length < 3) {
            alert('Описание должно содержать минимум 3 символа');
            showStep(2);
            return;
        }
        
        if (!formData.price) {
            alert('Укажите цену');
            showStep(3);
            return;
        }
        
        if (!formData.contacts) {
            alert('Укажите контакты для связи');
            showStep(4);
            return;
        }
        
        if (!formData.location.region || !formData.location.city) {
            alert('Укажите регион и город');
            showStep(5);
            return;
        }
        
        // Формируем полный адрес
        let fullAddress = '';
        if (formData.location.region) fullAddress += formData.location.region;
        if (formData.location.city) fullAddress += (fullAddress ? ', ' : '') + formData.location.city;
        if (formData.location.address) fullAddress += (fullAddress ? ', ' : '') + formData.location.address;
        
        const finalData = {
            ...formData,
            location: {
                ...formData.location,
                address: fullAddress
            },
            timestamp: new Date().toISOString(),
            source: isTelegram ? 'telegram_web_app' : 'web_app'
        };
        
        try {
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').innerHTML = '<div class="loader"></div> Публикация...';
            
            const result = await sendDataToServer(finalData);
            
            if (result.success) {
                document.getElementById('formContainer').style.display = 'none';
                document.getElementById('successScreen').style.display = 'block';
                showNotification('Успешно', 'Объявление опубликовано!', 'success');
            } else {
                throw new Error(result.error || 'Неизвестная ошибка сервера');
            }
        } catch (error) {
            console.error('Ошибка при публикации:', error);
            alert('Ошибка при публикации: ' + (error.message || 'Проверьте соединение с интернетом'));
        } finally {
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').innerHTML = 'Опубликовать <i class="fas fa-paper-plane"></i>';
        }
    }
    
    // Уведомления
    function showNotification(title, message, type = 'info') {
        const notification = document.getElementById('notification');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        
        if (!notification || !notificationTitle || !notificationMessage) return;
        
        notificationTitle.textContent = title;
        notificationMessage.textContent = message;
        
        notification.className = 'notification';
        if (type === 'success') {
            notification.classList.add('success');
        }
        
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 4000);
    }
    
    // Обновление прогресс-бара
    function updateProgressBar() {
        const stepNumbers = document.querySelectorAll('.step-number');
        const stepLabels = document.querySelectorAll('.step-label');
        
        stepNumbers.forEach((step, index) => {
            step.classList.toggle('active', index + 1 === currentStep);
        });
        
        stepLabels.forEach((label, index) => {
            label.classList.toggle('active', index + 1 <= currentStep);
        });
    }
    
    // Создание нового объявления
    function createNewAd() {
        location.reload();
    }
    
    // Анимация лепестков - ИСПРАВЛЕННАЯ ВЕРСИЯ
    function initPetals() {
        const layer = document.getElementById('petalLayer');
        if (!layer) return;
        
        const petals = ['🌸', '🌺', '🌼', '🌻'];
        
        function createPetal() {
            const petal = document.createElement('div');
            petal.className = 'petal';
            
            // Уменьшен размер лепестков
            const size = 20 + Math.random() * 30; // Было 30-70, стало 20-50
            petal.style.fontSize = size + 'px';
            petal.style.left = Math.random() * 100 + '%';
            
            // Уменьшена прозрачность
            petal.style.opacity = 0.4 + Math.random() * 0.3; // Было 0.7-1.0, стало 0.4-0.7
            
            petal.textContent = petals[Math.floor(Math.random() * petals.length)];
            
            // Уменьшена скорость и продолжительность
            const duration = 10000 + Math.random() * 10000; // Было 8-16 секунд, стало 10-20 секунд
            petal.style.animation = `petalFall ${duration}ms linear forwards`;
            petal.style.animationDelay = Math.random() * 3000 + 'ms'; // Было 0-2 секунд, стало 0-3 секунд
            
            layer.appendChild(petal);
            
            setTimeout(() => {
                if (petal.parentNode === layer) {
                    layer.removeChild(petal);
                }
            }, duration + 3000);
        }
        
        // Уменьшено количество лепестков при загрузке
        for (let i = 0; i < 5; i++) { // Было 10, стало 5
            setTimeout(() => createPetal(), i * 500); // Было 300ms, стало 500ms
        }
        
        // Увеличено время между созданием новых лепестков
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                createPetal();
            }
        }, 1500); // Было 800ms, стало 1500ms
    }
    
    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        // Проверяем Telegram Web App
        checkTelegram();
        
        // Инициализируем прогресс-бар
        updateProgressBar();
        
        // Инициализируем счетчик фото
        updatePhotoCounter();
        
        // Инициализируем лепестки
        initPetals();
        
        // Проверяем поля шага 1
        checkStep1Fields();
        
        // Автосохранение при изменении полей
        const descriptionField = document.getElementById('description');
        if (descriptionField) {
            descriptionField.addEventListener('input', function() {
                formData.description = this.value.trim();
                checkStep2Fields();
            });
        }
        
        const priceField = document.getElementById('price');
        if (priceField) {
            priceField.addEventListener('input', function() {
                formData.price = this.value.trim();
                checkStep3Fields();
            });
        }
        
        const telegramField = document.getElementById('telegram');
        if (telegramField) {
            telegramField.addEventListener('input', function() {
                if (formData.contact_type === 'telegram') {
                    formData.contacts = this.value.trim();
                }
                checkStep4Fields();
            });
        }
        
        const regionField = document.getElementById('regionSelect');
        if (regionField) {
            regionField.addEventListener('change', function() {
                formData.location.region = this.value;
                updateCities();
                checkStep5Fields();
            });
        }
        
        const cityField = document.getElementById('citySelect');
        if (cityField) {
            cityField.addEventListener('change', function() {
                formData.location.city = this.value;
                checkStep5Fields();
            });
        }
        
        const addressField = document.getElementById('addressInput');
        if (addressField) {
            addressField.addEventListener('input', function() {
                formData.location.address = this.value.trim();
                checkStep5Fields();
            });
        }
    });
  </script>
</body>
</html>