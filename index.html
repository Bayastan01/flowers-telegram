<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <title>Flower Market - Создать объявление</title>
    <style>
        /* Основные стили */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            padding-bottom: 20px; 
        }
        .header { 
            text-align: center; 
            color: white; 
            margin-bottom: 30px; 
            padding-top: 20px; 
        }
        .header h1 { 
            font-size: 24px; 
            margin-bottom: 8px; 
            font-weight: 600; 
        }
        .header p { 
            opacity: 0.9; 
            font-size: 14px; 
        }
        .form-container { 
            background: white; 
            border-radius: 20px; 
            padding: 25px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            margin-bottom: 20px; 
        }
        .form-step { 
            display: none; 
        }
        .form-step.active { 
            display: block; 
            animation: fadeIn 0.3s ease; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .step-title { 
            font-size: 20px; 
            color: #333; 
            margin-bottom: 25px; 
            text-align: center; 
            font-weight: 600; 
        }
        .form-group { 
            margin-bottom: 25px; 
        }
        label { 
            display: block; 
            margin-bottom: 10px; 
            color: #555; 
            font-weight: 500; 
            font-size: 15px; 
        }
        input, textarea, select { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid #e0e0e0; 
            border-radius: 12px; 
            font-size: 16px; 
            font-family: inherit; 
            transition: all 0.3s ease; 
            background: #fff; 
        }
        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
        }
        textarea { 
            min-height: 140px; 
            resize: vertical; 
            line-height: 1.5; 
        }
        .input-hint { 
            display: block; 
            margin-top: 8px; 
            color: #888; 
            font-size: 13px; 
        }
        .photo-upload { 
            border: 3px dashed #667eea; 
            border-radius: 12px; 
            padding: 40px 20px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            background: rgba(102, 126, 234, 0.05); 
        }
        .photo-upload:hover { 
            background: rgba(102, 126, 234, 0.1); 
        }
        #photoInput { 
            display: none; 
        }
        #photoPreview { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            margin-top: 20px; 
        }
        .photo-item { 
            position: relative; 
            width: 100px; 
            height: 100px; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        .photo-item img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .remove-photo { 
            position: absolute; 
            top: 6px; 
            right: 6px; 
            background: rgba(255, 59, 48, 0.9); 
            color: white; 
            width: 26px; 
            height: 26px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: bold; 
            border: 2px solid white; 
        }
        .contact-options { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        .contact-option { 
            padding: 20px 15px; 
            border: 2px solid #e0e0e0; 
            border-radius: 12px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            background: #fff; 
        }
        .contact-option.active { 
            border-color: #667eea; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3); 
        }
        .btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 16px 30px; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            transition: all 0.3s ease; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); 
        }
        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
        }
        .btn-secondary { 
            background: #f0f0f0; 
            color: #333; 
        }
        .navigation { 
            display: flex; 
            gap: 15px; 
            margin-top: 30px; 
        }
        .navigation .btn { 
            flex: 1; 
        }
        .progress-bar { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 30px; 
            position: relative; 
        }
        .progress-bar:before { 
            content: ''; 
            position: absolute; 
            top: 15px; 
            left: 0; 
            right: 0; 
            height: 3px; 
            background: rgba(255,255,255,0.3); 
            z-index: 1; 
        }
        .progress-step { 
            position: relative; 
            z-index: 2; 
            text-align: center; 
            flex: 1; 
        }
        .step-number { 
            width: 36px; 
            height: 36px; 
            background: rgba(255,255,255,0.3); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 0 auto 8px; 
            color: white; 
            font-weight: 600; 
        }
        .step-number.active { 
            background: white; 
            color: #667eea; 
        }
        .notification { 
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%) translateY(-100px); 
            background: white; 
            padding: 15px 20px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            z-index: 1000; 
            transition: transform 0.4s ease; 
            max-width: 90%; 
            width: 400px; 
        }
        .notification.show { 
            transform: translateX(-50%) translateY(0); 
        }
        .loader { 
            display: inline-block; 
            width: 20px; 
            height: 20px; 
            border: 3px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top-color: white; 
            animation: spin 1s ease-in-out infinite; 
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        .success-screen { 
            text-align: center; 
            padding: 40px 20px; 
        }
        .success-icon { 
            font-size: 80px; 
            color: #34c759; 
            margin-bottom: 25px; 
        }
        .success-title { 
            font-size: 28px; 
            color: #333; 
            margin-bottom: 15px; 
            font-weight: 600; 
        }
        @media (max-width: 600px) { 
            body { padding: 15px; } 
            .form-container { padding: 20px; } 
            .step-title { font-size: 18px; } 
            .photo-item { width: 80px; height: 80px; } 
            .btn { padding: 14px 20px; } 
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="progress-bar" id="progressBar">
            <div class="progress-step"><div class="step-number active">1</div><div class="step-label active">Фото</div></div>
            <div class="progress-step"><div class="step-number">2</div><div class="step-label">Описание</div></div>
            <div class="progress-step"><div class="step-number">3</div><div class="step-label">Цена</div></div>
            <div class="progress-step"><div class="step-number">4</div><div class="step-label">Контакты</div></div>
            <div class="progress-step"><div class="step-number">5</div><div class="step-label">Локация</div></div>
            <div class="progress-step"><div class="step-number">6</div><div class="step-label">Превью</div></div>
        </div>
        
        <div class="header">
            <h1><i class="fas fa-flower-tulip"></i> Flower Market</h1>
            <p>Создайте красивое объявление о продаже цветов</p>
        </div>
        
        <div class="notification" id="notification">
            <div class="notification-content">
                <div class="notification-title" id="notificationTitle"></div>
                <div class="notification-message" id="notificationMessage"></div>
            </div>
        </div>
        
        <div class="form-container" id="formContainer">
            <!-- Шаг 1: Фото -->
            <div class="form-step active" id="step1">
                <h2 class="step-title"><i class="fas fa-camera"></i> Загрузите фото</h2>
                <div class="form-group">
                    <div class="photo-upload" id="photoUpload">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #667eea; margin-bottom: 15px;"></i>
                        <p>Нажмите для загрузки фото</p>
                        <p class="input-hint">Можно загрузить до 10 фото</p>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" multiple>
                    <div id="photoPreview"></div>
                </div>
                <div class="navigation"><button class="btn" onclick="nextStep()">Далее <i class="fas fa-arrow-right"></i></button></div>
            </div>
            
            <!-- Шаг 2: Описание -->
            <div class="form-step" id="step2">
                <h2 class="step-title"><i class="fas fa-edit"></i> Описание товара</h2>
                <div class="form-group">
                    <label for="description">Опишите ваш товар:</label>
                    <textarea id="description" placeholder="Например: Свежие розы из Эквадора, идеально подходят для свадебных букетов. Доставка по городу."></textarea>
                    <p class="input-hint">Минимум 3 символа. Опишите ваши цветы подробно</p>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
                    <button class="btn" onclick="nextStep()">Далее <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            
            <!-- Шаг 3: Цена -->
            <div class="form-step" id="step3">
                <h2 class="step-title"><i class="fas fa-tag"></i> Укажите цену</h2>
                <div class="form-group">
                    <label for="price">Цена в сомах:</label>
                    <input type="text" id="price" placeholder="Например: 1500 или Договорная">
                    <p class="input-hint">Можно указать диапазон: 1000-1500, или "Договорная"</p>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
                    <button class="btn" onclick="nextStep()">Далее <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            
            <!-- Шаг 4: Контакты -->
            <div class="form-step" id="step4">
                <h2 class="step-title"><i class="fas fa-phone"></i> Контакты для связи</h2>
                <div class="contact-options">
                    <div class="contact-option active" id="telegramOption" onclick="selectContactType('telegram')">
                        <i class="fab fa-telegram"></i>
                        <p>Telegram</p>
                        <small>Ввести username</small>
                    </div>
                    <div class="contact-option" id="phoneOption" onclick="selectContactType('phone')">
                        <i class="fas fa-mobile-alt"></i>
                        <p>Телефон</p>
                        <small>Ввести номер</small>
                    </div>
                </div>
                <div class="form-group" id="telegramInputGroup">
                    <label for="telegram">Введите Telegram username:</label>
                    <input type="text" id="telegram" placeholder="@username">
                    <p class="input-hint">Например: @username (без пробелов)</p>
                </div>
                <div class="form-group" id="phoneInputGroup" style="display: none;">
                    <label for="phone">Введите номер телефона:</label>
                    <input type="tel" id="phone" placeholder="+996 XXX XXX XXX">
                    <p class="input-hint">Формат: +996XXXYYYZZZ (без пробелов)</p>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
                    <button class="btn" onclick="nextStep()">Далее <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            
            <!-- Шаг 5: Локация -->
            <div class="form-step" id="step5">
                <h2 class="step-title"><i class="fas fa-map-marker-alt"></i> Локация</h2>
                <div class="form-group">
                    <div style="width: 100%; height: 200px; border-radius: 12px; background: #f5f7fa; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #667eea; border: 2px solid #e0e0e0; margin-bottom: 20px;">
                        <i class="fas fa-map" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <p>Ваше местоположение</p>
                    </div>
                    <label for="locationInput">Адрес или район:</label>
                    <input type="text" id="locationInput" placeholder="Например: г. Бишкек, ул. Чуй, 123">
                    <p class="input-hint">Или используйте текущую геолокацию:</p>
                    <button class="btn btn-secondary" onclick="getCurrentLocation()" id="locationBtn"><i class="fas fa-location-crosshairs"></i> Использовать мое местоположение</button>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
                    <button class="btn" onclick="nextStep()">Далее <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            
            <!-- Шаг 6: Превью -->
            <div class="form-step" id="step6">
                <h2 class="step-title"><i class="fas fa-eye"></i> Превью объявления</h2>
                <div class="form-group">
                    <div style="background: rgba(102, 126, 234, 0.05); padding: 18px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">Фото</div>
                        <div id="previewPhotos"></div>
                    </div>
                    <div style="background: rgba(102, 126, 234, 0.05); padding: 18px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">Описание</div>
                        <div id="previewDescription"></div>
                    </div>
                    <div style="background: rgba(102, 126, 234, 0.05); padding: 18px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">Цена</div>
                        <div id="previewPrice"></div>
                    </div>
                    <div style="background: rgba(102, 126, 234, 0.05); padding: 18px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">Контакты</div>
                        <div id="previewContacts"></div>
                    </div>
                    <div style="background: rgba(102, 126, 234, 0.05); padding: 18px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">Локация</div>
                        <div id="previewLocation"></div>
                    </div>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Назад</button>
                    <button class="btn" onclick="submitForm()" id="submitBtn">Опубликовать <i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
        
        <!-- Экран успеха -->
        <div class="form-container" id="successScreen" style="display: none;">
            <div class="success-screen">
                <i class="fas fa-check-circle success-icon"></i>
                <h2 class="success-title">Объявление успешно опубликовано!</h2>
                <p>Ваше объявление было опубликовано в канале @FlowerMarketKG.</p>
                <p style="margin: 20px 0; color: #667eea; font-weight: 600;">
                    <a href="https://t.me/flowers_kg" target="_blank" style="color: #667eea; text-decoration: underline;">Посмотреть в канале</a>
                </p>
                <button class="btn" onclick="createNewAd()">
                    <i class="fas fa-plus"></i> Создать новое объявление
                </button>
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let formData = {
            photos: [],
            description: '',
            price: '',
            contact_type: 'telegram',
            contacts: '',
            location: { type: 'none', address: 'Не указано' }
        };
        
        let currentStep = 1;
        const totalSteps = 6;
        const MAX_PHOTOS = 10;
        const SERVER_URL = 'https://backend-flower-production.up.railway.app';
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateProgressBar();
            selectContactType('telegram');
            checkServerConnection();
        });
        
        // Проверка соединения с сервером
        async function checkServerConnection() {
            try {
                const response = await fetch(SERVER_URL + '/health', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    console.log('✅ Сервер доступен');
                    return true;
                }
            } catch (error) {
                console.warn('⚠️ Сервер недоступен:', error);
                showNotification('Внимание', 'Сервер может быть временно недоступен. Попробуйте позже.', 'warning');
            }
            return false;
        }
        
        // Настройка обработчиков
        function setupEventListeners() {
            document.getElementById('photoUpload').addEventListener('click', () => {
                document.getElementById('photoInput').click();
            });
            
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
            
            // Обновление данных при вводе
            document.getElementById('description').addEventListener('input', (e) => {
                formData.description = e.target.value;
            });
            
            document.getElementById('price').addEventListener('input', (e) => {
                formData.price = e.target.value;
            });
            
            document.getElementById('telegram').addEventListener('input', (e) => {
                if (formData.contact_type === 'telegram') {
                    formData.contacts = e.target.value;
                }
            });
            
            document.getElementById('phone').addEventListener('input', (e) => {
                if (formData.contact_type === 'phone') {
                    formData.contacts = e.target.value;
                }
            });
            
            document.getElementById('locationInput').addEventListener('input', (e) => {
                formData.location = {
                    type: 'address',
                    address: e.target.value
                };
            });
        }
        
        // Обработка загрузки фото
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            const currentCount = formData.photos.length;
            
            if (currentCount + files.length > MAX_PHOTOS) {
                showNotification('Ошибка', `Максимум ${MAX_PHOTOS} фото`);
                event.target.value = '';
                return;
            }
            
            files.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showNotification('Ошибка', 'Только изображения');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    formData.photos.push(e.target.result);
                    createPhotoPreview(e.target.result, formData.photos.length - 1);
                };
                reader.readAsDataURL(file);
            });
            
            event.target.value = '';
        }
        
        // Создание превью фото
        function createPhotoPreview(dataUrl, index) {
            const preview = document.getElementById('photoPreview');
            
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            
            const img = document.createElement('img');
            img.src = dataUrl;
            img.alt = `Фото ${index + 1}`;
            
            const removeBtn = document.createElement('div');
            removeBtn.className = 'remove-photo';
            removeBtn.innerHTML = '×';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                formData.photos.splice(index, 1);
                updatePhotoPreview();
            };
            
            photoItem.appendChild(img);
            photoItem.appendChild(removeBtn);
            preview.appendChild(photoItem);
        }
        
        // Обновление всех превью фото
        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            
            formData.photos.forEach((photo, index) => {
                createPhotoPreview(photo, index);
            });
        }
        
        // Навигация по шагам
        function showStep(step) {
            // Сохраняем данные текущего шага
            saveCurrentStepData();
            
            // Скрываем все шаги
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById(`step${i}`).classList.remove('active');
            }
            
            // Показываем нужный шаг
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
            
            // Обновляем прогресс бар
            updateProgressBar();
            
            // Если это превью, обновляем его
            if (step === 6) {
                updatePreview();
            }
            
            // Прокрутка наверх
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Сохранение данных текущего шага
        function saveCurrentStepData() {
            switch(currentStep) {
                case 2:
                    formData.description = document.getElementById('description').value.trim();
                    break;
                case 3:
                    formData.price = document.getElementById('price').value.trim();
                    break;
                case 4:
                    if (formData.contact_type === 'telegram') {
                        formData.contacts = document.getElementById('telegram').value.trim();
                    } else {
                        formData.contacts = document.getElementById('phone').value.trim();
                    }
                    break;
                case 5:
                    const locationInput = document.getElementById('locationInput').value.trim();
                    if (locationInput) {
                        formData.location = {
                            type: 'address',
                            address: locationInput
                        };
                    }
                    break;
            }
        }
        
        // Следующий шаг
        function nextStep() {
            if (!validateStep(currentStep)) {
                return;
            }
            
            if (currentStep < totalSteps) {
                showStep(currentStep + 1);
            }
        }
        
        // Предыдущий шаг
        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }
        
        // Валидация шага
        function validateStep(step) {
            switch(step) {
                case 1:
                    if (formData.photos.length === 0) {
                        showNotification('Ошибка', 'Загрузите хотя бы одно фото');
                        return false;
                    }
                    break;
                case 2:
                    const description = document.getElementById('description').value.trim();
                    if (!description) {
                        showNotification('Ошибка', 'Введите описание');
                        document.getElementById('description').focus();
                        return false;
                    }
                    if (description.length < 3) {
                        showNotification('Ошибка', 'Описание слишком короткое');
                        document.getElementById('description').focus();
                        return false;
                    }
                    break;
                case 3:
                    const price = document.getElementById('price').value.trim();
                    if (!price) {
                        showNotification('Ошибка', 'Введите цену');
                        document.getElementById('price').focus();
                        return false;
                    }
                    break;
                case 4:
                    if (formData.contact_type === 'telegram') {
                        const telegram = document.getElementById('telegram').value.trim();
                        if (!telegram) {
                            showNotification('Ошибка', 'Введите Telegram username');
                            document.getElementById('telegram').focus();
                            return false;
                        }
                    } else {
                        const phone = document.getElementById('phone').value.trim();
                        if (!phone) {
                            showNotification('Ошибка', 'Введите номер телефона');
                            document.getElementById('phone').focus();
                            return false;
                        }
                    }
                    break;
            }
            return true;
        }
        
        // Выбор типа контактов
        function selectContactType(type) {
            formData.contact_type = type;
            
            // Обновляем UI
            document.getElementById('telegramOption').classList.remove('active');
            document.getElementById('phoneOption').classList.remove('active');
            document.getElementById(`${type}Option`).classList.add('active');
            
            document.getElementById('telegramInputGroup').style.display = type === 'telegram' ? 'block' : 'none';
            document.getElementById('phoneInputGroup').style.display = type === 'phone' ? 'block' : 'none';
        }
        
        // Получение геолокации
        function getCurrentLocation() {
            const locationBtn = document.getElementById('locationBtn');
            const originalText = locationBtn.innerHTML;
            
            locationBtn.innerHTML = '<div class="loader"></div> Определение...';
            locationBtn.disabled = true;
            
            if (!navigator.geolocation) {
                showNotification('Ошибка', 'Геолокация не поддерживается');
                resetLocationButton(locationBtn, originalText);
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
                            {
                                headers: {
                                    'User-Agent': 'FlowerMarketBot/1.0',
                                    'Accept-Language': 'ru'
                                }
                            }
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.display_name) {
                                const address = data.display_name.split(',').slice(0, 3).join(', ');
                                document.getElementById('locationInput').value = address;
                                formData.location = {
                                    type: 'coordinates',
                                    address: address
                                };
                            }
                        }
                    } catch (error) {
                        console.error('Ошибка получения адреса:', error);
                        document.getElementById('locationInput').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        formData.location = {
                            type: 'coordinates',
                            address: `${lat.toFixed(6)}, ${lng.toFixed(6)}`
                        };
                    }
                    
                    locationBtn.innerHTML = '<i class="fas fa-check"></i> Определено';
                    showNotification('Успешно', 'Местоположение определено', 'success');
                    
                    setTimeout(() => {
                        resetLocationButton(locationBtn, originalText);
                    }, 2000);
                },
                (error) => {
                    let message = 'Не удалось определить местоположение';
                    if (error.code === error.PERMISSION_DENIED) {
                        message = 'Разрешите доступ к геолокации';
                    }
                    showNotification('Ошибка', message);
                    resetLocationButton(locationBtn, originalText);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000
                }
            );
        }
        
        // Сброс кнопки геолокации
        function resetLocationButton(button, originalText) {
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 1000);
        }
        
        // Обновление превью
        function updatePreview() {
            // Фото
            const previewPhotos = document.getElementById('previewPhotos');
            previewPhotos.innerHTML = '';
            
            formData.photos.slice(0, 3).forEach((photo, index) => {
                const img = document.createElement('img');
                img.src = photo;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '8px';
                img.style.margin = '5px';
                previewPhotos.appendChild(img);
            });
            
            if (formData.photos.length > 3) {
                const more = document.createElement('div');
                more.textContent = `+${formData.photos.length - 3} фото`;
                more.style.background = '#667eea';
                more.style.color = 'white';
                more.style.padding = '10px';
                more.style.borderRadius = '8px';
                more.style.margin = '5px';
                previewPhotos.appendChild(more);
            }
            
            // Описание
            document.getElementById('previewDescription').textContent = formData.description || 'Не указано';
            
            // Цена
            document.getElementById('previewPrice').textContent = formData.price || 'Не указана';
            
            // Контакты
            let contactsText = '';
            if (formData.contact_type === 'telegram') {
                contactsText = `Telegram: ${formData.contacts || 'Не указано'}`;
            } else {
                contactsText = `Телефон: ${formData.contacts || 'Не указано'}`;
            }
            document.getElementById('previewContacts').textContent = contactsText;
            
            // Локация
            document.getElementById('previewLocation').textContent = formData.location.address || 'Не указана';
        }
        
        // Обновление прогресс бара
        function updateProgressBar() {
            const stepNumbers = document.querySelectorAll('.step-number');
            const stepLabels = document.querySelectorAll('.step-label');
            
            stepNumbers.forEach((number, index) => {
                if (index + 1 === currentStep) {
                    number.classList.add('active');
                } else {
                    number.classList.remove('active');
                }
            });
            
            stepLabels.forEach((label, index) => {
                if (index + 1 <= currentStep) {
                    label.classList.add('active');
                } else {
                    label.classList.remove('active');
                }
            });
        }
        
        // Отправка формы
        async function submitForm() {
            if (!validateStep(currentStep)) {
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<div class="loader"></div> Публикация...';
            submitBtn.disabled = true;
            
            try {
                // Проверяем соединение с сервером
                const isConnected = await checkServerConnection();
                if (!isConnected) {
                    throw new Error('Нет соединения с сервером');
                }
                
                // Подготавливаем данные
                const finalData = {
                    photos: formData.photos,
                    description: formData.description.trim(),
                    price: formData.price.trim(),
                    contact_type: formData.contact_type,
                    contacts: formData.contacts.trim(),
                    location: formData.location,
                    timestamp: new Date().toISOString()
                };
                
                // Отправляем на сервер
                const response = await fetch(SERVER_URL + '/api/create-ad', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(finalData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Показываем экран успеха
                    showSuccessScreen(result.data.id);
                    
                    // Показываем уведомление
                    showNotification('Успешно!', `Объявление #${result.data.id} опубликовано`, 'success');
                } else {
                    throw new Error(result.error || 'Ошибка сервера');
                }
                
            } catch (error) {
                console.error('Ошибка отправки:', error);
                showNotification('Ошибка', error.message || 'Не удалось отправить объявление');
                
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // Показать экран успеха
        function showSuccessScreen(adId) {
            document.getElementById('formContainer').style.display = 'none';
            document.getElementById('successScreen').style.display = 'block';
            
            if (adId) {
                document.querySelector('.success-title').textContent = `Объявление #${adId} успешно опубликовано!`;
            }
        }
        
        // Создать новое объявление
        function createNewAd() {
            // Сброс данных
            formData = {
                photos: [],
                description: '',
                price: '',
                contact_type: 'telegram',
                contacts: '',
                location: { type: 'none', address: 'Не указано' }
            };
            
            // Сброс полей
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('description').value = '';
            document.getElementById('price').value = '';
            document.getElementById('telegram').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('locationInput').value = '';
            
            // Показать форму
            document.getElementById('successScreen').style.display = 'none';
            document.getElementById('formContainer').style.display = 'block';
            
            // Вернуться к первому шагу
            currentStep = 1;
            showStep(1);
            selectContactType('telegram');
        }
        
        // Показать уведомление
        function showNotification(title, message, type = 'error') {
            const notification = document.getElementById('notification');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            notification.className = 'notification';
            if (type === 'success') {
                notification.style.background = '#d4edda';
                notification.style.color = '#155724';
            } else if (type === 'warning') {
                notification.style.background = '#fff3cd';
                notification.style.color = '#856404';
            } else {
                notification.style.background = '#f8d7da';
                notification.style.color = '#721c24';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>