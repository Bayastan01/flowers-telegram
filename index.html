<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flower Market - –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (–≤—Å—Ç–∞–≤—å —Å–≤–æ–π –ø–æ–ª–Ω—ã–π CSS –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) */
        *{box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px;color:#333}
        .container{max-width:900px;margin:0 auto;background:#fff;border-radius:16px;padding:20px}
        .btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:12px 18px;border-radius:10px;border:none;cursor:pointer}
        .btn-secondary{background:#f0f0f0;color:#333}
        input,textarea,select{width:100%;padding:10px;margin-top:6px;margin-bottom:12px;border-radius:8px;border:1px solid #ddd}
        .photo-item img{width:100px;height:100px;object-fit:cover;border-radius:8px}
        .notification{padding:12px;border-radius:8px;margin-top:12px;display:none}
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-flower-tulip"></i> Flower Market ‚Äî –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h1>

        <div id="formRoot">
            <label>–§–æ—Ç–æ</label>
            <div id="photoPreview" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;"></div>
            <input id="photoInput" type="file" accept="image/*" multiple>

            <label>–¢–∏–ø —Ü–≤–µ—Ç–æ–≤</label>
            <input id="flowerType" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ä–æ–∑—ã, —Ç—é–ª—å–ø–∞–Ω—ã">

            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="description" placeholder="–û–ø–∏—à–∏—Ç–µ –±—É–∫–µ—Ç..."></textarea>

            <label>–¶–µ–Ω–∞</label>
            <input id="price" type="number" min="0" placeholder="1000">
            <select id="priceType">
                <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</option>
                <option value="negotiable">–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è</option>
                <option value="auction">–ê—É–∫—Ü–∏–æ–Ω</option>
            </select>

            <label>–ö–æ–Ω—Ç–∞–∫—Ç—ã</label>
            <input id="contacts" type="text" placeholder="@telegram –∏–ª–∏ –Ω–æ–º–µ—Ä">
            <select id="contactType">
                <option value="telegram">Telegram</option>
                <option value="phone">–¢–µ–ª–µ—Ñ–æ–Ω</option>
                <option value="whatsapp">WhatsApp</option>
            </select>

            <label>–õ–æ–∫–∞—Ü–∏—è</label>
            <input id="location" type="text" placeholder="–ì–æ—Ä–æ–¥ –∏–ª–∏ —Ä–∞–π–æ–Ω">

            <div style="margin-top:12px;">
                <button id="publishBtn" class="btn"><i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
            </div>

            <div id="notification" class="notification"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
    // ---------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ----------
    const MAX_PHOTOS = 10;
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

    // ---------- –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ----------
    let photos = [];
    const formData = {
        photos: [],
        flowerType: '',
        description: '',
        price: '',
        priceType: 'fixed',
        contacts: '',
        contact_type: 'telegram',
        location: { type: 'none', address: '' },
        newsletterConsent: false,
        userInfo: {}
    };

    // ---------- –£—Ç–∏–ª–∏—Ç—ã ----------
    function showNotification(title, message, type='info'){
        const n = document.getElementById('notification');
        n.style.display = 'block';
        n.style.background = type === 'success' ? '#e6ffed' : (type === 'error' ? '#ffe6e6' : '#eef');
        n.style.color = type === 'success' ? '#046' : (type === 'error' ? '#900' : '#055');
        n.innerHTML = `<strong>${title}</strong><div>${message}</div>`;
        setTimeout(()=> n.style.display = 'none', 6000);
    }

    // ---------- –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ ----------
    document.getElementById('photoInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (photos.length + files.length > MAX_PHOTOS) {
            showNotification('–û—à–∏–±–∫–∞', `–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ ${MAX_PHOTOS} —Ñ–æ—Ç–æ`, 'error');
            return;
        }
        files.forEach(file => {
            if (file.size > MAX_FILE_SIZE) {
                showNotification('–û—à–∏–±–∫–∞', `–§–∞–π–ª ${file.name} –±–æ–ª—å—à–µ ${MAX_FILE_SIZE/1024/1024}MB`, 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = (ev) => {
                const obj = { id: Date.now()+Math.random(), url: ev.target.result };
                photos.push(obj);
                formData.photos = photos.map(p=>p.url);
                updatePhotoPreview();
            };
            reader.readAsDataURL(file);
        });
        e.target.value = '';
    });

    function updatePhotoPreview(){
        const cont = document.getElementById('photoPreview');
        cont.innerHTML = '';
        photos.forEach(p => {
            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            wrapper.style.alignItems = 'center';
            wrapper.style.gap = '6px';
            const img = document.createElement('img');
            img.src = p.url;
            img.style.width = '100px';
            img.style.height = '100px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';
            const btn = document.createElement('button');
            btn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            btn.className = 'btn-secondary';
            btn.style.padding = '6px';
            btn.addEventListener('click', ()=> {
                photos = photos.filter(x => x.id !== p.id);
                formData.photos = photos.map(x => x.url);
                updatePhotoPreview();
            });
            wrapper.appendChild(img);
            wrapper.appendChild(btn);
            cont.appendChild(wrapper);
        });
    }

    // ---------- bind inputs ----------
    document.getElementById('flowerType').addEventListener('input', e=> formData.flowerType = e.target.value);
    document.getElementById('description').addEventListener('input', e=> formData.description = e.target.value);
    document.getElementById('price').addEventListener('input', e=> formData.price = e.target.value);
    document.getElementById('priceType').addEventListener('change', e=> formData.priceType = e.target.value);
    document.getElementById('contacts').addEventListener('input', e=> formData.contacts = e.target.value);
    document.getElementById('contactType').addEventListener('change', e=> formData.contact_type = e.target.value);
    document.getElementById('location').addEventListener('input', e=> formData.location = { type: 'address', address: e.target.value });

    // ---------- –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç (—á–µ—Ä–µ–∑ Telegram.WebApp.sendData) ----------
    async function sendViaTelegramWebApp(data){
        if (window.Telegram && Telegram.WebApp && typeof Telegram.WebApp.sendData === 'function') {
            try {
                console.log('Telegram.WebApp.sendData ->', data);
                Telegram.WebApp.sendData(JSON.stringify(data));
                showNotification('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', '–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —á–µ—Ä–µ–∑ Telegram', 'success');
                return true;
            } catch (err) {
                console.error('Telegram.WebApp.sendData error', err);
            }
        }
        // fallback
        return await sendViaFormSubmit(data);
    }

    async function sendViaFormSubmit(data){
        try {
            const resp = await fetch('https://formsubmit.co/ajax/bayastan01@gmail.com', {
                method: 'POST',
                headers: {'Content-Type': 'application/json','Accept':'application/json'},
                body: JSON.stringify({
                    _subject: 'üå∏ –ù–û–í–û–ï –û–ë–™–Ø–í–õ–ï–ù–ò–ï –û –¶–í–ï–¢–ê–•',
                    flowerType: data.flowerType,
                    description: data.description,
                    price: data.price,
                    contact: data.contacts,
                    contact_type: data.contact_type,
                    location: (data.location && data.location.address) ? data.location.address : '',
                    photosCount: data.photos ? data.photos.length : 0,
                    _template: 'table'
                })
            });
            const j = await resp.json();
            if (j.success || resp.ok) {
                showNotification('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', '–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ –∑–∞–ø–∞—Å–Ω–æ–π –∫–∞–Ω–∞–ª (FormSubmit)', 'success');
                return true;
            } else {
                console.error('FormSubmit error', j);
                showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ FormSubmit', 'error');
                return false;
            }
        } catch (err){
            console.error('FormSubmit exception', err);
            showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (—Å–µ—Ç—å)', 'error');
            return false;
        }
    }

    // ---------- –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" ----------
    document.getElementById('publishBtn').addEventListener('click', async () => {
        // –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if (!formData.photos || formData.photos.length === 0) { showNotification('–û—à–∏–±–∫–∞','–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ','error'); return; }
        if (!formData.flowerType || !formData.description) { showNotification('–û—à–∏–±–∫–∞','–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–∏–ø –∏ –æ–ø–∏—Å–∞–Ω–∏–µ','error'); return; }
        if ((!formData.price || formData.price === '') && formData.priceType !== 'negotiable') { showNotification('–û—à–∏–±–∫–∞','–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä–Ω—É—é','error'); return; }
        if (!formData.contacts) { showNotification('–û—à–∏–±–∫–∞','–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã','error'); return; }

        // –¥–æ–±–∞–≤–∏–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ Telegram WebApp –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏
        try {
            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                const ui = Telegram.WebApp.initDataUnsafe.user;
                formData.userInfo = { id: ui.id, username: ui.username, first_name: ui.first_name, last_name: ui.last_name };
            }
        } catch(e){ console.warn('No initDataUnsafe.user'); }

        // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
        const ok = await sendViaTelegramWebApp(formData);
        if (ok) {
            const btn = document.getElementById('publishBtn');
            btn.disabled = true;
            btn.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
            setTimeout(()=>{ btn.disabled = false; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É' }, 3000);
        } else {
            showNotification('–û—à–∏–±–∫–∞','–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.','error');
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    if (window.Telegram && Telegram.WebApp) {
        try { Telegram.WebApp.ready(); } catch(e){}
    }
    </script>
</body>
</html>
