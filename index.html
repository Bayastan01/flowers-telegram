<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flower Market - –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</title>
    <style>
        /* === –í–°–Å –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ï –°–¢–ò–õ–ï–í–û–ï –û–ü–ò–°–ê–ù–ò–ï === */
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { z-index: 10000;max-width: 800px; margin: 0 auto; padding-bottom: env(safe-area-inset-bottom, 20px); }
        .header { text-align: center; color: white; margin-bottom: 30px; padding-top: env(safe-area-inset-top, 0); }
        .header h1 { font-size: 24px; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .form-container { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .form-step { display: none; animation-duration: 0.3s; animation-fill-mode: both; }
        .form-step.active { display: block; animation-name: fadeInUp; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .step-title { font-size: 20px; color: #333; margin-bottom: 25px; text-align: center; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 10px; color: #555; font-weight: 500; font-size: 15px; }
        input, textarea, select { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; font-family: inherit; transition: all 0.3s ease; background: #fff; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        textarea { min-height: 140px; resize: vertical; line-height: 1.5; }
        .input-hint { display: block; margin-top: 8px; color: #888; font-size: 13px; }
        .photo-upload { border: 3px dashed #667eea; border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: rgba(102, 126, 234, 0.05); }
        .photo-upload:hover, .photo-upload:active { background: rgba(102, 126, 234, 0.1); }
        .photo-upload-icon { font-size: 48px; color: #667eea; margin-bottom: 15px; display: block; }
        #photoInput { display: none; }
        #photoPreview { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px; z-index:2; position:relative; }
        .photo-item { position: relative; width: 100px; height: 100px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
        .photo-item:hover { transform: scale(1.05); }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-photo { position: absolute; top: 6px; right: 6px; background: rgba(255, 59, 48, 0.9); color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.2s; border: 2px solid white; }
        .remove-photo:hover { background: rgba(255, 59, 48, 1); }
        .contact-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        @media (max-width: 480px) { .contact-options { grid-template-columns: 1fr; } }
        .contact-option { padding: 20px 15px; border: 2px solid #e0e0e0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #fff; }
        .contact-option:hover { border-color: #667eea; background: rgba(102, 126, 234, 0.05); }
        .contact-option.active { border-color: #667eea; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3); }
        .contact-option i { font-size: 28px; margin-bottom: 12px; display: block; }
        .contact-option p { font-size: 15px; font-weight: 500; margin-bottom: 5px; }
        .contact-option small { font-size: 12px; opacity: 0.8; }
        .location-map { width: 100%; height: 200px; border-radius: 12px; overflow: hidden; margin-bottom: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #667eea; border: 2px solid #e0e0e0; }
        .location-map i { font-size: 48px; margin-bottom: 10px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 30px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; position: relative; overflow: hidden; }
        .btn:after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%); opacity: 0; transition: opacity 0.3s; }
        .btn:hover:after, .btn:active:after { opacity: 1; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .btn:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn-secondary { background: #f0f0f0; color: #333; background-image: none; }
        .btn-secondary:hover { background: #e0e0e0; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .navigation { display: flex; gap: 15px; margin-top: 30px; }
        .navigation .btn { flex: 1; }
        .preview-item { background: rgba(102, 126, 234, 0.05); padding: 18px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #667eea; }
        .preview-label { font-weight: 600; color: #667eea; margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .preview-value { color: #333; font-size: 16px; line-height: 1.5; }
        .photos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .photo-preview { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .photo-more { display: flex; align-items: center; justify-content: center; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 20px; font-weight: bold; color: #667eea; }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .progress-bar:before { content: ''; position: absolute; top: 15px; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.3); z-index: 1; }
        .progress-step { position: relative; z-index: 2; text-align: center; flex: 1; }
        .step-number { width: 36px; height: 36px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; color: white; font-weight: 600; transition: all 0.3s; }
        .step-number.active { background: white; color: #667eea; box-shadow: 0 0 0 4px rgba(255,255,255,0.3); }
        .step-label { color: rgba(255,255,255,0.7); font-size: 12px; transition: color 0.3s; }
        .step-label.active { color: white; font-weight: 500; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; gap: 12px; transition: transform 0.4s ease; max-width: 90%; width: 400px; }
        .notification.show { transform: translateX(-50%) translateY(0); }
        .notification-icon { font-size: 22px; color: #ff3b30; }
        .notification.success .notification-icon { color: #34c759; }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 600; margin-bottom: 4px; color: #333; }
        .notification-message { color: #666; font-size: 14px; }
        .loader { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .success-screen { text-align: center; padding: 40px 20px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .success-icon { font-size: 80px; color: #34c759; margin-bottom: 25px; animation: bounce 1s ease infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .success-title { font-size: 28px; color: #333; margin-bottom: 15px; font-weight: 600; }
        .success-message { color: #666; line-height: 1.6; margin-bottom: 30px; font-size: 16px; }
        .success-steps { background: rgba(102, 126, 234, 0.05); border-radius: 12px; padding: 20px; margin: 30px 0; text-align: left; }
        .success-step { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .success-step:last-child { margin-bottom: 0; }
        .step-badge { background: #667eea; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; flex-shrink: 0; }
        .step-text { flex: 1; color: #555; }
        .telegram-info { background: linear-gradient(135deg, #0088cc 0%, #34aadc 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; display: none; }
        .telegram-info.show { display: block; animation: fadeIn 0.5s ease; }
        .telegram-info p { margin: 5px 0; }
        .telegram-info i { font-size: 24px; margin-bottom: 10px; display: block; }
        .close-telegram-btn { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; margin-top: 10px; display: inline-block; font-size: 14px; }
        .channel-link { display: inline-block; background: white; color: #0088cc; padding: 8px 16px; border-radius: 20px; text-decoration: none; margin-top: 10px; font-weight: bold; }
        .server-url { position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 8px; font-size: 12px; z-index: 999; font-family: monospace; }

        @media (max-width: 600px) {
            body { padding: 15px; }
            .form-container { padding: 20px; border-radius: 16px; }
            .step-title { font-size: 18px; }
            .photo-item { width: 80px; height: 80px; }
            .btn { padding: 14px 20px; font-size: 15px; }
            .server-url { display: none; }
        }
        @media (max-width: 380px) { .photos-grid { grid-template-columns: repeat(2, 1fr); } }

        /* Petal layer (–Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å) */
        #petalLayer { 
            pointer-events: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            z-index: 1; 
            overflow: hidden; 
        }
        .petal { 
            position: absolute; 
            top: -50px; 
            will-change: transform, opacity; 
            user-select: none;
            -webkit-user-select: none;
        }
        @keyframes petalFall {
            0% { 
                transform: translateY(0) rotate(0deg); 
                opacity: 0.8; 
            }
            10% { 
                opacity: 1; 
            }
            100% { 
                transform: translateY(110vh) rotate(720deg); 
                opacity: 0.2; 
            }
        }
        @keyframes petalFloat {
            0%, 100% { 
                transform: translateY(0) rotate(0deg); 
                opacity: 0.7; 
            }
            50% { 
                transform: translateY(-20px) rotate(180deg); 
                opacity: 1; 
            }
        }
    </style>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js?1"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <!-- —Å–ª–æ–π –ª–µ–ø–µ—Å—Ç–∫–æ–≤ -->
  <div id="petalLayer" aria-hidden="true"></div>

  <div class="container">
    <div class="progress-bar" id="progressBar">
        <div class="progress-step"><div class="step-number active">1</div><div class="step-label active">–§–æ—Ç–æ</div></div>
        <div class="progress-step"><div class="step-number">2</div><div class="step-label">–û–ø–∏—Å–∞–Ω–∏–µ</div></div>
        <div class="progress-step"><div class="step-number">3</div><div class="step-label">–¶–µ–Ω–∞</div></div>
        <div class="progress-step"><div class="step-number">4</div><div class="step-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div></div>
        <div class="progress-step"><div class="step-number">5</div><div class="step-label">–õ–æ–∫–∞—Ü–∏—è</div></div>
        <div class="progress-step"><div class="step-number">6</div><div class="step-label">–ü—Ä–µ–≤—å—é</div></div>
    </div>

    <div class="header">
        <h1><i class="fas fa-flower-tulip"></i> Flower Market</h1>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –∫—Ä–∞—Å–∏–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–∞–∂–µ —Ü–≤–µ—Ç–æ–≤</p>
    </div>
  </div>


  <div class="notification" id="notification">
      <i class="fas fa-exclamation-circle notification-icon"></i>
      <div class="notification-content">
          <div class="notification-title" id="notificationTitle">–û—à–∏–±–∫–∞</div>
          <div class="notification-message" id="notificationMessage"></div>
      </div>
  </div>

  <div class="container">
    <div class="form-container" id="formContainer">
      <!-- –®–∞–≥ 1 -->
      <div class="form-step active" id="step1">
          <h2 class="step-title"><i class="fas fa-camera"></i> –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</h2>
          <div class="form-group">
              <div class="photo-upload" id="photoUpload" role="button" aria-label="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ">
                  <i class="fas fa-cloud-upload-alt photo-upload-icon"></i>
                  <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</p>
                  <p class="input-hint">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ 10 —Ñ–æ—Ç–æ</p>
              </div>
              <input type="file" id="photoInput" accept="image/*" multiple>
              <div id="photoPreview"></div>
          </div>
          <div class="navigation"><button class="btn" onclick="nextStep()" id="nextBtn1">–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i></button></div>
      </div>

      <!-- –®–∞–≥ 2 -->
      <div class="form-step" id="step2">
          <h2 class="step-title"><i class="fas fa-edit"></i> –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h2>
          <div class="form-group">
              <label for="description">–û–ø–∏—à–∏—Ç–µ –≤–∞—à —Ç–æ–≤–∞—Ä:</label>
              <textarea id="description" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–≤–µ–∂–∏–µ —Ä–æ–∑—ã –∏–∑ –≠–∫–≤–∞–¥–æ—Ä–∞, –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Å–≤–∞–¥–µ–±–Ω—ã—Ö –±—É–∫–µ—Ç–æ–≤. –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É."></textarea>
              <p class="input-hint">–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞. –û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Ü–≤–µ—Ç—ã –ø–æ–¥—Ä–æ–±–Ω–æ</p>
          </div>
          <div class="navigation">
              <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
              <button class="btn" onclick="nextStep()" id="nextBtn2">–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i></button>
          </div>
      </div>

      <!-- –®–∞–≥ 3 -->
      <div class="form-step" id="step3">
          <h2 class="step-title"><i class="fas fa-tag"></i> –£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É</h2>
          <div class="form-group">
              <label for="price">–¶–µ–Ω–∞ –≤ —Å–æ–º–∞—Ö:</label>
              <input type="text" id="price" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1500 –∏–ª–∏ –î–æ–≥–æ–≤–æ—Ä–Ω–∞—è">
              <p class="input-hint">–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω: 1000-1500, –∏–ª–∏ "–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è"</p>
          </div>
          <div class="navigation">
              <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
              <button class="btn" onclick="nextStep()" id="nextBtn3">–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i></button>
          </div>
      </div>

      <!-- –®–∞–≥ 4 -->
      <div class="form-step" id="step4">
          <h2 class="step-title"><i class="fas fa-phone"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏</h2>
          <div class="contact-options">
              <div class="contact-option active" id="telegramOption" onclick="selectContactType('telegram')" role="button">
                  <i class="fab fa-telegram"></i>
                  <p>Telegram</p>
                  <small>–í–≤–µ—Å—Ç–∏ username</small>
              </div>
              <div class="contact-option" id="phoneOption" onclick="selectContactType('phone')" role="button">
                  <i class="fas fa-mobile-alt"></i>
                  <p>–¢–µ–ª–µ—Ñ–æ–Ω</p>
                  <small>–í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä</small>
              </div>
          </div>
          <div class="form-group" id="telegramInputGroup">
              <label for="telegram">–í–≤–µ–¥–∏—Ç–µ Telegram username:</label>
              <input type="text" id="telegram" placeholder="@username">
              <p class="input-hint">–ù–∞–ø—Ä–∏–º–µ—Ä: @username (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)</p>
          </div>
          <div class="form-group" id="phoneInputGroup" style="display: none;">
              <label for="phone">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
              <input type="tel" id="phone" placeholder="+996 XXX XXX XXX">
              <p class="input-hint">–§–æ—Ä–º–∞—Ç: +996XXXYYYZZZ (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)</p>
          </div>
          <div class="navigation">
              <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
              <button class="btn" onclick="nextStep()" id="nextBtn4">–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i></button>
          </div>
      </div>

      <!-- –®–∞–≥ 5 -->
      <div class="form-step" id="step5">
          <h2 class="step-title"><i class="fas fa-map-marker-alt"></i> –õ–æ–∫–∞—Ü–∏—è</h2>
          <div class="form-group">
              <div class="location-map" id="map"><i class="fas fa-map"></i><p style="margin-top: 10px; font-size: 14px;">–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</p></div>
              <label for="locationInput">–ê–¥—Ä–µ—Å –∏–ª–∏ —Ä–∞–π–æ–Ω:</label>
              <input type="text" id="locationInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≥. –ë–∏—à–∫–µ–∫, —É–ª. –ß—É–π, 123">
              <p class="input-hint" style="margin: 15px 0;">–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–∫—É—â—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é:</p>
              <button class="btn btn-secondary" onclick="getCurrentLocation()" id="locationBtn"><i class="fas fa-location-crosshairs"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
          </div>
          <div class="navigation">
              <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
              <button class="btn" onclick="nextStep()" id="nextBtn5">–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i></button>
          </div>
      </div>

      <!-- –®–∞–≥ 6 -->
      <div class="form-step" id="step6">
          <h2 class="step-title"><i class="fas fa-eye"></i> –ü—Ä–µ–≤—å—é –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>

          <div class="preview-item"><div class="preview-label">–§–æ—Ç–æ</div><div id="previewPhotos" class="photos-grid"></div></div>
          <div class="preview-item"><div class="preview-label">–û–ø–∏—Å–∞–Ω–∏–µ</div><div class="preview-value" id="previewDescription"></div></div>
          <div class="preview-item"><div class="preview-label">–¶–µ–Ω–∞</div><div class="preview-value" id="previewPrice"></div></div>
          <div class="preview-item"><div class="preview-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div><div class="preview-value" id="previewContacts"></div></div>
          <div class="preview-item"><div class="preview-label">–õ–æ–∫–∞—Ü–∏—è</div><div class="preview-value" id="previewLocation"></div></div>

          <div class="navigation">
              <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
              <button class="btn" onclick="submitForm()" id="submitBtn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å <i class="fas fa-paper-plane"></i></button>
          </div>
      </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ -->
    <div class="form-container" id="successScreen" style="display: none;">
        <div class="success-screen">
            <i class="fas fa-check-circle success-icon"></i>
            <h2 class="success-title">–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!</h2>
            <p class="success-message">–í–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –±—ã–ª–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ –∫–∞–Ω–∞–ª–µ @Flowers_kg.<br>–¢–µ–ø–µ—Ä—å –µ–≥–æ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤—Å–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏.</p>

            <div class="success-steps">
                <div class="success-step"><div class="step-badge">1</div><div class="step-text">–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ –∫–∞–Ω–∞–ª–µ</div></div>
                <div class="success-step"><div class="step-badge">2</div><div class="step-text">–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–≤—è–∑–∞—Ç—å—Å—è —Å –≤–∞–º–∏ –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</div></div>
                <div class="success-step"><div class="step-badge">3</div><div class="step-text">–û–±—ä—è–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ 7 –¥–Ω–µ–π</div></div>
            </div>

            <p style="margin-top: 20px; color: #667eea; font-weight: 600;">
                <i class="fas fa-info-circle"></i> –û–±—ä—è–≤–ª–µ–Ω–∏–µ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –∫–∞–Ω–∞–ª–µ:
                 <a href="https://t.me/flowers_kg" target="_blank" style="color: #667eea; text-decoration: underline;">@Flowers_kg</a>
            </p>

            <div id="telegramCloseSection" style="display: none; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeTelegramApp()" style="margin-top: 10px;">
                    <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                </button>

            </div>

            <button class="btn" onclick="createNewAd()" style="margin-top: 30px;">
                <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
            </button>
        </div>
    </div>
  </div>

  <div class="server-url" id="currentServerUrl"></div>

  <script>
    // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let formData = {
        photos: [],
        description: '',
        price: '',
        contact_type: 'telegram',
        contacts: '',
        location: { type: 'none', address: '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }
    };
    let currentStep = 1;
    const totalSteps = 6;
    const MAX_PHOTOS = 10;
    
    let tg = null;
    let isTelegram = false;
    let map = null;
    let marker = null;
    let initialTelegramUsername = '';
    
    // URL —Å–µ—Ä–≤–µ—Ä–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–û: —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä
    const SERVER_URL = "https://backend-flower-production.up.railway.app";
    document.getElementById('currentServerUrl').textContent = SERVER_URL.replace('https://', '');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram Web App –∏ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ username
    function checkTelegram() {
        if (window.Telegram && Telegram.WebApp) {
            try {
                tg = Telegram.WebApp;
                isTelegram = true;
                
                // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                if (tg.expand) tg.expand();
                
                // –í–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è
                if (tg.enableClosingConfirmation) tg.enableClosingConfirmation();
                
                // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ username –∏–∑ Telegram
                if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.username) {
                    const username = tg.initDataUnsafe.user.username;
                    initialTelegramUsername = username.startsWith('@') ? username : '@' + username;
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ Telegram
                    document.getElementById('telegram').value = initialTelegramUsername;
                    formData.contact_type = 'telegram';
                    formData.contacts = initialTelegramUsername;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
                    selectContactType('telegram');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤ Telegram
                document.getElementById('telegramCloseSection').style.display = 'block';
                
                return true;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ Telegram Web App:', e);
            }
        }
        return false;
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ Telegram –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function closeTelegramApp() {
        if (isTelegram && tg && tg.close) {
            try {
                tg.close();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ Telegram:', e);
            }
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    async function sendDataToServer(data) {
        try {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–π API
            const response = await fetch(`${SERVER_URL}/api/create-ad`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                const text = await response.text();
                throw new Error(text || `HTTP ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            throw error;
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ç–æ
    document.getElementById('photoUpload').addEventListener('click', () => {
        document.getElementById('photoInput').click();
    });
    
    document.getElementById('photoInput').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        
        if (formData.photos.length + files.length > MAX_PHOTOS) {
            alert(`–ú–∞–∫—Å–∏–º—É–º –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å ${MAX_PHOTOS} —Ñ–æ—Ç–æ`);
            e.target.value = '';
            return;
        }
        
        files.forEach(file => {
            if (!file.type.startsWith('image/')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                formData.photos.push(event.target.result);
                createPhotoPreview(event.target.result, formData.photos.length - 1);
                updatePhotoCounter();
            };
            reader.readAsDataURL(file);
        });
        
        e.target.value = '';
    });
    
    function createPhotoPreview(src, index) {
        const preview = document.getElementById('photoPreview');
        const div = document.createElement('div');
        div.className = 'photo-item';
        div.setAttribute('data-index', index);
        
        const img = document.createElement('img');
        img.src = src;
        img.alt = `–§–æ—Ç–æ ${index + 1}`;
        
        const removeBtn = document.createElement('div');
        removeBtn.className = 'remove-photo';
        removeBtn.innerText = '√ó';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            removePhoto(index);
        };
        
        div.appendChild(img);
        div.appendChild(removeBtn);
        preview.appendChild(div);
    }
    
    function removePhoto(index) {
        formData.photos.splice(index, 1);
        refreshPhotos();
        updatePhotoCounter();
    }
    
    function refreshPhotos() {
        const preview = document.getElementById('photoPreview');
        preview.innerHTML = '';
        formData.photos.forEach((photo, index) => {
            createPhotoPreview(photo, index);
        });
    }
    
    function updatePhotoCounter() {
        const upload = document.getElementById('photoUpload');
        const count = formData.photos.length;
        
        if (count > 0) {
            upload.innerHTML = `
                <i class="fas fa-check-circle photo-upload-icon" style="color: #34c759"></i>
                <p>–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}</p>
                <p class="input-hint">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë ${MAX_PHOTOS - count} —Ñ–æ—Ç–æ</p>
            `;
        } else {
            upload.innerHTML = `
                <i class="fas fa-cloud-upload-alt photo-upload-icon"></i>
                <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</p>
                <p class="input-hint">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ ${MAX_PHOTOS} —Ñ–æ—Ç–æ</p>
            `;
        }
    }
    
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —à–∞–≥–∞–º
    function showStep(step) {
        for (let i = 1; i <= totalSteps; i++) {
            document.getElementById(`step${i}`).classList.remove('active');
        }
        document.getElementById(`step${step}`).classList.add('active');
        currentStep = step;
        updateProgressBar();
        
        if (step === 6) {
            updatePreview();
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function nextStep() {
        if (!validateStep(currentStep)) {
            return;
        }
        
        saveCurrentStepData();
        
        if (currentStep < totalSteps) {
            showStep(currentStep + 1);
        }
    }
    
    function prevStep() {
        if (currentStep > 1) {
            showStep(currentStep - 1);
        }
    }
    
    function saveCurrentStepData() {
        if (currentStep === 2) {
            const description = document.getElementById('description');
            if (description) {
                formData.description = description.value.trim();
            }
        }
        
        if (currentStep === 3) {
            const price = document.getElementById('price');
            if (price) {
                formData.price = price.value.trim();
            }
        }
        
        if (currentStep === 4) {
            if (formData.contact_type === 'telegram') {
                const telegram = document.getElementById('telegram');
                if (telegram) {
                    let t = telegram.value.trim();
                    if (t && !t.startsWith('@')) {
                        t = '@' + t;
                    }
                    telegram.value = t;
                    formData.contacts = t;
                }
            } else {
                const phone = document.getElementById('phone');
                if (phone) {
                    formatPhoneInput();
                    formData.contacts = phone.value.trim();
                }
            }
        }
        
        if (currentStep === 5) {
            const locationInput = document.getElementById('locationInput');
            if (locationInput) {
                const value = locationInput.value.trim();
                if (value) {
                    formData.location = {
                        type: 'address',
                        address: value
                    };
                }
            }
        }
    }
    
    function validateStep(step) {
        if (step === 1) {
            if (formData.photos.length === 0) {
                alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ');
                return false;
            }
            return true;
        }
        
        if (step === 2) {
            const description = document.getElementById('description').value.trim();
            if (!description || description.length < 3) {
                alert('–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
                return false;
            }
            return true;
        }
        
        if (step === 3) {
            const price = document.getElementById('price').value.trim();
            if (!price) {
                alert('–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É');
                return false;
            }
            return true;
        }
        
        if (step === 4) {
            if (formData.contact_type === 'telegram') {
                const telegram = document.getElementById('telegram').value.trim();
                if (!telegram) {
                    alert('–í–≤–µ–¥–∏—Ç–µ Telegram username');
                    return false;
                }
            } else {
                const phone = document.getElementById('phone').value.trim();
                if (!phone || phone === '+996') {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                    return false;
                }
            }
            return true;
        }
        
        if (step === 5) {
            const location = document.getElementById('locationInput').value.trim();
            if (!location) {
                alert('–£–∫–∞–∂–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é');
                return false;
            }
            return true;
        }
        
        if (step === 6) {
            return true;
        }
        
        return true;
    }
    
    // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º Telegram
    function selectContactType(type) {
        formData.contact_type = type;
        
        document.getElementById('telegramOption').classList.toggle('active', type === 'telegram');
        document.getElementById('phoneOption').classList.toggle('active', type === 'phone');
        
        document.getElementById('telegramInputGroup').style.display = type === 'telegram' ? 'block' : 'none';
        document.getElementById('phoneInputGroup').style.display = type === 'phone' ? 'block' : 'none';
        
        if (type === 'telegram') {
            // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π username, –∑–∞–ø–æ–ª–Ω—è–µ–º –µ–≥–æ
            const telegramField = document.getElementById('telegram');
            if (!telegramField.value.trim() && initialTelegramUsername) {
                telegramField.value = initialTelegramUsername;
                formData.contacts = initialTelegramUsername;
            }
        } else {
            const phone = document.getElementById('phone');
            if (!phone.value.trim()) {
                phone.value = '+996';
                formData.contacts = '+996';
            }
        }
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function formatPhoneInput() {
        const phoneInput = document.getElementById('phone');
        let value = phoneInput.value.replace(/[^\d+]/g, '');
        
        if (!value.startsWith('+')) {
            value = '+' + value.replace(/^\++/, '');
        }
        
        if (!value.startsWith('+996')) {
            value = '+996' + value.replace(/^\+?996/, '').replace(/^\+?/, '');
        }
        
        const rest = value.slice(4).replace(/\D/g, '').slice(0, 9);
        phoneInput.value = '+996' + rest;
    }
    
    document.getElementById('phone').addEventListener('input', function() {
        formatPhoneInput();
        formData.contacts = this.value;
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
    function initMap() {
        try {
            if (typeof L === 'undefined') {
                setTimeout(initMap, 100);
                return;
            }
            
            map = L.map('map').setView([42.8746, 74.5698], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.on('click', function(e) {
                placeMarker(e.latlng.lat, e.latlng.lng);
                reverseGeocode(e.latlng.lat, e.latlng.lng);
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            map.locate({ 
                setView: true, 
                maxZoom: 15, 
                enableHighAccuracy: true,
                timeout: 10000 
            });
            
            // –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
            map.on('locationfound', function(e) {
                placeMarker(e.latlng.lat, e.latlng.lng);
                reverseGeocode(e.latlng.lat, e.latlng.lng);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
                const btn = document.getElementById('locationBtn');
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-check-circle"></i> –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-location-crosshairs"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                    }, 2000);
                }
            });
            
            map.on('locationerror', function(e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:', e.message);
                // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                showNotification('–í–Ω–∏–º–∞–Ω–∏–µ', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –≤—Ä—É—á–Ω—É—é.', 'info');
            });
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', e);
        }
    }
    
    function placeMarker(lat, lng) {
        if (!map) return;
        
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            
            marker.on('dragend', function(e) {
                const position = marker.getLatLng();
                reverseGeocode(position.lat, position.lng);
            });
        }
        
        map.setView([lat, lng], 15);
        
        formData.location = {
            type: 'coordinates',
            latitude: lat,
            longitude: lng,
            address: formData.location.address || ''
        };
    }
    
    async function reverseGeocode(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
            
            if (response.ok) {
                const data = await response.json();
                if (data.display_name) {
                    document.getElementById('locationInput').value = data.display_name;
                    formData.location.address = data.display_name;
                }
            }
        } catch (error) {
            document.getElementById('locationInput').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            formData.location.address = document.getElementById('locationInput').value;
        }
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    async function getCurrentLocation() {
        const btn = document.getElementById('locationBtn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<div class="loader"></div> –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...';
        btn.disabled = true;
        
        if (!navigator.geolocation) {
            alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            async function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                formData.location = {
                    type: 'coordinates',
                    latitude: lat,
                    longitude: lon,
                    address: ''
                };
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.display_name) {
                            document.getElementById('locationInput').value = data.display_name;
                            formData.location.address = data.display_name;
                            showNotification('–£—Å–ø–µ—à–Ω–æ', '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ', 'success');
                        }
                    }
                } catch (error) {
                    document.getElementById('locationInput').value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    formData.location.address = document.getElementById('locationInput').value;
                }
                
                if (map) {
                    placeMarker(lat, lon);
                }
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1200);
            },
            function(error) {
                let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ.';
                        break;
                }
                
                alert(errorMessage);
                btn.innerHTML = originalText;
                btn.disabled = false;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
    function updatePreview() {
        // –§–æ—Ç–æ
        const previewPhotos = document.getElementById('previewPhotos');
        previewPhotos.innerHTML = '';
        
        formData.photos.slice(0, 6).forEach(photo => {
            const img = document.createElement('img');
            img.className = 'photo-preview';
            img.src = photo;
            previewPhotos.appendChild(img);
        });
        
        if (formData.photos.length > 6) {
            const more = document.createElement('div');
            more.className = 'photo-preview photo-more';
            more.textContent = '+' + (formData.photos.length - 6);
            previewPhotos.appendChild(more);
        }
        
        // –û–ø–∏—Å–∞–Ω–∏–µ
        document.getElementById('previewDescription').textContent = formData.description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        
        // –¶–µ–Ω–∞
        document.getElementById('previewPrice').textContent = formData.price || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        
        // –ö–æ–Ω—Ç–∞–∫—Ç—ã
        const contactsPreview = document.getElementById('previewContacts');
        if (formData.contact_type === 'telegram') {
            const username = (formData.contacts || '').replace(/^@/, '');
            contactsPreview.innerHTML = username ? `<a href="https://t.me/${username}" target="_blank">@${username}</a>` : '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        } else {
            const phone = (formData.contacts || '').replace(/[^\d+]/g, '');
            contactsPreview.innerHTML = phone ? `<a href="https://wa.me/${phone}" target="_blank">WhatsApp</a> ‚Ä¢ <a href="tel:${phone}">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>` : '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        }
        
        // –õ–æ–∫–∞—Ü–∏—è
        const locationPreview = document.getElementById('previewLocation');
        if (formData.location.type === 'coordinates') {
            locationPreview.textContent = 'üìç ' + (formData.location.address || `${formData.location.latitude?.toFixed(6) || ''}, ${formData.location.longitude?.toFixed(6) || ''}`);
        } else {
            locationPreview.textContent = formData.location.address || 'üìç –ù–µ —É–∫–∞–∑–∞–Ω–∞';
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
    function saveAllData() {
        // –®–∞–≥ 2: –û–ø–∏—Å–∞–Ω–∏–µ
        const description = document.getElementById('description');
        if (description) {
            formData.description = description.value.trim();
        }
        
        // –®–∞–≥ 3: –¶–µ–Ω–∞
        const price = document.getElementById('price');
        if (price) {
            formData.price = price.value.trim();
        }
        
        // –®–∞–≥ 4: –ö–æ–Ω—Ç–∞–∫—Ç—ã
        if (formData.contact_type === 'telegram') {
            const telegram = document.getElementById('telegram');
            if (telegram) {
                let t = telegram.value.trim();
                if (t && !t.startsWith('@')) {
                    t = '@' + t;
                }
                telegram.value = t;
                formData.contacts = t;
            }
        } else {
            const phone = document.getElementById('phone');
            if (phone) {
                formatPhoneInput();
                formData.contacts = phone.value.trim();
            }
        }
        
        // –®–∞–≥ 5: –õ–æ–∫–∞—Ü–∏—è
        const locationInput = document.getElementById('locationInput');
        if (locationInput) {
            const value = locationInput.value.trim();
            if (value) {
                formData.location = {
                    type: 'address',
                    address: value
                };
            }
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    async function submitForm() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        saveAllData();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        if (formData.photos.length === 0) {
            alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ');
            showStep(1);
            return;
        }
        
        if (!formData.description || formData.description.length < 3) {
            alert('–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
            showStep(2);
            return;
        }
        
        if (!formData.price) {
            alert('–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É');
            showStep(3);
            return;
        }
        
        if (!formData.contacts) {
            alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏');
            showStep(4);
            return;
        }
        
        if (!formData.location.address || formData.location.address === '–ù–µ —É–∫–∞–∑–∞–Ω–æ') {
            alert('–£–∫–∞–∂–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é');
            showStep(5);
            return;
        }
        
        const finalData = {
            ...formData,
            timestamp: new Date().toISOString(),
            source: isTelegram ? 'telegram_web_app' : 'web_app'
        };
        
        try {
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').innerHTML = '<div class="loader"></div> –ü—É–±–ª–∏–∫–∞—Ü–∏—è...';
            
            const result = await sendDataToServer(finalData);
            
            if (result.success) {
                document.getElementById('formContainer').style.display = 'none';
                document.getElementById('successScreen').style.display = 'block';
                showNotification('–£—Å–ø–µ—à–Ω–æ', '–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!', 'success');
            } else {
                throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + (error.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º'));
        } finally {
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').innerHTML = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å <i class="fas fa-paper-plane"></i>';
        }
    }
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showNotification(title, message, type = 'info') {
        const notification = document.getElementById('notification');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        
        if (!notification || !notificationTitle || !notificationMessage) return;
        
        notificationTitle.textContent = title;
        notificationMessage.textContent = message;
        
        notification.className = 'notification';
        if (type === 'success') {
            notification.classList.add('success');
        }
        
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 4000);
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    function updateProgressBar() {
        const stepNumbers = document.querySelectorAll('.step-number');
        const stepLabels = document.querySelectorAll('.step-label');
        
        stepNumbers.forEach((step, index) => {
            step.classList.toggle('active', index + 1 === currentStep);
        });
        
        stepLabels.forEach((label, index) => {
            label.classList.toggle('active', index + 1 <= currentStep);
        });
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
    function createNewAd() {
        location.reload();
    }
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ª–µ–ø–µ—Å—Ç–∫–æ–≤ - –ò–°–ü–†–ê–í–õ–ï–ù–ê
    function initPetals() {
        const layer = document.getElementById('petalLayer');
        if (!layer) return;
        
        const petals = ['üå∏', 'üå∫', 'üåº', 'üåª', 'üíÆ', 'üèµÔ∏è', 'üå∑', 'üåπ', 'ü•Ä', 'üåæ'];
        
        function createPetal() {
            const petal = document.createElement('div');
            petal.className = 'petal';
            
            const size = 30 + Math.random() * 40;
            petal.style.fontSize = size + 'px';
            petal.style.left = Math.random() * 100 + '%';
            petal.style.opacity = 0.7 + Math.random() * 0.3;
            petal.textContent = petals[Math.floor(Math.random() * petals.length)];
            
            const duration = 8000 + Math.random() * 8000;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è –≤ –ø–∞–¥–µ–Ω–∏–∏
            const xMovement = (Math.random() - 0.5) * 100;
            petal.style.animation = `petalFall ${duration}ms linear forwards`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∞–Ω–∏–º–∞—Ü–∏–∏
            petal.style.animationDelay = Math.random() * 2000 + 'ms';
            
            layer.appendChild(petal);
            
            setTimeout(() => {
                if (petal.parentNode === layer) {
                    layer.removeChild(petal);
                }
            }, duration + 2000);
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–µ–ø–µ—Å—Ç–∫–æ–≤ —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        for (let i = 0; i < 10; i++) {
            setTimeout(() => createPetal(), i * 300);
        }
        
        // –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞–µ–º –ª–µ–ø–µ—Å—Ç–∫–∏ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                createPetal();
            }
        }, 800);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–∫–∂–µ –ø–ª–∞–≤–∞—é—â–∏–µ –ª–µ–ø–µ—Å—Ç–∫–∏ (–Ω–µ –ø–∞–¥–∞—é—â–∏–µ)
        function createFloatingPetal() {
            const petal = document.createElement('div');
            petal.className = 'petal';
            
            const size = 20 + Math.random() * 30;
            petal.style.fontSize = size + 'px';
            petal.style.left = Math.random() * 100 + '%';
            petal.style.top = Math.random() * 100 + 'vh';
            petal.style.opacity = 0.4 + Math.random() * 0.4;
            petal.textContent = petals[Math.floor(Math.random() * petals.length)];
            
            const duration = 10000 + Math.random() * 10000;
            petal.style.animation = `petalFloat ${duration}ms ease-in-out infinite`;
            
            layer.appendChild(petal);
            
            setTimeout(() => {
                if (petal.parentNode === layer) {
                    layer.removeChild(petal);
                }
            }, duration);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–ª–∞–≤–∞—é—â–∏—Ö –ª–µ–ø–µ—Å—Ç–∫–æ–≤
        for (let i = 0; i < 5; i++) {
            setTimeout(() => createFloatingPetal(), i * 1000);
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram Web App
        checkTelegram();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        updateProgressBar();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–æ—Ç–æ
        updatePhotoCounter();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è)
        setTimeout(initMap, 500);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–µ–ø–µ—Å—Ç–∫–∏
        initPetals();
        
        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
        const descriptionField = document.getElementById('description');
        if (descriptionField) {
            descriptionField.addEventListener('input', function() {
                formData.description = this.value.trim();
            });
        }
        
        const priceField = document.getElementById('price');
        if (priceField) {
            priceField.addEventListener('input', function() {
                formData.price = this.value.trim();
            });
        }
        
        const telegramField = document.getElementById('telegram');
        if (telegramField) {
            telegramField.addEventListener('input', function() {
                if (formData.contact_type === 'telegram') {
                    formData.contacts = this.value.trim();
                }
            });
        }
        
        const locationField = document.getElementById('locationInput');
        if (locationField) {
            locationField.addEventListener('input', function() {
                if (this.value.trim()) {
                    formData.location = {
                        type: 'address',
                        address: this.value.trim()
                    };
                }
            });
        }
    });
  </script>
</body>
</html>